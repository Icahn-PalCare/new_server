= V4 Outline MultiLine NoSorting TabWidth=30

H="First Heading"
/* 
********************HEADING******************** 

Project Name:

Date Started: July 14, 2019

Primary Investigator: CKA
Funding Source: none

Created by: CKA

Primary Analyst:
Secondary Analyst:

Datasets Used: NHATS

Simple Outline:


*/
 
//STATA
// Global Macros use $ symbol to be called. 

//Intermediate Data Path
global intpath "E:\nhats\data\Projects\..."

// Final Data Path
gloabl datapath "E:\nhats\data\Projects\..."

//Log files path
gloabl logpath "E:\nhats\data\Projects\..."


//SAS 


//Intermediate Data Path
//libname intpath "E:\nhats\data\Projects\..."

// Final Data Path
//libname datapath "E:\nhats\data\Projects\..."

//Log files path
//libname logpath "E:\nhats\data\Projects\..."


H="Generic template"
/*

Created by: 
Date Created:

Updated by:
Date Updated:

Description: What is going on in this section of the code? 
i.e. defining variables, labeling variables. Creating new quartiles for income based off of something....



**************************************************
*/
local date = subinstr("$S_DATE"," ","_",.) 
local name @INSERTNAME_`date'
di "`name'"

capture log close 
clear all

set more off
version 12
set linesize 80


cd `datapath'
log using `name'.smcl, text replace


.
.
.
.
.
.
.
.




log close
translate `name'.smcl `name'.pdf
exit



H="****RUN BELOW SECTIONS ONCE****"


H="making race var file"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
keep spid race_cat
by spid, sort: gen pid=_n
keep if pid==1
keep spid race_cat
rename spid bene_id
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\race var.dta"


H="making sex var"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
keep spid female
by spid, sort: gen pid=_n
keep if pid==1
keep spid female
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\female var.dta"

H="making other nhats vars"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
foreach var of varlist income_quart res_care education livealone metro_ind nhres medicaid sr_numconditions1 dem_3_cat adl_index adl_impair prob_dem {
tab `var' lml_ivw_yes, m
}

foreach var of varlist income_quart metro_ind education dem_3_cat prob_dem {
sort spid wave
by spid, sort: replace `var'=`var'[_n-1] if `var'==.
}
keep if lml_ivw_yes==1
keep spid income_quart education  metro_ind nhres  memory  adl_index adl_impair dem_3_cat prob_dem 

save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\other nhats vars.dta", replace


H="****RUN BELOW EVERY TIME****"


H="build data set step 1: nhats"
*step 1: this starts with raw nhats and makes an "nhats only" file to be merged with the medicare and other nhats data
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\raw_w1_w8.dta", clear


 
*** This is for wave 2 ***********************
gen family_friend_resp = . 
replace family_friend_resp =1 if is2prxyrelat >=1 & is2prxyrelat <=30
replace family_friend_resp =0 if is2prxyrelat == 31| is2prxyrelat==37| is2prxyrelat==39| is2prxyrelat==40
replace family_friend_resp = 1 if is2prxyrelat==33|is2prxyrelat==34|is2prxyrelat==35|is2prxyrelat==36
replace family_friend_resp = 1 if is2prxyrelat==91|is2prxyrelat==92
replace family_friend_resp = 0 if is2famrrutin ==3|is2famrrutin ==4
replace family_friend_resp = . if r2dlmlint !=1 
***********************

gen family_friend_resp3 = . 
replace family_friend_resp3 =1 if is3prxyrelat >=1 & is3prxyrelat <=30
replace family_friend_resp3 =0 if is3prxyrelat == 31| is3prxyrelat==37| is3prxyrelat==39| is3prxyrelat==40
replace family_friend_resp3 = 1 if is3prxyrelat==33|is3prxyrelat==34|is3prxyrelat==35|is3prxyrelat==36
replace family_friend_resp3 = 1 if is3prxyrelat==91|is3prxyrelat==92
replace family_friend_resp3 = 0 if is3famrrutin ==3|is3famrrutin ==4
replace family_friend_resp3 = . if r3dlmlint !=1 

gen family_friend_resp4 = . 
replace family_friend_resp4 =1 if is4prxyrelat >=1 & is4prxyrelat <=30
replace family_friend_resp4 =0 if is4prxyrelat == 31| is4prxyrelat==37| is4prxyrelat==39| is4prxyrelat==40
replace family_friend_resp4 = 1 if is4prxyrelat==33|is4prxyrelat==34|is4prxyrelat==35|is4prxyrelat==36
replace family_friend_resp4 = 1 if is4prxyrelat==91|is4prxyrelat==92
replace family_friend_resp4 = 0 if is4famrrutin ==3|is4famrrutin ==4
replace family_friend_resp4 = . if r4dlmlint !=1 

gen family_friend_resp5 = . 
replace family_friend_resp5 =1 if is5prxyrelat >=1 & is5prxyrelat <=30
replace family_friend_resp5 =0 if is5prxyrelat == 31| is5prxyrelat==37| is5prxyrelat==39| is5prxyrelat==40
replace family_friend_resp5 = 1 if is5prxyrelat==33|is5prxyrelat==34|is5prxyrelat==35|is5prxyrelat==36
replace family_friend_resp5 = 1 if is5prxyrelat==91|is5prxyrelat==92
replace family_friend_resp5 = 0 if is5famrrutin ==3|is5famrrutin ==4
replace family_friend_resp5 = . if r5dlmlint !=1 

gen family_friend_resp6 = . 
replace family_friend_resp6 =1 if is6prxyrelat >=1 & is6prxyrelat <=30
replace family_friend_resp6 =0 if is6prxyrelat == 31| is6prxyrelat==37| is6prxyrelat==39| is6prxyrelat==40
replace family_friend_resp6 = 1 if is6prxyrelat==33|is6prxyrelat==34|is6prxyrelat==35|is6prxyrelat==36
replace family_friend_resp6 = 1 if is6prxyrelat==91|is6prxyrelat==92
replace family_friend_resp6 = 0 if is6famrrutin ==3|is6famrrutin ==4
replace family_friend_resp6 = . if r6dlmlint !=1 

gen family_friend_resp7 = . 
replace family_friend_resp7 =1 if is7prxyrelat >=1 & is7prxyrelat <=30
replace family_friend_resp7 =0 if is7prxyrelat == 31| is7prxyrelat==37| is7prxyrelat==39| is7prxyrelat==40
replace family_friend_resp7 = 1 if is7prxyrelat==33|is7prxyrelat==34|is7prxyrelat==35|is7prxyrelat==37
replace family_friend_resp7 = 1 if is7prxyrelat==91|is7prxyrelat==92
replace family_friend_resp7 = 0 if is7famrrutin ==3|is7famrrutin ==4
replace family_friend_resp7 = . if r7dlmlint !=1

gen family_friend_resp8 = . 
replace family_friend_resp8 =1 if is8prxyrelat >=1 & is8prxyrelat <=30
replace family_friend_resp8 =0 if is8prxyrelat == 31| is8prxyrelat==38| is8prxyrelat==39| is8prxyrelat==40
replace family_friend_resp8 = 1 if is8prxyrelat==33|is8prxyrelat==34|is8prxyrelat==35|is8prxyrelat==38
replace family_friend_resp8 = 1 if is8prxyrelat==91|is8prxyrelat==92
replace family_friend_resp8 = 0 if is8famrrutin ==3|is8famrrutin ==4
replace family_friend_resp8 = . if r8dlmlint !=1



 gen wave_nhat=0
 replace wave_nhat = 2 if r2dresid==6 
 replace wave_nhat = 3 if r3dresid==6 
 replace wave_nhat = 4 if r4dresid==6 
 replace wave_nhat = 5 if r5dresid==6
 replace wave_nhat = 6 if r6dresid==6
 replace wave_nhat = 7 if r7dresid==6
 replace wave_nhat = 8 if r8dresid==6

 
 *** NOTE this programming in error - problem with merge with Rl1dracehisp ******
** Note they are sampling with replacement for file has 12,427 with decedents all having Race 
/*
gen black = 0 if rl1dracehisp != . 
replace black = 1 if rl1dracehisp ==2 */
********************************************** see fix with race variable ********


gen site_of_death2 = . 
replace site_of_death2 = 1 if pd2placedied ==1
replace site_of_death2 = 2 if pd2placedied ==2
replace site_of_death2 = 3 if pd2placedied ==3
replace site_of_death2 = 4 if pd2placedied ==4
replace site_of_death2 = 5 if pd2placedied ==5
replace site_of_death2 = 5 if pd2placedied ==91

gen site_of_death3 = . 
replace site_of_death3 = 1 if pd3placedied ==1
replace site_of_death3 = 2 if pd3placedied ==2
replace site_of_death3 = 3 if pd3placedied ==3
replace site_of_death3 = 4 if pd3placedied ==4
replace site_of_death3 = 5 if pd3placedied ==5
replace site_of_death3 = 5 if pd3placedied ==91


gen site_of_death4 = . 
replace site_of_death4 = 1 if pd4placedied ==1
replace site_of_death4 = 2 if pd4placedied ==2
replace site_of_death4 = 3 if pd4placedied ==3
replace site_of_death4 = 4 if pd4placedied ==4
replace site_of_death4 = 5 if pd4placedied ==5
replace site_of_death4 = 5 if pd4placedied ==91

gen site_of_death5 = . 
replace site_of_death5 = 1 if pd5placedied ==1
replace site_of_death5 = 2 if pd5placedied ==2
replace site_of_death5 = 3 if pd5placedied ==3
replace site_of_death5 = 4 if pd5placedied ==4
replace site_of_death5 = 5 if pd5placedied ==5
replace site_of_death5 = 5 if pd5placedied ==91

gen site_of_death6 = . 
replace site_of_death6 = 1 if pd6placedied ==1
replace site_of_death6 = 2 if pd6placedied ==2
replace site_of_death6 = 3 if pd6placedied ==3
replace site_of_death6 = 4 if pd6placedied ==4
replace site_of_death6 = 5 if pd6placedied ==5
replace site_of_death6 = 5 if pd6placedied ==91

gen site_of_death7 = . 
replace site_of_death7 = 1 if pd7placedied ==1
replace site_of_death7 = 2 if pd7placedied ==2
replace site_of_death7 = 3 if pd7placedied ==3
replace site_of_death7 = 4 if pd7placedied ==4
replace site_of_death7 = 5 if pd7placedied ==5
replace site_of_death7 = 5 if pd7placedied ==91

gen site_of_death8 = . 
replace site_of_death8 = 1 if pd8placedied ==1
replace site_of_death8 = 2 if pd8placedied ==2
replace site_of_death8 = 3 if pd8placedied ==3
replace site_of_death8 = 4 if pd8placedied ==4
replace site_of_death8 = 5 if pd8placedied ==5
replace site_of_death8 = 5 if pd8placedied ==91


label define sod2 5 "other" 4 "hospice ipu" 3 "nh" 2 "hospital" 1 "home" 
label values site_of_death3 sod2 
label values site_of_death2 sod2 
label values site_of_death4 sod2
label values site_of_death5 sod2
label values site_of_death6 sod2
label values site_of_death7 sod2
label values site_of_death8 sod2


**Generate site_of_death_w2w3w4w5w76 variable
**1=died at home, 2=died in hospital other unit/ED/don't know, 3=ICU, 4=palliative care unit
**5=inpatient hospice unit, 6=NH, 7=hospice residence, 8=in transit, 9=other

gen site_of_death_w2w8 = . 
replace site_of_death_w2w8 = 1 if pd2placedied ==1
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==5
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==4
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==-8
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==1
replace site_of_death_w2w8 = 3 if pd2placedied ==2 & pd2hospdied ==1
replace site_of_death_w2w8 = 4 if pd2placedied ==2 & pd2hospdied ==2
replace site_of_death_w2w8 = 5 if pd2placedied ==2 & pd2hospdied ==3
replace site_of_death_w2w8 = 6 if pd2placedied ==3
replace site_of_death_w2w8 = 7 if pd2placedied ==4
replace site_of_death_w2w8 = 8 if pd2placedied ==5
replace site_of_death_w2w8 = 9 if pd2placedied ==91

replace site_of_death_w2w8 = 1 if pd3placedied ==1
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==5
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==4
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd2hospdied ==-8
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==1
replace site_of_death_w2w8 = 3 if pd3placedied ==2 & pd3hospdied ==1
replace site_of_death_w2w8 = 4 if pd3placedied ==2 & pd3hospdied ==2
replace site_of_death_w2w8 = 5 if pd3placedied ==2 & pd3hospdied ==3
replace site_of_death_w2w8 = 6 if pd3placedied ==3
replace site_of_death_w2w8 = 7 if pd3placedied ==4
replace site_of_death_w2w8 = 8 if pd3placedied ==5
replace site_of_death_w2w8 = 9 if pd3placedied ==91

replace site_of_death_w2w8 = 1 if pd4placedied ==1
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==5
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==4
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==-8
replace site_of_death_w2w8 = 3 if pd4placedied ==2 & pd4hospdied ==1
replace site_of_death_w2w8 = 4 if pd4placedied ==2 & pd4hospdied ==2
replace site_of_death_w2w8 = 5 if pd4placedied ==2 & pd4hospdied ==3
replace site_of_death_w2w8 = 6 if pd4placedied ==3
replace site_of_death_w2w8 = 7 if pd4placedied ==4
replace site_of_death_w2w8 = 8 if pd4placedied ==5
replace site_of_death_w2w8 = 9 if pd4placedied ==91

replace site_of_death_w2w8 = 1 if pd5placedied ==1
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==5
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==4
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==-8
replace site_of_death_w2w8 = 3 if pd5placedied ==2 & pd5hospdied ==1
replace site_of_death_w2w8 = 4 if pd5placedied ==2 & pd5hospdied ==2
replace site_of_death_w2w8 = 5 if pd5placedied ==2 & pd5hospdied ==3
replace site_of_death_w2w8 = 6 if pd5placedied ==3
replace site_of_death_w2w8 = 7 if pd5placedied ==4
replace site_of_death_w2w8 = 8 if pd5placedied ==5
replace site_of_death_w2w8 = 9 if pd5placedied ==91

replace site_of_death_w2w8 = 1 if pd6placedied ==1
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==5
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==4
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==-8
replace site_of_death_w2w8 = 3 if pd6placedied ==2 & pd6hospdied ==1
replace site_of_death_w2w8 = 4 if pd6placedied ==2 & pd6hospdied ==2
replace site_of_death_w2w8 = 5 if pd6placedied ==2 & pd6hospdied ==3
replace site_of_death_w2w8 = 6 if pd6placedied ==3
replace site_of_death_w2w8 = 7 if pd6placedied ==4
replace site_of_death_w2w8 = 8 if pd6placedied ==5
replace site_of_death_w2w8 = 9 if pd6placedied ==91

replace site_of_death_w2w8 = 1 if pd7placedied ==1
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==5
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==4
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==-8
replace site_of_death_w2w8 = 3 if pd7placedied ==2 & pd7hospdied ==1
replace site_of_death_w2w8 = 4 if pd7placedied ==2 & pd7hospdied ==2
replace site_of_death_w2w8 = 5 if pd7placedied ==2 & pd7hospdied ==3
replace site_of_death_w2w8 = 6 if pd7placedied ==3
replace site_of_death_w2w8 = 7 if pd7placedied ==4
replace site_of_death_w2w8 = 8 if pd7placedied ==5
replace site_of_death_w2w8 = 9 if pd7placedied ==91

replace site_of_death_w2w8 = 1 if pd8placedied ==1
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==5
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==4
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==-8
replace site_of_death_w2w8 = 3 if pd8placedied ==2 & pd8hospdied ==1
replace site_of_death_w2w8 = 4 if pd8placedied ==2 & pd8hospdied ==2
replace site_of_death_w2w8 = 5 if pd8placedied ==2 & pd8hospdied ==3
replace site_of_death_w2w8 = 6 if pd8placedied ==3
replace site_of_death_w2w8 = 7 if pd8placedied ==4
replace site_of_death_w2w8 = 8 if pd8placedied ==5
replace site_of_death_w2w8 = 9 if pd8placedied ==91


**Genrate variable of place living prior to death, 1=at SPs home, 2=hospital, 3=NH, 91=other

gen site_pre_death = 0 if r2dresid ==6| r3dresid ==6| r4dresid ==6|r5dresid==6 |r6dresid==6 |r7dresid==6 |r8dresid==6
replace site_pre_death = pd2placepre if r2dresid==6
replace site_pre_death = pd3placepre if r3dresid==6
replace site_pre_death = pd4placepre if r4dresid==6
replace site_pre_death = pd5placepre if r5dresid==6
replace site_pre_death = pd6placepre if r6dresid==6
replace site_pre_death = pd7placepre if r7dresid==6
replace site_pre_death = pd8placepre if r8dresid==6

					   
*************** run this once there is a merge *************


label define sodw2w6 9 "other" 8 "in transit" 7 "hospice residence" 6  " nursing home" 5 "hospice IPU" 4 "palliative care unit in hospital" 3 "ICU" 2 "hospital" 1 "home" 
label values site_of_death_w2w8 sodw2w6

  
  /*** modification of Vicki to account for the problem with weights 
  
           ***************************************************
           
           1. Restrict both samples to persons residing in the community prior to terminal events 
           2. get all the names of weights. strata, and sampling unit
           3. Create a common set of variables 
  

           
*** Programing to create the NHATs data set */




gen had_pain3 = lm3pain
gen had_pain2 = lm2pain
gen had_pain4 = lm4pain
gen had_pain5 = lm5pain
gen had_pain6 = lm6pain
gen had_pain7 = lm7pain
gen had_pain8 = lm8pain

*pain

gen unmet_pain2 = . 
replace unmet_pain2 = 1 if lm2painhlp==2 
replace unmet_pain2 =1 if lm2painhlpam ==1
replace unmet_pain2 =1 if lm2painhlpam ==2
replace unmet_pain2 =0 if lm2painhlpam ==3 

gen unmet_pain3 = . 
replace unmet_pain3 = 1 if lm3painhlp==2 
replace unmet_pain3 =1 if lm3painhlpam ==1
replace unmet_pain3 =1 if lm3painhlpam ==2
replace unmet_pain3 =0 if lm3painhlpam ==3 

gen unmet_pain4 = . 
replace unmet_pain4 = 1 if lm4painhlp==2 
replace unmet_pain4 =1 if lm4painhlpam ==1
replace unmet_pain4 =1 if lm4painhlpam ==2
replace unmet_pain4 =0 if lm4painhlpam ==3 

gen unmet_pain5 = . 
replace unmet_pain5 = 1 if lm5painhlp==2 
replace unmet_pain5 =1 if lm5painhlpam ==1
replace unmet_pain5 =1 if lm5painhlpam ==2
replace unmet_pain5 =0 if lm5painhlpam ==3 

gen unmet_pain6 = . 
replace unmet_pain6 =1 if lm6painhlp==2 
replace unmet_pain6 =1 if lm6painhlpam ==1
replace unmet_pain6 =1 if lm6painhlpam ==2
replace unmet_pain6 =0 if lm6painhlpam ==3 

gen unmet_pain7 = . 
replace unmet_pain7 =1 if lm7painhlp==2 
replace unmet_pain7 =1 if lm7painhlpam ==1
replace unmet_pain7 =1 if lm7painhlpam ==2
replace unmet_pain7 =0 if lm7painhlpam ==3 

gen unmet_pain8 = . 
replace unmet_pain8 =1 if lm8painhlp==2 
replace unmet_pain8 =1 if lm8painhlpam ==1
replace unmet_pain8 =1 if lm8painhlpam ==2
replace unmet_pain8 =0 if lm8painhlpam ==3 

*breathlessness
gen had_bre2 = lm2bre 
gen unmet_bre2 = . 
replace unmet_bre2 = 1 if lm2brehlp==2 
replace unmet_bre2 =1 if lm2brehlpam ==1
replace unmet_bre2 =1 if lm2brehlpam ==2
replace unmet_bre2 =0 if lm2brehlpam ==3

gen had_bre3 = lm3bre 
gen unmet_bre3 = . 
replace unmet_bre3 = 1 if lm3brehlp==2 
replace unmet_bre3 =1 if lm3brehlpam ==1
replace unmet_bre3 =1 if lm3brehlpam ==2
replace unmet_bre3 =0 if lm3brehlpam ==3

gen had_bre4 = lm4bre 
gen unmet_bre4 = . 
replace unmet_bre4 = 1 if lm4brehlp==2 
replace unmet_bre4 =1 if lm4brehlpam ==1
replace unmet_bre4 =1 if lm4brehlpam ==2
replace unmet_bre4 =0 if lm4brehlpam ==3

gen had_bre5 = lm5bre 
gen unmet_bre5 = . 
replace unmet_bre5 = 1 if lm5brehlp==2 
replace unmet_bre5 =1 if lm5brehlpam ==1
replace unmet_bre5 =1 if lm5brehlpam ==2
replace unmet_bre5 =0 if lm5brehlpam ==3

gen had_bre6 = lm6bre 
gen unmet_bre6 = . 
replace unmet_bre6 =1 if lm6brehlp==2 
replace unmet_bre6 =1 if lm6brehlpam ==1
replace unmet_bre6 =1 if lm6brehlpam ==2
replace unmet_bre6 =0 if lm6brehlpam ==3

gen had_bre7 = lm7bre 
gen unmet_bre7 = . 
replace unmet_bre7 =1 if lm7brehlp==2 
replace unmet_bre7 =1 if lm7brehlpam ==1
replace unmet_bre7 =1 if lm7brehlpam ==2
replace unmet_bre7 =0 if lm7brehlpam ==3

gen had_bre8 = lm8bre 
gen unmet_bre8 = . 
replace unmet_bre8 =1 if lm8brehlp==2 
replace unmet_bre8 =1 if lm8brehlpam ==1
replace unmet_bre8 =1 if lm8brehlpam ==2
replace unmet_bre8 =0 if lm8brehlpam ==3

*sad or anxious

gen had_sad2 = lm2sad 
gen unmet_sad2 = . 
replace unmet_sad2 = 1 if lm2sadhlp==2 
replace unmet_sad2 =1 if lm2sadhlpam ==1
replace unmet_sad2 =1 if lm2sadhlpam ==2
replace unmet_sad2 =0 if lm2sadhlpam ==3

gen had_sad3 = lm3sad 
gen unmet_sad3 = . 
replace unmet_sad3 = 1 if lm3sadhlp==2 
replace unmet_sad3 =1 if lm3sadhlpam ==1
replace unmet_sad3 =1 if lm3sadhlpam ==2
replace unmet_sad3 =0 if lm3sadhlpam ==3

gen had_sad4 = lm4sad 
gen unmet_sad4 = . 
replace unmet_sad4 = 1 if lm4sadhlp==2 
replace unmet_sad4 =1 if lm4sadhlpam ==1
replace unmet_sad4 =1 if lm4sadhlpam ==2
replace unmet_sad4 =0 if lm4sadhlpam ==3

gen had_sad5 = lm5sad 
gen unmet_sad5 = . 
replace unmet_sad5 = 1 if lm5sadhlp==2 
replace unmet_sad5 =1 if lm5sadhlpam ==1
replace unmet_sad5 =1 if lm5sadhlpam ==2
replace unmet_sad5 =0 if lm5sadhlpam ==3

gen had_sad6 = lm6sad 
gen unmet_sad6 = . 
replace unmet_sad6 =1 if lm6sadhlp==2 
replace unmet_sad6 =1 if lm6sadhlpam ==1
replace unmet_sad6 =1 if lm6sadhlpam ==2
replace unmet_sad6 =0 if lm6sadhlpam ==3

gen had_sad7 = lm7sad 
gen unmet_sad7 = . 
replace unmet_sad7 =1 if lm7sadhlp==2 
replace unmet_sad7 =1 if lm7sadhlpam ==1
replace unmet_sad7 =1 if lm7sadhlpam ==2
replace unmet_sad7 =0 if lm7sadhlpam ==3

gen had_sad8 = lm8sad 
gen unmet_sad8 = . 
replace unmet_sad8 =1 if lm8sadhlp==2 
replace unmet_sad8 =1 if lm8sadhlpam ==1
replace unmet_sad8 =1 if lm8sadhlpam ==2
replace unmet_sad8 =0 if lm8sadhlpam ==3

*care decisions/respect/etc
gen care_decision2 = lm2caredecis
gen care_decision3 = lm3caredecis
gen care_decision4 = lm4caredecis
gen care_decision5 = lm5caredecis
gen care_decision6 = lm6caredecis
gen care_decision7 = lm7caredecis
gen care_decision8 = lm8caredecis


gen care_notwant2 = lm2carenowan 
gen care_notwant3 = lm3carenowan 
gen care_notwant4 = lm4carenowan 
gen care_notwant5 = lm5carenowan 
gen care_notwant6 = lm6carenowan
gen care_notwant7 = lm7carenowan
gen care_notwant8 = lm8carenowan


gen always_respect2 = lm2respect 
gen always_respect3 = lm3respect 
gen always_respect4 = lm4respect 
gen always_respect5 = lm5respect 
gen always_respect6 = lm6respect
gen always_respect7 = lm7respect
gen always_respect8 = lm8respect


gen informed2 = lm2informed 
gen informed3 = lm3informed 
gen informed4 = lm4informed 
gen informed5 = lm5informed 
gen informed6 = lm6informed
gen informed7 = lm7informed
gen informed8 = lm8informed


gen more_than_one_md2 = lm2doctor
gen more_than_one_md3 = lm3doctor
gen more_than_one_md4 = lm4doctor
gen more_than_one_md5 = lm5doctor
gen more_than_one_md6 = lm6doctor
gen more_than_one_md7 = lm7doctor
gen more_than_one_md8 = lm8doctor


gen md_in_charge2 = lm2docclear 
gen md_in_charge3 = lm3docclear 
gen md_in_charge4 = lm4docclear 
gen md_in_charge5 = lm5docclear 
gen md_in_charge6 = lm6docclear
gen md_in_charge7 = lm7docclear
gen md_in_charge8 = lm8docclear


gen overall_rate2 = lm2ratecare 
gen overall_rate3 = lm3ratecare 
gen overall_rate4 = lm4ratecare 
gen overall_rate5 = lm5ratecare 
gen overall_rate6 = lm6ratecare
gen overall_rate7 = lm7ratecare
gen overall_rate8 = lm8ratecare

*religious needs
gen unmet_relig2 = . 
replace unmet_relig2 = 1 if lm2relg == 2 
replace unmet_relig2 = 1 if lm2relgamt == 2 
replace unmet_relig2 = 0 if lm2relgamt==1 

gen unmet_relig3 = . 
replace unmet_relig3 = 1 if lm3relg == 2 
replace unmet_relig3 = 1 if lm3relgamt == 2 
replace unmet_relig3 = 0 if lm3relgamt==1 

gen unmet_relig4 = . 
replace unmet_relig4 = 1 if lm4relg == 2 
replace unmet_relig4 = 1 if lm4relgamt == 2 
replace unmet_relig4 = 0 if lm4relgamt==1 

gen unmet_relig5 = . 
replace unmet_relig5 = 1 if lm5relg == 2 
replace unmet_relig5 = 1 if lm5relgamt == 2 
replace unmet_relig5 = 0 if lm5relgamt==1 

gen unmet_relig6 = . 
replace unmet_relig6 = 1 if lm6relg == 2 
replace unmet_relig6 = 1 if lm6relgamt == 2 
replace unmet_relig6 = 0 if lm6relgamt==1 

gen unmet_relig7 = . 
replace unmet_relig7 = 1 if lm7relg == 2 
replace unmet_relig7 = 1 if lm7relgamt == 2 
replace unmet_relig7 = 0 if lm7relgamt==1 

gen unmet_relig8 = . 
replace unmet_relig8 = 1 if lm8relg == 2 
replace unmet_relig8 = 1 if lm8relgamt == 2 
replace unmet_relig8 = 0 if lm8relgamt==1 

gen sunit2= w2varunit
gen sunit3= w3varunit
gen sunit4= w4varunit
gen sunit5= w5varunit
gen sunit6= w6varunit
gen sunit7= w7varunit
gen sunit8= w8varunit


gen pweight2 = w2anfinwgt0
gen pweight3 = w3anfinwgt0
gen pweight4 = w4anfinwgt0
gen pweight5 = w5anfinwgt0
gen pweight6 = w6anfinwgt0
gen pweight7 = w7anfinwgt0
gen pweight8 = w8anfinwgt0


gen strata2 = w2varstrat
gen strata3 = w3varstrat
gen strata4 = w4varstrat
gen strata5 = w5varstrat
gen strata6 = w6varstrat
gen strata7 = w7varstrat
gen strata8 = w8varstrat


gen nhat_w2w8 = . 

replace nhat_w2w8 = 1 if pd2placedied != -1 & family_friend_resp==1 & r2dresid==6 
replace nhat_w2w8 = 1 if pd3placedied != -1 & family_friend_resp3 ==1 & r3dresid ==6
replace nhat_w2w8 = 1 if pd4placedied != -1 & family_friend_resp4 ==1 & r4dresid ==6
replace nhat_w2w8 = 1 if pd5placedied != -1 & family_friend_resp5 ==1 & r5dresid ==6
replace nhat_w2w8 = 1 if pd6placedied != -1 & family_friend_resp6 ==1 & r6dresid ==6
replace nhat_w2w8 = 1 if pd7placedied != -1 & family_friend_resp7 ==1 & r7dresid ==6
replace nhat_w2w8 = 1 if pd8placedied != -1 & family_friend_resp8 ==1 & r8dresid ==6

************************************************************************


** spouse race cancer age bedbound in the last month 

**Generate variable spouse=1 if proxy is a spouse
 
gen spouse = 0 
replace spouse = 1 if is2prxyrelat ==2
replace spouse = 1 if is3prxyrelat ==2 
replace spouse = 1 if is4prxyrelat ==2 
replace spouse = 1 if is5prxyrelat ==2 
replace spouse = 1 if is6prxyrelat ==2 
replace spouse = 1 if is7prxyrelat ==2 
replace spouse = 1 if is8prxyrelat ==2 


**Generate variable child = 1 if proxy is a child

gen child = 0 
replace child = 1 if is2prxyrelat >=3 & is2prxyrelat <=6
replace child = 1 if is3prxyrelat >=3 & is3prxyrelat <=6
replace child = 1 if is4prxyrelat >=3 & is4prxyrelat <=6
replace child = 1 if is5prxyrelat >=3 & is5prxyrelat <=6
replace child = 1 if is6prxyrelat >=3 & is6prxyrelat <=6
replace child = 1 if is7prxyrelat >=3 & is7prxyrelat <=6
replace child = 1 if is8prxyrelat >=3 & is8prxyrelat <=6

**Generate other_family=1 if proxy is anothr family member besides child or spouse

gen other_family = 0 
replace other_family = 1 if is2prxyrelat >=7 & is2prxyrelat <=29
replace other_family = 1 if is3prxyrelat >=7 & is3prxyrelat <=29
replace other_family = 1 if is4prxyrelat >=7 & is4prxyrelat <=29
replace other_family = 1 if is5prxyrelat >=7 & is5prxyrelat <=29
replace other_family = 1 if is6prxyrelat >=7 & is6prxyrelat <=29
replace other_family = 1 if is7prxyrelat >=7 & is7prxyrelat <=29
replace other_family = 1 if is8prxyrelat >=7 & is8prxyrelat <=29

*Generate other_friend=1 if proxy is a friend/non-family member

gen other_friend = 0 
replace other_friend = 1 if is2prxyrelat >=30 & is2prxyrelat <=92
replace other_friend = 1 if is3prxyrelat >=30 & is3prxyrelat <=92
replace other_friend = 1 if is4prxyrelat >=30 & is4prxyrelat <=92
replace other_friend = 1 if is5prxyrelat >=30 & is5prxyrelat <=92
replace other_friend = 1 if is6prxyrelat >=30 & is6prxyrelat <=92
replace other_friend = 1 if is7prxyrelat >=30 & is7prxyrelat <=92
replace other_friend = 1 if is8prxyrelat >=30 & is8prxyrelat <=92
 
 
**Generate deathage_cat variable for decedent age at death
**1=65-69, 2=70-74, 3=75-79, 4=80-84, 5=85-89, 6=90+ 
 
gen deathage_cat = r2d2deathage 

replace deathage_cat = 1 if r3d2deathage ==1
replace deathage_cat = 2 if r3d2deathage ==2
replace deathage_cat = 3 if r3d2deathage ==3
replace deathage_cat = 4 if r3d2deathage ==4
replace deathage_cat = 5 if r3d2deathage ==5
replace deathage_cat = 6 if r3d2deathage ==6

replace deathage_cat = 1 if r4d2deathage ==1
replace deathage_cat = 2 if r4d2deathage ==2
replace deathage_cat = 3 if r4d2deathage ==3
replace deathage_cat = 4 if r4d2deathage ==4
replace deathage_cat = 5 if r4d2deathage ==5
replace deathage_cat = 6 if r4d2deathage ==6

replace deathage_cat = 1 if r5d2deathage ==1
replace deathage_cat = 2 if r5d2deathage ==2
replace deathage_cat = 3 if r5d2deathage ==3
replace deathage_cat = 4 if r5d2deathage ==4
replace deathage_cat = 5 if r5d2deathage ==5
replace deathage_cat = 6 if r5d2deathage ==6

replace deathage_cat = 1 if r6d2deathage ==1
replace deathage_cat = 2 if r6d2deathage ==2
replace deathage_cat = 3 if r6d2deathage ==3
replace deathage_cat = 4 if r6d2deathage ==4
replace deathage_cat = 5 if r6d2deathage ==5
replace deathage_cat = 6 if r6d2deathage ==6

replace deathage_cat = 1 if r7d2deathage ==1
replace deathage_cat = 2 if r7d2deathage ==2
replace deathage_cat = 3 if r7d2deathage ==3
replace deathage_cat = 4 if r7d2deathage ==4
replace deathage_cat = 5 if r7d2deathage ==5
replace deathage_cat = 6 if r7d2deathage ==6

replace deathage_cat = 1 if r8d2deathage ==1
replace deathage_cat = 2 if r8d2deathage ==2
replace deathage_cat = 3 if r8d2deathage ==3
replace deathage_cat = 4 if r8d2deathage ==4
replace deathage_cat = 5 if r8d2deathage ==5
replace deathage_cat = 6 if r8d2deathage ==6
**1=65-69, 2=70-74, 3=75-79, 4=80-84, 5=85-89, 6=90+ 

label define agecat 1 "65-69" 2 "70-74" 3 "75-79" 4 "80-84" 5 "85-89" 6 "90+"
label values deathage_cat agecat 
replace deathage_cat=. if deathage_cat==-8 | deathage_cat==-7 | deathage_cat==-1

gen diff_get_out_bed = 0 
replace diff_get_out_bed = 1 if pd2outbed >=3 & pd2outbed <=5
replace diff_get_out_bed = 1 if pd3outbed >=3 & pd3outbed <=5
replace diff_get_out_bed = 1 if pd4outbed >=3 & pd4outbed <=5
replace diff_get_out_bed = 1 if pd5outbed >=3 & pd5outbed <=5
replace diff_get_out_bed = 1 if pd6outbed >=3 & pd6outbed <=5
replace diff_get_out_bed = 1 if pd7outbed >=3 & pd7outbed <=5
replace diff_get_out_bed = 1 if pd8outbed >=3 & pd8outbed <=5


**Generate variable recode_overall_rate which is combined waves rating of care in last month of life (lm*ratecare)
** 1=excellent, 5=poor

gen recode_overall_rate = overall_rate2
replace recode_overall_rate = overall_rate3 if overall_rate2 == -1 
replace recode_overall_rate = overall_rate4 if overall_rate3 == -1 
replace recode_overall_rate = overall_rate5 if overall_rate4 == -1 
replace recode_overall_rate = overall_rate6 if overall_rate5 == -1 
replace recode_overall_rate = overall_rate7 if overall_rate6 == -1 
replace recode_overall_rate = overall_rate8 if overall_rate7 == -1 


recode recode_overall_rate (-8=.) (-7 =.) (-1=.) 

**Generate variable recode_informed, combined waves of how often family kept informed of condition
** 1= always, 4= never

gen recode_informed = informed2
replace recode_informed = informed3 if informed2 ==-1 
replace recode_informed = informed4 if informed3 ==-1 
replace recode_informed = informed5 if informed4 ==-1 
replace recode_informed = informed6 if informed5 ==-1 
replace recode_informed = informed7 if informed6 ==-1 
replace recode_informed = informed8 if informed7 ==-1 

recode recode_informed (-8=.) (-7=.) (-1=.)

gen recode_always_respect = always_respect2
replace recode_always_respect = always_respect3 if always_respect2 ==-1 
replace recode_always_respect = always_respect4 if always_respect3 ==-1 
replace recode_always_respect = always_respect5 if always_respect4 ==-1 
replace recode_always_respect = always_respect6 if always_respect5 ==-1 
replace recode_always_respect = always_respect7 if always_respect6 ==-1 
replace recode_always_respect = always_respect8 if always_respect7 ==-1 

recode recode_always_respect (-8 =.) (-7=.) (-1=.) 

**Generate variable recode_care_notwant that is combined waves whether any care received in last month
**that pt would not have wanted, 1=yes

gen recode_care_notwant = care_notwant2
replace recode_care_notwant = care_notwant3 if care_notwant2 == -1 
replace recode_care_notwant = care_notwant4 if care_notwant3 == -1 
replace recode_care_notwant = care_notwant5 if care_notwant4 == -1
replace recode_care_notwant = care_notwant6 if care_notwant5 == -1 
replace recode_care_notwant = care_notwant7 if care_notwant6 == -1 
replace recode_care_notwant = care_notwant8 if care_notwant7 == -1 
recode recode_care_notwant (-8 =.) (-7=.) (3=.) (-1=.)
recode recode_care_notwant (2=0)

**Generate variable recode_care_decision that is combined waves whether decision in last month made
**without input from pt or family, 1=yes

gen recode_care_decision = care_decision2
replace recode_care_decision = care_decision3 if care_decision2 ==-1 
replace recode_care_decision = care_decision4 if care_decision3 ==-1 
replace recode_care_decision = care_decision5 if care_decision4 ==-1 
replace recode_care_decision = care_decision6 if care_decision5 ==-1 
replace recode_care_decision = care_decision7 if care_decision6 ==-1 
replace recode_care_decision = care_decision8 if care_decision7 ==-1 

recode recode_care_decision (-8 =.) (-7=.) (-1=.) 
recode recode_care_decision (3=.)(2=0)

gen recode_had_pain = had_pain2
replace recode_had_pain = had_pain3 if had_pain2 ==-1 
replace recode_had_pain = had_pain4 if had_pain3 ==-1 
replace recode_had_pain = had_pain5 if had_pain4 ==-1 
replace recode_had_pain = had_pain6 if had_pain5 ==-1 
replace recode_had_pain = had_pain7 if had_pain6 ==-1 
replace recode_had_pain = had_pain8 if had_pain7 ==-1 

recode recode_had_pain (-8 =.) (-7=.) (-1=.) 

gen unmet_pain = unmet_pain2
replace unmet_pain = unmet_pain3 if unmet_pain2 ==. & r3dresid ==6
replace unmet_pain = unmet_pain4 if unmet_pain3 ==. & r4dresid ==6
replace unmet_pain = unmet_pain5 if unmet_pain4 ==. & r5dresid ==6
replace unmet_pain = unmet_pain6 if unmet_pain5 ==. & r6dresid ==6
replace unmet_pain = unmet_pain7 if unmet_pain6 ==. & r7dresid ==6
replace unmet_pain = unmet_pain8 if unmet_pain7 ==. & r8dresid ==6


gen unmet_bre = unmet_bre2
replace unmet_bre = unmet_bre3 if unmet_bre2 ==. & r3dresid ==6
replace unmet_bre = unmet_bre4 if unmet_bre3 ==. & r4dresid ==6
replace unmet_bre = unmet_bre5 if unmet_bre4 ==. & r5dresid ==6
replace unmet_bre = unmet_bre6 if unmet_bre5 ==. & r6dresid ==6
replace unmet_bre = unmet_bre7 if unmet_bre6 ==. & r7dresid ==6
replace unmet_bre = unmet_bre8 if unmet_bre7 ==. & r8dresid ==6


gen unmet_sad = unmet_sad2
replace unmet_sad = unmet_sad3 if unmet_sad2 ==. & r3dresid ==6
replace unmet_sad = unmet_sad4 if unmet_sad3 ==. & r4dresid ==6
replace unmet_sad = unmet_sad5 if unmet_sad4 ==. & r5dresid ==6
replace unmet_sad = unmet_sad6 if unmet_sad5 ==. & r6dresid ==6
replace unmet_sad = unmet_sad7 if unmet_sad6 ==. & r7dresid ==6
replace unmet_sad = unmet_sad8 if unmet_sad7 ==. & r8dresid ==6


gen unmet_relig = unmet_relig2
replace unmet_relig = unmet_relig3 if unmet_relig2 ==. & r3dresid ==6
replace unmet_relig = unmet_relig4 if unmet_relig3 ==. & r4dresid ==6
replace unmet_relig = unmet_relig5 if unmet_relig4 ==. & r5dresid ==6
replace unmet_relig = unmet_relig6 if unmet_relig5 ==. & r6dresid ==6
replace unmet_relig = unmet_relig7 if unmet_relig6 ==. & r7dresid ==6
replace unmet_relig = unmet_relig8 if unmet_relig7 ==. & r8dresid ==6


gen recode_had_bre = had_bre2
replace recode_had_bre = had_bre3 if had_bre2==-1 
replace recode_had_bre = had_bre4 if had_bre3==-1 
replace recode_had_bre = had_bre5 if had_bre4==-1 
replace recode_had_bre = had_bre6 if had_bre5==-1 
replace recode_had_bre = had_bre7 if had_bre6==-1 
replace recode_had_bre = had_bre8 if had_bre7==-1 

recode recode_had_bre (-8 =.) (-7=.) (-1=.) 

**Generate variable "recode_had_sad" for combined waves if pt had feelings of anxiety or sadness
**in last month of life, 1=yes

gen recode_had_sad = had_sad2
replace recode_had_sad = had_sad3 if had_sad2==-1 
replace recode_had_sad = had_sad4 if had_sad3==-1 
replace recode_had_sad = had_sad5 if had_sad4==-1 
replace recode_had_sad = had_sad6 if had_sad5==-1 
replace recode_had_sad = had_sad7 if had_sad6==-1 
replace recode_had_sad = had_sad8 if had_sad7==-1 

recode recode_had_sad (-8 =.) (-7=.) (-1=.) 


gen di_recode_always_respect = .  
replace di_recode_always_respect = 1 if recode_always_respect >=2 & recode_always_respect <=5
replace di_recode_always_respect = 0 if recode_always_respect ==1

**Generate variable di_recode_informed for not kept informed of condition (all responses other 
**than "always")

gen di_recode_informed = .  
replace di_recode_informed = 1 if recode_informed >=2 & recode_informed <=5
replace di_recode_informed  = 0 if recode_informed ==1


gen age_cat1 =0 
replace age_cat1 = deathage_cat==1
gen age_cat2 =0 
replace age_cat2 = deathage_cat==2
gen age_cat3 =0 
replace age_cat3 = deathage_cat==3
gen age_cat4 =0 
replace age_cat4 = deathage_cat==4
gen age_cat5 =0 
replace age_cat5 = deathage_cat==5
gen age_85 = 0
replace age_85 =1  if deathage_cat >=6
 
*************************************


gen resp_sex = is2prxygendr if r2dresid==6  
replace resp_sex = is3prxygendr if r3dresid==6  
replace resp_sex = is4prxygendr if r4dresid==6  
replace resp_sex = is5prxygendr if r5dresid==6 
replace resp_sex = is6prxygendr if r6dresid==6  
replace resp_sex = is7prxygendr if r7dresid==6  
replace resp_sex = is8prxygendr if r8dresid==6  
recode resp_sex (-1=.)

 

gen pweight = pweight2 
replace pweight = pweight3 if r3dresid==6
replace pweight = pweight4 if r4dresid==6 
replace pweight = pweight5 if r5dresid==6 
replace pweight = pweight6 if r6dresid==6
replace pweight = pweight7 if r7dresid==6
replace pweight = pweight8 if r8dresid==6


gen strata = strata2 
replace strata = strata3 if r3dresid==6
replace strata = strata4 if r4dresid==6
replace strata = strata5 if r5dresid==6
replace strata = strata6 if r6dresid==6
replace strata = strata7 if r7dresid==6
replace strata = strata8 if r8dresid==6

gen sunit = sunit2 
replace sunit= sunit3 if r3dresid==6
replace sunit= sunit4 if r4dresid==6
replace sunit= sunit5 if r5dresid==6
replace sunit= sunit6 if r6dresid==6
replace sunit= sunit7 if r7dresid==6
replace sunit= sunit8 if r8dresid==6


gen inanal = 0 
replace inanal = 1 if family_friend_resp ==1 & r2dresid==6
replace inanal = 1 if family_friend_resp3 ==1 & r3dresid==6
replace inanal = 1 if family_friend_resp4 ==1 & r4dresid==6
replace inanal = 1 if family_friend_resp5 ==1 & r5dresid==6
replace inanal = 1 if family_friend_resp6 ==1 & r6dresid==6
replace inanal = 1 if family_friend_resp7 ==1 & r7dresid==6
replace inanal = 1 if family_friend_resp8 ==1 & r8dresid==6


svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

****

gen hosp_last_month = . 
replace hosp_last_month = 1 if pd3hospcelml ==1 |pd4hospcelml ==1 |pd5hospcelml ==1 |pd6hospcelml ==1 |pd7hospcelml ==1 |pd8hospcelml ==1
replace hosp_last_month = 0 if pd3hospcelml ==2 |pd4hospcelml ==2 |pd5hospcelml ==2 |pd6hospcelml ==2 |pd7hospcelml ==2 |pd8hospcelml ==2



** create disease categories 


gen mi_all = 0 
replace mi_all = 1 if  mi_1==1 & family_friend_resp ==1 & r2dresid==6
replace mi_all = 1 if  mi_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace mi_all = 1 if  mi_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace mi_all = 1 if  mi_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace mi_all = 1 if  mi_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace mi_all = 1 if  mi_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace mi_all = 1 if  mi_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen dm_all = 0 
replace dm_all = 1 if  dm_1==1 & family_friend_resp ==1 & r2dresid==6
replace dm_all = 1 if  dm_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace dm_all = 1 if  dm_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace dm_all = 1 if  dm_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace dm_all = 1 if  dm_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace dm_all = 1 if  dm_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace dm_all = 1 if  dm_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen lung_all = 0 
replace lung_all = 1 if  lung_1==1 & family_friend_resp ==1 & r2dresid==6
replace lung_all = 1 if  lung_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace lung_all = 1 if  lung_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace lung_all = 1 if  lung_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace lung_all = 1 if  lung_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace lung_all = 1 if  lung_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace lung_all = 1 if  lung_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen cva_all = 0 
replace cva_all = 1 if  cva_1==1 & family_friend_resp ==1 & r2dresid==6
replace cva_all = 1 if  cva_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace cva_all = 1 if  cva_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace cva_all = 1 if  cva_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace cva_all = 1 if  cva_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace cva_all = 1 if  cva_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace cva_all = 1 if  cva_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen dementia_all = 0 
replace dementia_all = 1 if  dementia_1==1 & family_friend_resp ==1 & r2dresid==6
replace dementia_all = 1 if  dementia_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace dementia_all = 1 if  dementia_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace dementia_all = 1 if  dementia_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace dementia_all = 1 if  dementia_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace dementia_all = 1 if  dementia_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace dementia_all = 1 if  dementia_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen cancer_all = 0 
replace cancer_all = 1 if  cancer_1==1 & family_friend_resp ==1 & r2dresid==6
replace cancer_all = 1 if  cancer_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace cancer_all = 1 if  cancer_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace cancer_all = 1 if  cancer_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace cancer_all = 1 if  cancer_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace cancer_all = 1 if  cancer_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace cancer_all = 1 if  cancer_7==1 & family_friend_resp8 ==1 & r8dresid==6



gen site_of_death_hospice = site_of_death_w2w8
replace site_of_death_hospice = 7 if site_of_death_w2w8 ==1 & hosp_last_month ==1
replace site_of_death_hospice = 8 if site_of_death_w2w8 ==5 & hosp_last_month ==1

**Generate variable "excellent" if overall care in last month of life rated excellent. 1=yes, 0 if otherwise

gen excellent = 0 if recode_overall_rate !=. 
replace excellent =1 if recode_overall_rate ==1 

*variable on transitions of care

gen los_last_place = -1
replace los_last_place = pd2staydays if r2dresid==6 
replace los_last_place = pd3staydays if r3dresid==6
replace los_last_place = pd4staydays if r4dresid==6
replace los_last_place = pd5staydays if r5dresid==6
replace los_last_place = pd6staydays if r6dresid==6
replace los_last_place = pd7staydays if r7dresid==6
replace los_last_place = pd8staydays if r8dresid==6


replace los_last_place = -2 if pd2stayunit >=2 & pd2stayunit <=4
replace los_last_place = -2 if pd3stayunit >=2 & pd3stayunit <=4
replace los_last_place = -2 if pd4stayunit >=2 & pd4stayunit <=4
replace los_last_place = -2 if pd5stayunit >=2 & pd5stayunit <=4
replace los_last_place = -2 if pd6stayunit >=2 & pd6stayunit <=4
replace los_last_place = -2 if pd7stayunit >=2 & pd7stayunit <=4
replace los_last_place = -2 if pd8stayunit >=2 & pd8stayunit <=4


gen late_transition = 0 if r2dresid ==6| r3dresid ==6| r4dresid ==6| r5dresid ==6| r6dresid ==6 | r7dresid ==6 | r8dresid ==6 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd4placepre >0 &  pd4placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd3placepre >0 &  pd3placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd2placepre >0 &  pd2placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd5placepre >0 &  pd5placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd6placepre >0 &  pd6placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd7placepre >0 &  pd7placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd8placepre >0 &  pd8placepre <=91) 


save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\nhats only.dta", replace


H="build data set step 2: add claims data"
*step 2: this merges in the claims- hospice/ma data to the nhats only data, creating a working dataset

use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\nhats only.dta", clear
tempfile nhats
save "`nhats'"

/*
use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", clear

merge 1:m bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", gen(hospm) keep(master match) keepusing(ptnt_dschrg_stus_cd )
gen ind_hospice=hospm==3
by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

drop ptnt_dschrg_stus_cd

duplicates drop 

merge 1:1 spid using "`nhats'", nogen 
merge 1:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\death_date.dta", nogen

*/


///////////////////////


//MBSF GETTING MA first part for methods 1 and 2. 


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
sort bene_id year 
keep if death_date!=.
keep bene_id death_date

tempfile death
save "`death'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", clear

sort bene_id clm_hospc_start_dt_id

gen hospice_month= month(clm_hospc_start_dt_id)
gen hospice_year= year(clm_hospc_start_dt_id)

by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 1,0))

sort bene_id clm_hospc_start_dt_id

merge m:1 bene_id using "`death'", keep(match) nogen

sort bene_id clm_hospc_start_dt_id
gen hs_12_pre=0
by bene_id, sort: replace hs_12_pre=1 if (death_date-clm_hospc_start_dt_id<=366) & (death_date-clm_hospc_start_dt_id>=0)

//by bene_id, sort: egen ind_hs_12_pre=max(hs_12_pre)

sort bene_id clm_hospc_start_dt_id


bys bene_id hs_12_pre: keep if _n==1 
bys bene_id: keep if _n==_N

tempfile hs
save "`hs'"


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

gen death_month=month(death_date)

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1

gen ma1=0

di `a'
foreach x in `month'{
gen `x'_c=substr(hmoind12,`a',1)
replace `x'_c="1" if `x'_c!="0"
destring `x'_c, replace
replace ma1=1 if death_month==`a' & `x'_c==1
local a=`a'+1
di `a'
}



sort bene_id
tempfile ma1 
save "`ma1'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
//want 1 year prior to look at, thus we add 1 and merge
replace year=year+1

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1


foreach x in `month'{
gen `x'_c_1=substr(hmoind12,`a',1)
replace `x'_c_1="1" if `x'_c_1!="0"
destring `x'_c_1, replace
local a=`a'+1
}

keep *_c_1 year bene_id

tempfile ma2 
save "`ma2'"


use "`ma1'", clear

keep if death_date!=.

merge 1:1 bene_id year using "`ma2'", keep(match) nogen


gen ma2=0 


/*
consecutive MA status--doesn't matter
*/

replace ma2=1 if death_month==1 & (jan_c==1 | jan_c_1==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==2 & (feb_c==1 | jan_c==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==3 & (mar_c==1 | jan_c==1 | feb_c==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==4 & (apr_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==5 & (may_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==6 & (jun_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==7 & (jul_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==8 & (aug_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==9 & (sep_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==10 & (oct_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==11 & (nov_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==12 & (dec_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c==1 | dec_c_1==1)

sort bene_id year

//by bene_id: keep if _n==_N


merge m:1 bene_id using "`hs'", gen(hospm) keep(master match)

gen ind_hospice=hospm==3

replace ma1=0 if ind_hospice==1
replace ma2=0 if ind_hospice==1

gen ma_month_bef_hs=0
local a=1
local month dec_c_1 jan_c feb_c mar_c apr_c may_c jun_c jul_c aug_c sep_c oct_c nov_c 
foreach x in `month'{
replace ma_month_bef_hs=1 if hospice_month==`a' & `x'==1 
local a=`a'+1
}

replace ma1=1 if ind_hospice==1  & ma_month_bef_hs==1

replace ma2=1 if hs_12_pre==1 &  ma_month_bef_hs==1

sort bene_id year 
by bene_id: keep if _n==_N

merge 1:1 bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", keep(match) nogen

keep bene_id spid ma1 ma2 hs_12_pre ind_died_on_hospice ind_hospice ma_month_bef_hs death_date year hospice_year death_month prvdr_num
merge 1:m spid using "`nhats'", nogen keep(match)

label var ma1 "MA approach 1"
label var ma2 "MA approach 2 (12 month)"
label var hs_12_pre "Hospice claim 12-months pre death"
label var ind_died_on_hospice "Died in Hospice"
label var ma_month_bef_hs "Had MA month before Hospice"


destring prvdr_num, replace
merge m:1 prvdr_num using  "D:\NHATS\Projects\MA after functional disability\cka_ma switches disability\data\bene spid and hospice_one yr only.dta"
drop if _merge==2
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\claims and nhats.dta", replace


H="build data set step 3: merge in some more nhats vars"
*step 3: merging in other nhats data
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\race var.dta"
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\female var.dta"
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\other nhats vars.dta"



H="more variable cleaning"
*more variable cleaning
recode deathage_cat (1/2=1 "65-74")(3/4=2 "75-84")(5/6=3 "85+"),gen(deathage_3cat)

*live discharge
gen livedischarge=0 if ind_hospice==1
replace livedischarge=1 if ind_hospice==1 & ind_died_on_hospice==0

*place of death
gen placedeath=.
foreach var of varlist pd8placepre pd7placepre pd6placepre pd5placepre pd4placepre pd3placepre pd2placepre {
replace placedeath=1 if `var'==1
replace placedeath=2 if `var'==2
replace placedeath=3 if `var'==3
replace placedeath=4 if `var'==4 | `var'==5 | `var'==91
}
label define pd2 1 "1 home" 2 "2 hospital" 3 "3 nursing home" 4 "4 other"
label values  placedeath pd2
tab placedeath 


recode excellent (1=0)(0=1), gen(not_excellent)

gen perc_9or10=rating_9or10/100



save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace


H="analysis"
*analysis
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta"


svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

*table 1: in MA at time of death vs not
*looking at quality variables
svy, subpop(inanal): tab ma1
tab ma1 if inanal==1, m

svy, subpop(inanal): tab ma1 year, column
svy, subpop(inanal): tab ind_hospice, column
tab ind_hospice, m
svy, subpop(inanal): tab ind_hospice ma1, column
svy, subpop(inanal): tab ind_hospice year, column


svy, subpop(inanal): tab ma2, count cellwidth(15) format (%15.2g)

svy, subpop(inanal): tab deathage_3cat ma1, column
svy, subpop(inanal): tab female ma1, column
svy, subpop(inanal): tab race_cat ma1, column
svy, subpop(inanal): tab income_quart ma1, column
svy, subpop(inanal): tab metro_ind ma1, column
svy, subpop(inanal): tab adl_impair ma1, column
svy, subpop(inanal): tab mi_all ma1, column
svy, subpop(inanal): tab dm_all ma1, column
svy, subpop(inanal): tab lung_all ma1, column
svy, subpop(inanal): tab cva_all ma1, column
svy, subpop(inanal): tab cancer_all ma1, column
svy, subpop(inanal): tab prob_dem ma1, column



*figure 1

/*
i don't actually know how to do this right.
svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)
tabout excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant ma1 if inanal==1 using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\output\fig2.htm", ///
c(row ci) f(1 1) clab(Row_% 95% CI) svy stats (chi2) ///
npos(lab) percent ///
rep ///
style(tex) bt font(bold) cl1(2-6)
*/
foreach var of varlist not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		qui svy, subpop(inanal): logistic `var' i.ma1,  cformat(%4.2f)
		margins ma1
}

*table 2: association between MA and EOL outcome
*model 1: unadjusted
foreach var of varlist not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.ma1, cformat(%4.2f)
}

*new model 2: fully adjusted
foreach var of varlist not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.ma1 i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
}

*new model 3: fully adjusted with alt MA def 
foreach var of varlist not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.ma2 i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
}


*FIGURE 2
*interaction with hospice for excellent care
qui svy, subpop(inanal): logistic not_excellent i.ma1##i.ind_hospice i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#ind_hospice
	marginsplot	

	*interaction with place of death for excellent care 
qui svy, subpop(inanal): logistic not_excellent i.ma1##i.placedeath i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#placedeath
	marginsplot	
	
*interaction with hospice for informed
	
qui svy, subpop(inanal): logistic di_recode_informed i.ma1##i.ind_hospice i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#ind_hospice
	marginsplot	

*interaction with place of death for informed	
qui svy, subpop(inanal): logistic di_recode_informed i.ma1##i.placedeath i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#placedeath
	marginsplot	

	
**** PLANNED ADDITION TO FIGURE 2: QUALITY ACROSS REGIONS WITH VARYING MA PENETRATION****

*interaction with place of death for excellent care 
qui svy, subpop(inanal): logistic not_excellent i.ma1##i.quart_MA i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#quart_MA 
	marginsplot	

*interaction with place of death for informed	
qui svy, subpop(inanal): logistic di_recode_informed i.ma1##i.quart_MA i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed year, cformat(%4.2f)
	margins ma1#quart_MA 
	marginsplot	

	

*TABLE 3	
*looking at eol care characteristics and ma


foreach var of varlist ind_hospice  livedischarge late_transition placedeath {
		svy, subpop(inanal): tab `var' ma1, column
}
	
svy, subpop(inanal): mean perc_9or10, over(ma1) 	
	svy, subpop(inanal): reg perc_9or10 i.ma1 
	
svy, subpop(inanal): mean comp_process_score, over(ma1) 	
	svy, subpop(inanal): reg comp_process_score i.ma1 
		
	
	
	
*interaction with hospice for family not kept informed
qui svy, subpop(inanal): logistic di_recode_informed i.ma1##i.ind_hospice i.deathage_3cat female i.race_cat child other_family other_friend year ///
		income_quart metro_ind adl_impair mi_all cancer_all lung_all prob_dem ind_hospice, cformat(%4.2f)
	margins ma1#ind_hospice
	marginsplot	
	
	
*interaction with hospice for unmet needs for sadness and anxiety
qui svy, subpop(inanal): logistic unmet_sad i.ma1##i.ind_hospice i.deathage_3cat female i.race_cat child other_family other_friend year ///
		income_quart metro_ind adl_impair mi_all lung_all cancer_all prob_dem ind_hospice, cformat(%4.2f)
	margins ma1#ind_hospice
	marginsplot	
	
*sensitivity analysis
*new model 2: fully adjusted
foreach var of varlist excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.ma2 i.deathage_3cat female child  spouse  ///
		 year diff_get_out_bed, cformat(%4.2f)
}


foreach var of varlist excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.placedeath , cformat(%4.2f)
}


*looking at eol care characteristics and ma
foreach var of varlist ind_hospice livedischarge late_transition placedeath {
		svy, subpop(inanal): tab `var' ma1, column
}

*QUALITY AND SITE OF DEATH: adjusted rates and associations by site of death for each quality measure
foreach var of varlist excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		svy, subpop(inanal): logistic `var' i.placedeath i.deathage_3cat female child  spouse  ///
		 year diff_get_out_bed, cformat(%4.2f)
		 margins placedeath
}

*is quality in ma/tm different by site of death?
foreach var of varlist excellent unmet_sad  di_recode_informed {
		svy, subpop(inanal): logistic `var' i.placedeath##i.ma1 
		 margins placedeath#ma1
		 
}



*** running for Rashmi ******************

svy linearized, subpop(inanal if inanal==1) : logit excellent mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : ologit recode_overall_rate diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child i.wave_nhat, or 
svy linearized, subpop(inanal if inanal==1) : logit excellent mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
 
svy linearized, subpop(inanal if inanal==1) : logit unmet_pain mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_bre mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_sad mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_relig mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_always_respect mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision2 mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend, or 

************ bivariates on B and hispanic 


svy linearized, subpop(inanal if inanal==1) : tabulate resp_sex white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate age_85 white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate hispanic  white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_race white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate child white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_family white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_friend white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate spouse white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate recode_cancer white, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate diff_get_out_bed white, cell column row pearson



tab resp_sex white if inanal==1, row col 
tab age_85 white if inanal==1, row col 
tab white white if inanal==1, row col 
tab black  white if inanal==1, row col 
tab hispanic white if inanal==1, row col 
tab other_race white if inanal==1, row col
tab child white if inanal==1, row col
tab other_family  white if inanal==1, row col 
tab other_friend white if inanal==1, row col
tab spouse white if inanal==1, row col
tab recode_cancer white if inanal==1, row col 
tab diff_get_out_bed white if inanal==1, row col 


svy linearized, subpop(inanal if inanal==1) : tabulate resp_sex black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate age_85 black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate hispanic  black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_race black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate child black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_family black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_friend black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate spouse black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate recode_cancer black, cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate diff_get_out_bed black, cell column row pearson



tab resp_sex black if inanal==1, row col 
tab age_85 black if inanal==1, row col 
tab black black if inanal==1, row col 
tab black  black if inanal==1, row col 
tab hispanic black if inanal==1, row col 
tab other_race black if inanal==1, row col
tab child black if inanal==1, row col
tab other_family  black if inanal==1, row col 
tab other_friend black if inanal==1, row col
tab spouse black if inanal==1, row col
tab recode_cancer black if inanal==1, row col 
tab diff_get_out_bed black if inanal==1, row col 


svy linearized, subpop(inanal if inanal==1) : tabulate resp_sex hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate age_85 hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate hispanic  hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_race hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate child hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_family hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate other_friend hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate spouse hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate recode_cancer hispanic , cell column row pearson
svy linearized, subpop(inanal if inanal==1) : tabulate diff_get_out_bed hispanic , cell column row pearson



tab resp_sex hispanic  if inanal==1, row col 
tab age_85 hispanic  if inanal==1, row col 
tab other_race hispanic  if inanal==1, row col
tab child hispanic  if inanal==1, row col
tab other_family  hispanic  if inanal==1, row col 
tab other_friend hispanic  if inanal==1, row col
tab spouse hispanic  if inanal==1, row col
tab recode_cancer hispanic  if inanal==1, row col 
tab diff_get_out_bed hispanic  if inanal==1, row col 

********* outcome analysis ************************************
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_pain white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_bre white, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_sad white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_relig white, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_pain white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_bre white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_sad white, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_always_respect white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_decision white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_overall_rate white, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_notwant white, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_informed white, cell column row pearson

tab unmet_pain white if inanal==1, row col 
tab unmet_bre white if inanal==1, row col 

tab unmet_sad white if inanal==1, row col 
tab unmet_relig white if inanal==1, row col 

tab recode_had_pain white if inanal==1, row col 
tab recode_had_bre white if inanal==1, row col
tab recode_had_sad white if inanal==1, row col


tab di_recode_always_respect white if inanal==1, row col 
tab recode_care_decision white if inanal==1, row col
tab recode_overall_rate white if inanal==1, row col

tab recode_care_notwant white if inanal==1, row col
tab di_recode_informed white if inanal==1, row col


svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_pain black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_bre black, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_sad black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_relig black, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_pain black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_bre black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_sad black, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_always_respect black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_decision black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_overall_rate black, cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_notwant black, cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_informed black, cell column row pearson

tab unmet_pain black if inanal==1, row col 
tab unmet_bre black if inanal==1, row col 

tab unmet_sad black if inanal==1, row col 
tab unmet_relig black if inanal==1, row col 

tab recode_had_pain black if inanal==1, row col 
tab recode_had_bre black if inanal==1, row col
tab recode_had_sad black if inanal==1, row col


tab di_recode_always_respect black if inanal==1, row col 
tab recode_care_decision black if inanal==1, row col
tab recode_overall_rate black if inanal==1, row col

tab recode_care_notwant black if inanal==1, row col
tab di_recode_informed black if inanal==1, row col



svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_pain hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_bre hispanic , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_sad hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_relig hispanic , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_pain hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_bre hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_sad hispanic , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_always_respect hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_decision hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_overall_rate hispanic , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_notwant hispanic , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_informed hispanic , cell column row pearson

tab unmet_pain hispanic  if inanal==1, row col 
tab unmet_bre hispanic  if inanal==1, row col 

tab unmet_sad hispanic  if inanal==1, row col 
tab unmet_relig hispanic  if inanal==1, row col 

tab recode_had_pain hispanic  if inanal==1, row col 
tab recode_had_bre hispanic  if inanal==1, row col
tab recode_had_sad hispanic  if inanal==1, row col


tab di_recode_always_respect hispanic  if inanal==1, row col 
tab recode_care_decision hispanic  if inanal==1, row col
tab recode_overall_rate hispanic  if inanal==1, row col

tab recode_care_notwant hispanic  if inanal==1, row col
tab di_recode_informed hispanic  if inanal==1, row col

***8 Need to recode the 3 on recode_care_decision 

gen recode_care_decision2 = recode_care_decision 
recode recode_care_decision2 (3=.)  

************** multivariate ******************************
svy linearized, subpop(inanal if inanal==1) : ologit recode_overall_rate recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4 , or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_pain recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_bre recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_sad recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_always_respect recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4 , or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4 , or 
svy linearized, subpop(inanal if inanal==1) : logit excellent recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_notwant recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_informed recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_relig recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 



svy linearized, subpop(inanal if inanal==1) : logit di_recode_informed 

recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child wave_nhat3  wave_nhat4, or 


svy linearized, subpop(inanal if inanal==1) : ologit recode_overall_rate recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_pain recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_bre recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_sad recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_always_respect recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit excellent recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_notwant recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_informed recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child , or 

xi: logit excellent recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 child other_family other_friend hosp_last_month  if inanal==1, or 

********** Now looking at Transition 

is4famrrutin

tab pd4stayunit

tab pd4staydays

 R4 PD4A LENGTH |
   OF STAY DAYS |      Freq.     Percent        Cum.
----------------+-----------------------------------
-1 Inapplicable |      4,629       97.72       97.72
              1 |         44        0.93       98.65
              2 |         10        0.21       98.86
              3 |         12        0.25       99.11
              4 |         11        0.23       99.35
              5 |          6        0.13       99.47
              6 |          3        0.06       99.54
              7 |          7        0.15       99.68
              8 |          2        0.04       99.73
              9 |          3        0.06       99.79
             10 |          3        0.06       99.85
             11 |          3        0.06       99.92
             16 |          1        0.02       99.94
             20 |          1        0.02       99.96
             28 |          1        0.02       99.98
            200 |          1        0.02      100.00
----------------+-----------------------------------
          Total |      4,737      100.00


gen los_last_place = -1
replace los_last_place = pd2staydays if r2dresid==6 
replace los_last_place = pd3staydays if r3dresid==6
replace los_last_place = pd4staydays if r4dresid==6
replace los_last_place = pd5staydays if r5dresid==6
replace los_last_place = pd6staydays if r6dresid==6

replace los_last_place = -2 if pd2stayunit >=2 & pd2stayunit <=4
replace los_last_place = -2 if pd3stayunit >=2 & pd3stayunit <=4
replace los_last_place = -2 if pd4stayunit >=2 & pd4stayunit <=4
replace los_last_place = -2 if pd5stayunit >=2 & pd5stayunit <=4
replace los_last_place = -2 if pd6stayunit >=2 & pd6stayunit <=4

**Generate late_transition variable from those who had been in place of death <= 3 days (length of stay last place)
** and who had documented where they were before. 
**Note, we do not placepre info on people who died at home

gen late_transition = 0 if r2dresid ==6| r3dresid ==6| r4dresid ==6| r5dresid ==6| r6dresid ==6 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd4placepre >0 &  pd4placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd3placepre >0 &  pd3placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd2placepre >0 &  pd2placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd5placepre >0 &  pd5placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd6placepre >0 &  pd6placepre <=91) 


svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

recode recode_care_decision2 (1=1) (2=0)
recode recode_care_notwant (1=1) (2=0) 

*** Multivariate ******************
gen wave_nhat2 = 0 
replace wave_nhat2 =1 if wave_nhat==2

gen wave_nhat3= 0
replace wave_nhat3 =1 if wave_nhat==3 

gen wave_nhat4= 0
replace wave_nhat4 =1 if wave_nhat==4 

gen wave_nhat5=0
replace wave_nhat5 =1 if wave_nhat==5

gen wave_nhat6=0
replace wave_nhat6 =1 if wave_nhat==6

svy linearized, subpop(inanal if inanal==1) : logit excellent mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : ologit recode_overall_rate mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
tab late_transition recode_overall_rate, row col chi 
svy linearized, subpop(inanal if inanal==1) : logit unmet_pain mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_bre mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_sad mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_always_respect mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 

svy linearized, subpop(inanal if inanal==1) : logit unmet_pain mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
tab unmet_pain
tab recode_care_decision2
recode recode_care_decision2 (1=1) (2=0)
tab recode_care_notwant
recode recode_care_decision2 (1=1) (2=0)
recode recode_care_notwant (1=1) (2=0) 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_notwant mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision2 mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : ologit recode_overall_rate recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2 , or 

svy linearized, subpop(inanal if inanal==1) : logit unmet_pain recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2 , or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_bre recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_sad recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child  late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_always_respect recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_decision recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit excellent recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit recode_care_notwant recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_informed recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_relig recode_cancer diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition wave_nhat3 wave_nhat2, or 
svy linearized, subpop(inanal if inanal==1) : logit unmet_relig mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 
svy linearized, subpop(inanal if inanal==1) : logit di_recode_informed mi_all dm_all lung_all cva_all dementia_all cancer_all i.wave_nhat  diff_get_out_bed black hispanic age_cat1 age_cat2 age_cat3 age_cat4 age_cat5 spouse child late_transition, or 


svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_pain late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_bre late_transition , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_sad late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate unmet_relig late_transition , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_pain late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_bre late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_had_sad late_transition , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_always_respect late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_decision late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_overall_rate late_transition , cell column row pearson

svy linearized, subpop(inanal  if inanal ==1) : tabulate recode_care_notwant late_transition , cell column row pearson
svy linearized, subpop(inanal  if inanal ==1) : tabulate di_recode_informed late_transition , cell column row pearson



H="*********MH added MA section********"


H="xxxxxxxxPart2-- MA added in"
tempfile nhats
save "`nhats'"

/*
use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", clear

merge 1:m bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", gen(hospm) keep(master match) keepusing(ptnt_dschrg_stus_cd )
gen ind_hospice=hospm==3
by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

drop ptnt_dschrg_stus_cd

duplicates drop 

merge 1:1 spid using "`nhats'", nogen 
merge 1:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\death_date.dta", nogen

*/


///////////////////////


//MBSF GETTING MA first part for methods 1 and 2. 


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
sort bene_id year 
keep if death_date!=.
keep bene_id death_date
tempfile death
save "`death'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", clear

sort bene_id clm_hospc_start_dt_id

gen hospice_month= month(clm_hospc_start_dt_id)
gen hospice_year= year(clm_hospc_start_dt_id)

by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

sort bene_id clm_hospc_start_dt_id

merge m:1 bene_id using "`death'", keep(master match) nogen

gen hs_12_pre=0
by bene_id, sort: replace hs_12_pre=1 if (death_date-clm_hospc_start_dt_id<=366) & (death_date-clm_hospc_start_dt_id>=0)

by bene_id, sort: egen ind_hs_12_pre=max(hs_12_pre)

by bene_id: keep if _n==1

tempfile hs
save "`hs'"


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

gen death_month=month(death_date)

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1

gen ma1=0

di `a'
foreach x in `month'{
gen `x'_c=substr(hmoind12,`a',1)
replace `x'_c="1" if `x'_c!="0"
destring `x'_c, replace
replace ma1=1 if death_month==`a' & `x'_c==1
local a=`a'+1
di `a'
}
sort bene_id
tempfile ma1 
save "`ma1'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

replace year=year+1

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1


foreach x in `month'{
gen `x'_c_1=substr(hmoind12,`a',1)
replace `x'_c_1="1" if `x'_c_1!="0"
destring `x'_c_1, replace
local a=`a'+1
}


keep *_c_1 year bene_id

tempfile ma2 
save "`ma2'"


use "`ma1'", clear

merge 1:1 bene_id year using "`ma2'", keep(match) nogen


gen ma2=0 


/*
consecutive MA status--don't want
*/

replace ma2=1 if death_month==1 & (jan_c==1 | jan_c_1==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==2 & (feb_c==1 | jan_c==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==3 & (mar_c==1 | jan_c==1 | feb_c==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==4 & (apr_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==5 & (may_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==6 & (jun_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==7 & (jul_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==8 & (aug_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==9 & (sep_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==10 & (oct_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==11 & (nov_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==12 & (dec_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c==1 | dec_c_1==1)

sort bene_id year

//by bene_id: keep if _n==_N


merge m:1 bene_id using "`hs'", gen(hospm) keep(master match)

gen ind_hospice=hospm==3

gen ma_month_bef_hs=0
local a=1
local month dec_c_1 jan_c feb_c mar_c apr_c may_c jun_c jul_c aug_c sep_c oct_c nov_c 
foreach x in `month'{
replace ma_month_bef_hs=1 if hospice_month==`a' & `x'==1
local a=`a'+1
}

replace ma1=1 if ind_died_on_hospice==1 & year==hospice_year & ma_month_bef_hs==1

replace ma2=1 if ind_hs_12_pre==1 & year==hospice_year & ma_month_bef_hs==1

sort bene_id year
by bene_id: keep if _n==_N

merge 1:1 bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", keep(match) nogen

keep bene_id spid ma1 ma2 ind_hs_12_pre ind_died_on_hospice ind_hospice ma_month_bef_hs death_date year hospice_year
merge 1:m spid using "`nhats'", nogen

label var ma1 "MA approach 1"
label var ma2 "MA approach 2 (12 month)"
label var ind_hs_12_pre "Hospice claim 12-months pre death"
label var ind_died_on_hospice "Died in Hospice"
label var ma_month_bef_hs "Had MA month before Hospice"

save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace

H="Change log"


********************Change Log******************** 



Updates:
09/16/2019 MH
------------
Small change to keep only those people in NHATS who match with MA definition. 

08/08/2019 MH
------------
Made changes to the code to fix problem with MA population. 

08/07/2019 MH
------------
Have looked into problems around MA1 and hospice, have added into a working heading. 

8/7/2019 CA
re organized note tab, merged in race and sex variables, checking the hospice and ma variables and running prelim analysis.

07/22/2019 MH
-------------
Getting MA population and hopsice claims.  

7/14/2019 CKA
-------------
adapted code from joan teno to make and clean NHATS portion. note- need to bring in race variable. analysis sections posted as model.


*/