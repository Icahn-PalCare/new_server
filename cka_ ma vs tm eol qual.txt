= V4 Outline MultiLine NoSorting TabWidth=30

H="First Heading"
/* 
********************HEADING******************** 

Project Name:

Date Started: July 14, 2019

Primary Investigator: CKA
Funding Source: none

Created by: CKA

Primary Analyst:
Secondary Analyst:

Datasets Used: NHATS

Simple Outline:


*/
 
//STATA
// Global Macros use $ symbol to be called. 

//Intermediate Data Path
global intpath "E:\nhats\data\Projects\..."

// Final Data Path
gloabl datapath "E:\nhats\data\Projects\..."

//Log files path
gloabl logpath "E:\nhats\data\Projects\..."


//SAS 


//Intermediate Data Path
//libname intpath "E:\nhats\data\Projects\..."

// Final Data Path
//libname datapath "E:\nhats\data\Projects\..."

//Log files path
//libname logpath "E:\nhats\data\Projects\..."


H="Generic template"
/*

Created by: 
Date Created:

Updated by:
Date Updated:

Description: What is going on in this section of the code? 
i.e. defining variables, labeling variables. Creating new quartiles for income based off of something....



**************************************************
*/
local date = subinstr("$S_DATE"," ","_",.) 
local name @INSERTNAME_`date'
di "`name'"

capture log close 
clear all

set more off
version 12
set linesize 80


cd `datapath'
log using `name'.smcl, text replace


.
.
.
.
.
.
.
.




log close
translate `name'.smcl `name'.pdf
exit



H="****RUN BELOW SECTIONS ONCE****"


H="making race var file"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
keep spid race_cat
by spid, sort: gen pid=_n
keep if pid==1
keep spid race_cat
rename spid bene_id
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\race var.dta"


H="making sex var"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
keep spid female
by spid, sort: gen pid=_n
keep if pid==1
keep spid female
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\female var.dta"

H="making other nhats vars"
use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta" 
foreach var of varlist income_quart res_care education livealone metro_ind nhres medicaid sr_numconditions1 dem_3_cat adl_index adl_impair prob_dem {
tab `var' lml_ivw_yes, m
}

foreach var of varlist income_quart metro_ind education dem_3_cat prob_dem {
sort spid wave
by spid, sort: replace `var'=`var'[_n-1] if `var'==.
}
keep if lml_ivw_yes==1
keep spid income_quart education  metro_ind nhres  memory  adl_index adl_impair dem_3_cat prob_dem 

save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\other nhats vars.dta", replace


H="makinghrr_numyear_MA do file"

*merge all zip_hrr files by year into one master
use "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2011.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2012.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2013.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2014.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2015.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2016.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_2017.dta" 

save "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_all years.dta", replace

clear
*merge all fips penetration files by year
use "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2011.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2012.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2013.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2014.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2015.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2016.dta" 
append using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_2017.dta" 
save "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_all years.dta", replace

*assign every zip the penetration of the county they are in
use "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip fips.dta" 
destring zipcode, replace
save "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip fips.dta", replace

merge 1:m fips using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_all years.dta"
use "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_all years.dta"

*match each zip by year to a county. use files from 2019 and 2010 due to some changes
use "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_hrr_all years.dta"
sort zipcode year
merge m:1 zipcode using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip fips.dta" 
rename _merge merge1
merge m:1 zipcode using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip fips_2010.dta"
destring fips, replace
destring fips_2010, replace
replace fips=fips_2010 if fips==.
count if fips==.
drop _merge fips_2010 merge1

*merge in the total population data by zip
drop _merge
merge m:1 zipcode using  "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\zip_popover 65_v2.dta" 
replace number_65up=pop_over65 if number_65up==. & pop_over65!=.

*merge in zip to HRR
drop _merge
merge m:1 fips year using "C:\Users\ankudc01\Desktop\MA TM EOL_hrr files\fips_penetration_all years.dta" 

*putting it all together
drop if hrrnum==.

*make pop weights for zip codes in hrr
sort hrrnum year zipcode
by hrrnum year: egen totalpop=total(number_65up)
gen weight=number_65up/totalpop

*make a weighted penetration by HRR
*first, take the % of penetration
replace penetration=substr(penetration, 1, length(penetration)-1)
destring penetration, replace

*make weighted penetration
by hrrnum year: egen avg_MA= total(penetration*weight)

*make a variable to count obs by hrr and year
sort hrrnum year zipcode
by hrrnum year: gen count=_n


keep if count==1
drop zipcode fips number_65up totalpop weight penetration


H="merging in new weight for 2015 to nhats file"
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\raw_w1_w8.dta", clear
merge 1:1 spid using "D:\NHATS\Shared\raw\NHATS\NHATS Public\round_5\NHATS_Round_5_SP_File.dta", keepusing(w5an2011wgt0)
drop _merge
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\raw_w1_w8.dta", replace

H="****RUN BELOW EVERY TIME****"


H="build data set step 1: nhats"
*step 1: this starts with raw nhats and makes an "nhats only" file to be merged with the medicare and other nhats data
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\raw_w1_w8.dta", clear


 
*** This is for wave 2 ***********************


gen family_friend_resp8 = . 
replace family_friend_resp8 =1 if is8prxyrelat >=1 & is8prxyrelat <=29 | is8prxyrelat==32
replace family_friend_resp8 =0 if is8prxyrelat == 30|is8prxyrelat == 31| is8prxyrelat==37| is8prxyrelat==39| is8prxyrelat==40
replace family_friend_resp8 = 1 if is8prxyrelat==33|is8prxyrelat==34|is8prxyrelat==35|is8prxyrelat==36|is8prxyrelat==38 
replace family_friend_resp8 = 1 if is8prxyrelat==91|is8prxyrelat==92
replace family_friend_resp8 = 0 if is8famrrutin ==3|is8famrrutin ==4
replace family_friend_resp8 = . if r8dlmlint !=1


gen family_friend_resp7 = . 
replace family_friend_resp7 =1 if is7prxyrelat >=1 & is7prxyrelat <=29 | is7prxyrelat==32
replace family_friend_resp7 =0 if is7prxyrelat == 30|is7prxyrelat == 31| is7prxyrelat==37| is7prxyrelat==39| is7prxyrelat==40
replace family_friend_resp7 = 1 if is7prxyrelat==33|is7prxyrelat==34|is7prxyrelat==35|is7prxyrelat==36|is7prxyrelat==38 
replace family_friend_resp7 = 1 if is7prxyrelat==91|is7prxyrelat==92
replace family_friend_resp7 = 0 if is7famrrutin ==3|is7famrrutin ==4
replace family_friend_resp7 = . if r7dlmlint !=1

gen family_friend_resp6 = . 
replace family_friend_resp6 =1 if is6prxyrelat >=1 & is6prxyrelat <=29 | is6prxyrelat==32
replace family_friend_resp6 =0 if is6prxyrelat == 30|is6prxyrelat == 31| is6prxyrelat==37|is6prxyrelat==39| is6prxyrelat==40
replace family_friend_resp6 = 1 if is6prxyrelat==33|is6prxyrelat==34|is6prxyrelat==35|is6prxyrelat==36|is6prxyrelat==38 
replace family_friend_resp6 = 1 if is6prxyrelat==91|is6prxyrelat==92
replace family_friend_resp6 = 0 if is6famrrutin ==3|is6famrrutin ==4
replace family_friend_resp6 = . if r6dlmlint !=1


gen family_friend_resp5 = . 
replace family_friend_resp5 =1 if is5prxyrelat >=1 & is5prxyrelat <=29 | is5prxyrelat==32
replace family_friend_resp5 =0 if is5prxyrelat == 30|is5prxyrelat == 31| is5prxyrelat==37| is5prxyrelat==39| is5prxyrelat==40
replace family_friend_resp5 = 1 if is5prxyrelat==33|is5prxyrelat==34|is5prxyrelat==35|is5prxyrelat==36|is5prxyrelat==38 
replace family_friend_resp5 = 1 if is5prxyrelat==91|is5prxyrelat==92
replace family_friend_resp5 = 0 if is5famrrutin ==3|is5famrrutin ==4
replace family_friend_resp5 = . if r5dlmlint !=1

gen family_friend_resp4 = . 
replace family_friend_resp4 =1 if is4prxyrelat >=1 & is4prxyrelat <=29 | is4prxyrelat==32
replace family_friend_resp4 =0 if is4prxyrelat == 30|is4prxyrelat == 31| is4prxyrelat==37| is4prxyrelat==39| is4prxyrelat==40
replace family_friend_resp4 = 1 if is4prxyrelat==33|is4prxyrelat==34|is4prxyrelat==35|is4prxyrelat==36|is4prxyrelat==38 
replace family_friend_resp4 = 1 if is4prxyrelat==91|is4prxyrelat==92
replace family_friend_resp4 = 0 if is4famrrutin ==3|is4famrrutin ==4
replace family_friend_resp4 = . if r4dlmlint !=1

gen family_friend_resp3 = . 
replace family_friend_resp3 =1 if is3prxyrelat >=1 & is3prxyrelat <=29 | is3prxyrelat==32
replace family_friend_resp3 =0 if is3prxyrelat == 30|is3prxyrelat == 31| is3prxyrelat==37|is3prxyrelat==39| is3prxyrelat==40
replace family_friend_resp3 = 1 if is3prxyrelat==33|is3prxyrelat==34|is3prxyrelat==35|is3prxyrelat==36|is3prxyrelat==38 
replace family_friend_resp3 = 1 if is3prxyrelat==91|is3prxyrelat==92
replace family_friend_resp3 = 0 if is3famrrutin ==3|is3famrrutin ==4
replace family_friend_resp3 = . if r3dlmlint !=1

gen family_friend_resp = . 
replace family_friend_resp =1 if is2prxyrelat >=1 & is2prxyrelat <=29 | is2prxyrelat==32
replace family_friend_resp =0 if is2prxyrelat == 30|is2prxyrelat == 31| is2prxyrelat==37| is2prxyrelat==39| is2prxyrelat==40
replace family_friend_resp = 1 if is2prxyrelat==33|is2prxyrelat==34|is2prxyrelat==35|is2prxyrelat==36|is2prxyrelat==38 
replace family_friend_resp = 1 if is2prxyrelat==91|is2prxyrelat==92
replace family_friend_resp = 0 if is2famrrutin ==3|is2famrrutin ==4
replace family_friend_resp = . if r2dlmlint !=1





 gen wave_nhat=0
 replace wave_nhat = 2 if r2dresid==6 
 replace wave_nhat = 3 if r3dresid==6 
 replace wave_nhat = 4 if r4dresid==6 
 replace wave_nhat = 5 if r5dresid==6
 replace wave_nhat = 6 if r6dresid==6
 replace wave_nhat = 7 if r7dresid==6
 replace wave_nhat = 8 if r8dresid==6

 
 *** NOTE this programming in error - problem with merge with Rl1dracehisp ******
** Note they are sampling with replacement for file has 12,427 with decedents all having Race 
/*
gen black = 0 if rl1dracehisp != . 
replace black = 1 if rl1dracehisp ==2 */
********************************************** see fix with race variable ********


gen site_of_death2 = . 
replace site_of_death2 = 1 if pd2placedied ==1
replace site_of_death2 = 2 if pd2placedied ==2
replace site_of_death2 = 3 if pd2placedied ==3
replace site_of_death2 = 4 if pd2placedied ==4
replace site_of_death2 = 5 if pd2placedied ==5
replace site_of_death2 = 5 if pd2placedied ==91

gen site_of_death3 = . 
replace site_of_death3 = 1 if pd3placedied ==1
replace site_of_death3 = 2 if pd3placedied ==2
replace site_of_death3 = 3 if pd3placedied ==3
replace site_of_death3 = 4 if pd3placedied ==4
replace site_of_death3 = 5 if pd3placedied ==5
replace site_of_death3 = 5 if pd3placedied ==91


gen site_of_death4 = . 
replace site_of_death4 = 1 if pd4placedied ==1
replace site_of_death4 = 2 if pd4placedied ==2
replace site_of_death4 = 3 if pd4placedied ==3
replace site_of_death4 = 4 if pd4placedied ==4
replace site_of_death4 = 5 if pd4placedied ==5
replace site_of_death4 = 5 if pd4placedied ==91

gen site_of_death5 = . 
replace site_of_death5 = 1 if pd5placedied ==1
replace site_of_death5 = 2 if pd5placedied ==2
replace site_of_death5 = 3 if pd5placedied ==3
replace site_of_death5 = 4 if pd5placedied ==4
replace site_of_death5 = 5 if pd5placedied ==5
replace site_of_death5 = 5 if pd5placedied ==91

gen site_of_death6 = . 
replace site_of_death6 = 1 if pd6placedied ==1
replace site_of_death6 = 2 if pd6placedied ==2
replace site_of_death6 = 3 if pd6placedied ==3
replace site_of_death6 = 4 if pd6placedied ==4
replace site_of_death6 = 5 if pd6placedied ==5
replace site_of_death6 = 5 if pd6placedied ==91

gen site_of_death7 = . 
replace site_of_death7 = 1 if pd7placedied ==1
replace site_of_death7 = 2 if pd7placedied ==2
replace site_of_death7 = 3 if pd7placedied ==3
replace site_of_death7 = 4 if pd7placedied ==4
replace site_of_death7 = 5 if pd7placedied ==5
replace site_of_death7 = 5 if pd7placedied ==91

gen site_of_death8 = . 
replace site_of_death8 = 1 if pd8placedied ==1
replace site_of_death8 = 2 if pd8placedied ==2
replace site_of_death8 = 3 if pd8placedied ==3
replace site_of_death8 = 4 if pd8placedied ==4
replace site_of_death8 = 5 if pd8placedied ==5
replace site_of_death8 = 5 if pd8placedied ==91


label define sod2 5 "other" 4 "hospice ipu" 3 "nh" 2 "hospital" 1 "home" 
label values site_of_death3 sod2 
label values site_of_death2 sod2 
label values site_of_death4 sod2
label values site_of_death5 sod2
label values site_of_death6 sod2
label values site_of_death7 sod2
label values site_of_death8 sod2


**Generate site_of_death_w2w3w4w5w76 variable
**1=died at home, 2=died in hospital other unit/ED/don't know, 3=ICU, 4=palliative care unit
**5=inpatient hospice unit, 6=NH, 7=hospice residence, 8=in transit, 9=other

gen site_of_death_w2w8 = . 
replace site_of_death_w2w8 = 1 if pd2placedied ==1
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==5
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==4
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==-8
replace site_of_death_w2w8 = 2 if pd2placedied ==2 & pd2hospdied ==1
replace site_of_death_w2w8 = 3 if pd2placedied ==2 & pd2hospdied ==1
replace site_of_death_w2w8 = 4 if pd2placedied ==2 & pd2hospdied ==2
replace site_of_death_w2w8 = 5 if pd2placedied ==2 & pd2hospdied ==3
replace site_of_death_w2w8 = 6 if pd2placedied ==3
replace site_of_death_w2w8 = 7 if pd2placedied ==4
replace site_of_death_w2w8 = 8 if pd2placedied ==5
replace site_of_death_w2w8 = 9 if pd2placedied ==91

replace site_of_death_w2w8 = 1 if pd3placedied ==1
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==5
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==4
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd2hospdied ==-8
replace site_of_death_w2w8 = 2 if pd3placedied ==2 & pd3hospdied ==1
replace site_of_death_w2w8 = 3 if pd3placedied ==2 & pd3hospdied ==1
replace site_of_death_w2w8 = 4 if pd3placedied ==2 & pd3hospdied ==2
replace site_of_death_w2w8 = 5 if pd3placedied ==2 & pd3hospdied ==3
replace site_of_death_w2w8 = 6 if pd3placedied ==3
replace site_of_death_w2w8 = 7 if pd3placedied ==4
replace site_of_death_w2w8 = 8 if pd3placedied ==5
replace site_of_death_w2w8 = 9 if pd3placedied ==91

replace site_of_death_w2w8 = 1 if pd4placedied ==1
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==5
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==4
replace site_of_death_w2w8 = 2 if pd4placedied ==2 & pd4hospdied ==-8
replace site_of_death_w2w8 = 3 if pd4placedied ==2 & pd4hospdied ==1
replace site_of_death_w2w8 = 4 if pd4placedied ==2 & pd4hospdied ==2
replace site_of_death_w2w8 = 5 if pd4placedied ==2 & pd4hospdied ==3
replace site_of_death_w2w8 = 6 if pd4placedied ==3
replace site_of_death_w2w8 = 7 if pd4placedied ==4
replace site_of_death_w2w8 = 8 if pd4placedied ==5
replace site_of_death_w2w8 = 9 if pd4placedied ==91

replace site_of_death_w2w8 = 1 if pd5placedied ==1
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==5
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==4
replace site_of_death_w2w8 = 2 if pd5placedied ==2 & pd5hospdied ==-8
replace site_of_death_w2w8 = 3 if pd5placedied ==2 & pd5hospdied ==1
replace site_of_death_w2w8 = 4 if pd5placedied ==2 & pd5hospdied ==2
replace site_of_death_w2w8 = 5 if pd5placedied ==2 & pd5hospdied ==3
replace site_of_death_w2w8 = 6 if pd5placedied ==3
replace site_of_death_w2w8 = 7 if pd5placedied ==4
replace site_of_death_w2w8 = 8 if pd5placedied ==5
replace site_of_death_w2w8 = 9 if pd5placedied ==91

replace site_of_death_w2w8 = 1 if pd6placedied ==1
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==5
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==4
replace site_of_death_w2w8 = 2 if pd6placedied ==2 & pd6hospdied ==-8
replace site_of_death_w2w8 = 3 if pd6placedied ==2 & pd6hospdied ==1
replace site_of_death_w2w8 = 4 if pd6placedied ==2 & pd6hospdied ==2
replace site_of_death_w2w8 = 5 if pd6placedied ==2 & pd6hospdied ==3
replace site_of_death_w2w8 = 6 if pd6placedied ==3
replace site_of_death_w2w8 = 7 if pd6placedied ==4
replace site_of_death_w2w8 = 8 if pd6placedied ==5
replace site_of_death_w2w8 = 9 if pd6placedied ==91

replace site_of_death_w2w8 = 1 if pd7placedied ==1
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==5
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==4
replace site_of_death_w2w8 = 2 if pd7placedied ==2 & pd7hospdied ==-8
replace site_of_death_w2w8 = 3 if pd7placedied ==2 & pd7hospdied ==1
replace site_of_death_w2w8 = 4 if pd7placedied ==2 & pd7hospdied ==2
replace site_of_death_w2w8 = 5 if pd7placedied ==2 & pd7hospdied ==3
replace site_of_death_w2w8 = 6 if pd7placedied ==3
replace site_of_death_w2w8 = 7 if pd7placedied ==4
replace site_of_death_w2w8 = 8 if pd7placedied ==5
replace site_of_death_w2w8 = 9 if pd7placedied ==91

replace site_of_death_w2w8 = 1 if pd8placedied ==1
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==5
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==4
replace site_of_death_w2w8 = 2 if pd8placedied ==2 & pd8hospdied ==-8
replace site_of_death_w2w8 = 3 if pd8placedied ==2 & pd8hospdied ==1
replace site_of_death_w2w8 = 4 if pd8placedied ==2 & pd8hospdied ==2
replace site_of_death_w2w8 = 5 if pd8placedied ==2 & pd8hospdied ==3
replace site_of_death_w2w8 = 6 if pd8placedied ==3
replace site_of_death_w2w8 = 7 if pd8placedied ==4
replace site_of_death_w2w8 = 8 if pd8placedied ==5
replace site_of_death_w2w8 = 9 if pd8placedied ==91


**Genrate variable of place living prior to death, 1=at SPs home, 2=hospital, 3=NH, 91=other

gen site_pre_death = 0 if r2dresid ==6| r3dresid ==6| r4dresid ==6|r5dresid==6 |r6dresid==6 |r7dresid==6 |r8dresid==6
replace site_pre_death = pd2placepre if r2dresid==6
replace site_pre_death = pd3placepre if r3dresid==6
replace site_pre_death = pd4placepre if r4dresid==6
replace site_pre_death = pd5placepre if r5dresid==6
replace site_pre_death = pd6placepre if r6dresid==6
replace site_pre_death = pd7placepre if r7dresid==6
replace site_pre_death = pd8placepre if r8dresid==6

					   
*************** run this once there is a merge *************


label define sodw2w6 9 "other" 8 "in transit" 7 "hospice residence" 6  " nursing home" 5 "hospice IPU" 4 "palliative care unit in hospital" 3 "ICU" 2 "hospital" 1 "home" 
label values site_of_death_w2w8 sodw2w6

  
  /*** modification of Vicki to account for the problem with weights 
  
           ***************************************************
           
           1. Restrict both samples to persons residing in the community prior to terminal events 
           2. get all the names of weights. strata, and sampling unit
           3. Create a common set of variables 
  

           
*** Programing to create the NHATs data set */




gen had_pain3 = lm3pain
gen had_pain2 = lm2pain
gen had_pain4 = lm4pain
gen had_pain5 = lm5pain
gen had_pain6 = lm6pain
gen had_pain7 = lm7pain
gen had_pain8 = lm8pain

*pain

gen unmet_pain2 = . 
replace unmet_pain2 = 1 if lm2painhlp==2 
replace unmet_pain2 =1 if lm2painhlpam ==1
replace unmet_pain2 =1 if lm2painhlpam ==2
replace unmet_pain2 =0 if lm2painhlpam ==3 

gen unmet_pain3 = . 
replace unmet_pain3 = 1 if lm3painhlp==2 
replace unmet_pain3 =1 if lm3painhlpam ==1
replace unmet_pain3 =1 if lm3painhlpam ==2
replace unmet_pain3 =0 if lm3painhlpam ==3 

gen unmet_pain4 = . 
replace unmet_pain4 = 1 if lm4painhlp==2 
replace unmet_pain4 =1 if lm4painhlpam ==1
replace unmet_pain4 =1 if lm4painhlpam ==2
replace unmet_pain4 =0 if lm4painhlpam ==3 

gen unmet_pain5 = . 
replace unmet_pain5 = 1 if lm5painhlp==2 
replace unmet_pain5 =1 if lm5painhlpam ==1
replace unmet_pain5 =1 if lm5painhlpam ==2
replace unmet_pain5 =0 if lm5painhlpam ==3 

gen unmet_pain6 = . 
replace unmet_pain6 =1 if lm6painhlp==2 
replace unmet_pain6 =1 if lm6painhlpam ==1
replace unmet_pain6 =1 if lm6painhlpam ==2
replace unmet_pain6 =0 if lm6painhlpam ==3 

gen unmet_pain7 = . 
replace unmet_pain7 =1 if lm7painhlp==2 
replace unmet_pain7 =1 if lm7painhlpam ==1
replace unmet_pain7 =1 if lm7painhlpam ==2
replace unmet_pain7 =0 if lm7painhlpam ==3 

gen unmet_pain8 = . 
replace unmet_pain8 =1 if lm8painhlp==2 
replace unmet_pain8 =1 if lm8painhlpam ==1
replace unmet_pain8 =1 if lm8painhlpam ==2
replace unmet_pain8 =0 if lm8painhlpam ==3 

*breathlessness
gen had_bre2 = lm2bre 
gen unmet_bre2 = . 
replace unmet_bre2 = 1 if lm2brehlp==2 
replace unmet_bre2 =1 if lm2brehlpam ==1
replace unmet_bre2 =1 if lm2brehlpam ==2
replace unmet_bre2 =0 if lm2brehlpam ==3

gen had_bre3 = lm3bre 
gen unmet_bre3 = . 
replace unmet_bre3 = 1 if lm3brehlp==2 
replace unmet_bre3 =1 if lm3brehlpam ==1
replace unmet_bre3 =1 if lm3brehlpam ==2
replace unmet_bre3 =0 if lm3brehlpam ==3

gen had_bre4 = lm4bre 
gen unmet_bre4 = . 
replace unmet_bre4 = 1 if lm4brehlp==2 
replace unmet_bre4 =1 if lm4brehlpam ==1
replace unmet_bre4 =1 if lm4brehlpam ==2
replace unmet_bre4 =0 if lm4brehlpam ==3

gen had_bre5 = lm5bre 
gen unmet_bre5 = . 
replace unmet_bre5 = 1 if lm5brehlp==2 
replace unmet_bre5 =1 if lm5brehlpam ==1
replace unmet_bre5 =1 if lm5brehlpam ==2
replace unmet_bre5 =0 if lm5brehlpam ==3

gen had_bre6 = lm6bre 
gen unmet_bre6 = . 
replace unmet_bre6 =1 if lm6brehlp==2 
replace unmet_bre6 =1 if lm6brehlpam ==1
replace unmet_bre6 =1 if lm6brehlpam ==2
replace unmet_bre6 =0 if lm6brehlpam ==3

gen had_bre7 = lm7bre 
gen unmet_bre7 = . 
replace unmet_bre7 =1 if lm7brehlp==2 
replace unmet_bre7 =1 if lm7brehlpam ==1
replace unmet_bre7 =1 if lm7brehlpam ==2
replace unmet_bre7 =0 if lm7brehlpam ==3

gen had_bre8 = lm8bre 
gen unmet_bre8 = . 
replace unmet_bre8 =1 if lm8brehlp==2 
replace unmet_bre8 =1 if lm8brehlpam ==1
replace unmet_bre8 =1 if lm8brehlpam ==2
replace unmet_bre8 =0 if lm8brehlpam ==3

*sad or anxious

gen had_sad2 = lm2sad 
gen unmet_sad2 = . 
replace unmet_sad2 = 1 if lm2sadhlp==2 
replace unmet_sad2 =1 if lm2sadhlpam ==1
replace unmet_sad2 =1 if lm2sadhlpam ==2
replace unmet_sad2 =0 if lm2sadhlpam ==3

gen had_sad3 = lm3sad 
gen unmet_sad3 = . 
replace unmet_sad3 = 1 if lm3sadhlp==2 
replace unmet_sad3 =1 if lm3sadhlpam ==1
replace unmet_sad3 =1 if lm3sadhlpam ==2
replace unmet_sad3 =0 if lm3sadhlpam ==3

gen had_sad4 = lm4sad 
gen unmet_sad4 = . 
replace unmet_sad4 = 1 if lm4sadhlp==2 
replace unmet_sad4 =1 if lm4sadhlpam ==1
replace unmet_sad4 =1 if lm4sadhlpam ==2
replace unmet_sad4 =0 if lm4sadhlpam ==3

gen had_sad5 = lm5sad 
gen unmet_sad5 = . 
replace unmet_sad5 = 1 if lm5sadhlp==2 
replace unmet_sad5 =1 if lm5sadhlpam ==1
replace unmet_sad5 =1 if lm5sadhlpam ==2
replace unmet_sad5 =0 if lm5sadhlpam ==3

gen had_sad6 = lm6sad 
gen unmet_sad6 = . 
replace unmet_sad6 =1 if lm6sadhlp==2 
replace unmet_sad6 =1 if lm6sadhlpam ==1
replace unmet_sad6 =1 if lm6sadhlpam ==2
replace unmet_sad6 =0 if lm6sadhlpam ==3

gen had_sad7 = lm7sad 
gen unmet_sad7 = . 
replace unmet_sad7 =1 if lm7sadhlp==2 
replace unmet_sad7 =1 if lm7sadhlpam ==1
replace unmet_sad7 =1 if lm7sadhlpam ==2
replace unmet_sad7 =0 if lm7sadhlpam ==3

gen had_sad8 = lm8sad 
gen unmet_sad8 = . 
replace unmet_sad8 =1 if lm8sadhlp==2 
replace unmet_sad8 =1 if lm8sadhlpam ==1
replace unmet_sad8 =1 if lm8sadhlpam ==2
replace unmet_sad8 =0 if lm8sadhlpam ==3

*care decisions/respect/etc
gen care_decision2 = lm2caredecis
gen care_decision3 = lm3caredecis
gen care_decision4 = lm4caredecis
gen care_decision5 = lm5caredecis
gen care_decision6 = lm6caredecis
gen care_decision7 = lm7caredecis
gen care_decision8 = lm8caredecis


gen care_notwant2 = lm2carenowan 
gen care_notwant3 = lm3carenowan 
gen care_notwant4 = lm4carenowan 
gen care_notwant5 = lm5carenowan 
gen care_notwant6 = lm6carenowan
gen care_notwant7 = lm7carenowan
gen care_notwant8 = lm8carenowan


gen always_respect2 = lm2respect 
gen always_respect3 = lm3respect 
gen always_respect4 = lm4respect 
gen always_respect5 = lm5respect 
gen always_respect6 = lm6respect
gen always_respect7 = lm7respect
gen always_respect8 = lm8respect


gen informed2 = lm2informed 
gen informed3 = lm3informed 
gen informed4 = lm4informed 
gen informed5 = lm5informed 
gen informed6 = lm6informed
gen informed7 = lm7informed
gen informed8 = lm8informed


gen more_than_one_md2 = lm2doctor
gen more_than_one_md3 = lm3doctor
gen more_than_one_md4 = lm4doctor
gen more_than_one_md5 = lm5doctor
gen more_than_one_md6 = lm6doctor
gen more_than_one_md7 = lm7doctor
gen more_than_one_md8 = lm8doctor


gen md_in_charge2 = lm2docclear 
gen md_in_charge3 = lm3docclear 
gen md_in_charge4 = lm4docclear 
gen md_in_charge5 = lm5docclear 
gen md_in_charge6 = lm6docclear
gen md_in_charge7 = lm7docclear
gen md_in_charge8 = lm8docclear


gen overall_rate2 = lm2ratecare 
gen overall_rate3 = lm3ratecare 
gen overall_rate4 = lm4ratecare 
gen overall_rate5 = lm5ratecare 
gen overall_rate6 = lm6ratecare
gen overall_rate7 = lm7ratecare
gen overall_rate8 = lm8ratecare

*religious needs
gen unmet_relig2 = . 
replace unmet_relig2 = 1 if lm2relg == 2 
replace unmet_relig2 = 1 if lm2relgamt == 2 
replace unmet_relig2 = 0 if lm2relgamt==1 

gen unmet_relig3 = . 
replace unmet_relig3 = 1 if lm3relg == 2 
replace unmet_relig3 = 1 if lm3relgamt == 2 
replace unmet_relig3 = 0 if lm3relgamt==1 

gen unmet_relig4 = . 
replace unmet_relig4 = 1 if lm4relg == 2 
replace unmet_relig4 = 1 if lm4relgamt == 2 
replace unmet_relig4 = 0 if lm4relgamt==1 

gen unmet_relig5 = . 
replace unmet_relig5 = 1 if lm5relg == 2 
replace unmet_relig5 = 1 if lm5relgamt == 2 
replace unmet_relig5 = 0 if lm5relgamt==1 

gen unmet_relig6 = . 
replace unmet_relig6 = 1 if lm6relg == 2 
replace unmet_relig6 = 1 if lm6relgamt == 2 
replace unmet_relig6 = 0 if lm6relgamt==1 

gen unmet_relig7 = . 
replace unmet_relig7 = 1 if lm7relg == 2 
replace unmet_relig7 = 1 if lm7relgamt == 2 
replace unmet_relig7 = 0 if lm7relgamt==1 

gen unmet_relig8 = . 
replace unmet_relig8 = 1 if lm8relg == 2 
replace unmet_relig8 = 1 if lm8relgamt == 2 
replace unmet_relig8 = 0 if lm8relgamt==1 

gen sunit2= w2varunit
gen sunit3= w3varunit
gen sunit4= w4varunit
gen sunit5= w5varunit
gen sunit6= w6varunit
gen sunit7= w7varunit
gen sunit8= w8varunit


gen pweight2 = w2anfinwgt0
gen pweight3 = w3anfinwgt0
gen pweight4 = w4anfinwgt0
gen pweight5 = w5an2011wgt0
gen pweight6 = w6anfinwgt0
gen pweight7 = w7anfinwgt0
gen pweight8 = w8anfinwgt0


gen strata2 = w2varstrat
gen strata3 = w3varstrat
gen strata4 = w4varstrat
gen strata5 = w5varstrat
gen strata6 = w6varstrat
gen strata7 = w7varstrat
gen strata8 = w8varstrat


gen nhat_w2w8 = . 

replace nhat_w2w8 = 1 if pd2placedied != -1 & family_friend_resp==1 & r2dresid==6 
replace nhat_w2w8 = 1 if pd3placedied != -1 & family_friend_resp3 ==1 & r3dresid ==6
replace nhat_w2w8 = 1 if pd4placedied != -1 & family_friend_resp4 ==1 & r4dresid ==6
replace nhat_w2w8 = 1 if pd5placedied != -1 & family_friend_resp5 ==1 & r5dresid ==6
replace nhat_w2w8 = 1 if pd6placedied != -1 & family_friend_resp6 ==1 & r6dresid ==6
replace nhat_w2w8 = 1 if pd7placedied != -1 & family_friend_resp7 ==1 & r7dresid ==6
replace nhat_w2w8 = 1 if pd8placedied != -1 & family_friend_resp8 ==1 & r8dresid ==6

************************************************************************


** spouse race cancer age bedbound in the last month 

**Generate variable spouse=1 if proxy is a spouse
 
gen spouse = 0 
replace spouse = 1 if is2prxyrelat ==2
replace spouse = 1 if is3prxyrelat ==2 
replace spouse = 1 if is4prxyrelat ==2 
replace spouse = 1 if is5prxyrelat ==2 
replace spouse = 1 if is6prxyrelat ==2 
replace spouse = 1 if is7prxyrelat ==2 
replace spouse = 1 if is8prxyrelat ==2 


**Generate variable child = 1 if proxy is a child

gen child = 0 
replace child = 1 if is2prxyrelat >=3 & is2prxyrelat <=6
replace child = 1 if is3prxyrelat >=3 & is3prxyrelat <=6
replace child = 1 if is4prxyrelat >=3 & is4prxyrelat <=6
replace child = 1 if is5prxyrelat >=3 & is5prxyrelat <=6
replace child = 1 if is6prxyrelat >=3 & is6prxyrelat <=6
replace child = 1 if is7prxyrelat >=3 & is7prxyrelat <=6
replace child = 1 if is8prxyrelat >=3 & is8prxyrelat <=6

**Generate other_family=1 if proxy is anothr family member besides child or spouse

gen other_family = 0 
replace other_family = 1 if is2prxyrelat >=7 & is2prxyrelat <=29
replace other_family = 1 if is3prxyrelat >=7 & is3prxyrelat <=29
replace other_family = 1 if is4prxyrelat >=7 & is4prxyrelat <=29
replace other_family = 1 if is5prxyrelat >=7 & is5prxyrelat <=29
replace other_family = 1 if is6prxyrelat >=7 & is6prxyrelat <=29
replace other_family = 1 if is7prxyrelat >=7 & is7prxyrelat <=29
replace other_family = 1 if is8prxyrelat >=7 & is8prxyrelat <=29

*Generate other_friend=1 if proxy is a friend/non-family member

gen other_friend = 0 
replace other_friend = 1 if is2prxyrelat >=30 & is2prxyrelat <=92
replace other_friend = 1 if is3prxyrelat >=30 & is3prxyrelat <=92
replace other_friend = 1 if is4prxyrelat >=30 & is4prxyrelat <=92
replace other_friend = 1 if is5prxyrelat >=30 & is5prxyrelat <=92
replace other_friend = 1 if is6prxyrelat >=30 & is6prxyrelat <=92
replace other_friend = 1 if is7prxyrelat >=30 & is7prxyrelat <=92
replace other_friend = 1 if is8prxyrelat >=30 & is8prxyrelat <=92
 
 
**Generate deathage_cat variable for decedent age at death
**1=65-69, 2=70-74, 3=75-79, 4=80-84, 5=85-89, 6=90+ 
 
gen deathage_cat = r2d2deathage 

replace deathage_cat = 1 if r3d2deathage ==1
replace deathage_cat = 2 if r3d2deathage ==2
replace deathage_cat = 3 if r3d2deathage ==3
replace deathage_cat = 4 if r3d2deathage ==4
replace deathage_cat = 5 if r3d2deathage ==5
replace deathage_cat = 6 if r3d2deathage ==6

replace deathage_cat = 1 if r4d2deathage ==1
replace deathage_cat = 2 if r4d2deathage ==2
replace deathage_cat = 3 if r4d2deathage ==3
replace deathage_cat = 4 if r4d2deathage ==4
replace deathage_cat = 5 if r4d2deathage ==5
replace deathage_cat = 6 if r4d2deathage ==6

replace deathage_cat = 1 if r5d2deathage ==1
replace deathage_cat = 2 if r5d2deathage ==2
replace deathage_cat = 3 if r5d2deathage ==3
replace deathage_cat = 4 if r5d2deathage ==4
replace deathage_cat = 5 if r5d2deathage ==5
replace deathage_cat = 6 if r5d2deathage ==6

replace deathage_cat = 1 if r6d2deathage ==1
replace deathage_cat = 2 if r6d2deathage ==2
replace deathage_cat = 3 if r6d2deathage ==3
replace deathage_cat = 4 if r6d2deathage ==4
replace deathage_cat = 5 if r6d2deathage ==5
replace deathage_cat = 6 if r6d2deathage ==6

replace deathage_cat = 1 if r7d2deathage ==1
replace deathage_cat = 2 if r7d2deathage ==2
replace deathage_cat = 3 if r7d2deathage ==3
replace deathage_cat = 4 if r7d2deathage ==4
replace deathage_cat = 5 if r7d2deathage ==5
replace deathage_cat = 6 if r7d2deathage ==6

replace deathage_cat = 1 if r8d2deathage ==1
replace deathage_cat = 2 if r8d2deathage ==2
replace deathage_cat = 3 if r8d2deathage ==3
replace deathage_cat = 4 if r8d2deathage ==4
replace deathage_cat = 5 if r8d2deathage ==5
replace deathage_cat = 6 if r8d2deathage ==6
**1=65-69, 2=70-74, 3=75-79, 4=80-84, 5=85-89, 6=90+ 

label define agecat 1 "65-69" 2 "70-74" 3 "75-79" 4 "80-84" 5 "85-89" 6 "90+"
label values deathage_cat agecat 
replace deathage_cat=. if deathage_cat==-8 | deathage_cat==-7 | deathage_cat==-1

gen diff_get_out_bed = 0 
replace diff_get_out_bed = 1 if pd2outbed >=3 & pd2outbed <=5
replace diff_get_out_bed = 1 if pd3outbed >=3 & pd3outbed <=5
replace diff_get_out_bed = 1 if pd4outbed >=3 & pd4outbed <=5
replace diff_get_out_bed = 1 if pd5outbed >=3 & pd5outbed <=5
replace diff_get_out_bed = 1 if pd6outbed >=3 & pd6outbed <=5
replace diff_get_out_bed = 1 if pd7outbed >=3 & pd7outbed <=5
replace diff_get_out_bed = 1 if pd8outbed >=3 & pd8outbed <=5


**Generate variable recode_overall_rate which is combined waves rating of care in last month of life (lm*ratecare)
** 1=excellent, 5=poor

gen recode_overall_rate = overall_rate2
replace recode_overall_rate = overall_rate3 if overall_rate2 == -1 
replace recode_overall_rate = overall_rate4 if overall_rate3 == -1 
replace recode_overall_rate = overall_rate5 if overall_rate4 == -1 
replace recode_overall_rate = overall_rate6 if overall_rate5 == -1 
replace recode_overall_rate = overall_rate7 if overall_rate6 == -1 
replace recode_overall_rate = overall_rate8 if overall_rate7 == -1 


recode recode_overall_rate (-8=.) (-7 =.) (-1=.) 

**Generate variable recode_informed, combined waves of how often family kept informed of condition
** 1= always, 4= never

gen recode_informed = informed2
replace recode_informed = informed3 if informed2 ==-1 
replace recode_informed = informed4 if informed3 ==-1 
replace recode_informed = informed5 if informed4 ==-1 
replace recode_informed = informed6 if informed5 ==-1 
replace recode_informed = informed7 if informed6 ==-1 
replace recode_informed = informed8 if informed7 ==-1 

recode recode_informed (-8=.) (-7=.) (-1=.)

gen recode_always_respect = always_respect2
replace recode_always_respect = always_respect3 if always_respect2 ==-1 
replace recode_always_respect = always_respect4 if always_respect3 ==-1 
replace recode_always_respect = always_respect5 if always_respect4 ==-1 
replace recode_always_respect = always_respect6 if always_respect5 ==-1 
replace recode_always_respect = always_respect7 if always_respect6 ==-1 
replace recode_always_respect = always_respect8 if always_respect7 ==-1 

recode recode_always_respect (-8 =.) (-7=.) (-1=.) 

**Generate variable recode_care_notwant that is combined waves whether any care received in last month
**that pt would not have wanted, 1=yes

gen recode_care_notwant = care_notwant2
replace recode_care_notwant = care_notwant3 if care_notwant2 == -1 
replace recode_care_notwant = care_notwant4 if care_notwant3 == -1 
replace recode_care_notwant = care_notwant5 if care_notwant4 == -1
replace recode_care_notwant = care_notwant6 if care_notwant5 == -1 
replace recode_care_notwant = care_notwant7 if care_notwant6 == -1 
replace recode_care_notwant = care_notwant8 if care_notwant7 == -1 
recode recode_care_notwant (-8 =.) (-7=.) (3=.) (-1=.)
recode recode_care_notwant (2=0)

**Generate variable recode_care_decision that is combined waves whether decision in last month made
**without input from pt or family, 1=yes

gen recode_care_decision = care_decision2
replace recode_care_decision = care_decision3 if care_decision2 ==-1 
replace recode_care_decision = care_decision4 if care_decision3 ==-1 
replace recode_care_decision = care_decision5 if care_decision4 ==-1 
replace recode_care_decision = care_decision6 if care_decision5 ==-1 
replace recode_care_decision = care_decision7 if care_decision6 ==-1 
replace recode_care_decision = care_decision8 if care_decision7 ==-1 

recode recode_care_decision (-8 =.) (-7=.) (-1=.) 
recode recode_care_decision (3=.)(2=0)

gen recode_had_pain = had_pain2
replace recode_had_pain = had_pain3 if had_pain2 ==-1 
replace recode_had_pain = had_pain4 if had_pain3 ==-1 
replace recode_had_pain = had_pain5 if had_pain4 ==-1 
replace recode_had_pain = had_pain6 if had_pain5 ==-1 
replace recode_had_pain = had_pain7 if had_pain6 ==-1 
replace recode_had_pain = had_pain8 if had_pain7 ==-1 

recode recode_had_pain (-8 =.) (-7=.) (-1=.) 

gen unmet_pain = unmet_pain2
replace unmet_pain = unmet_pain3 if unmet_pain2 ==. & r3dresid ==6
replace unmet_pain = unmet_pain4 if unmet_pain3 ==. & r4dresid ==6
replace unmet_pain = unmet_pain5 if unmet_pain4 ==. & r5dresid ==6
replace unmet_pain = unmet_pain6 if unmet_pain5 ==. & r6dresid ==6
replace unmet_pain = unmet_pain7 if unmet_pain6 ==. & r7dresid ==6
replace unmet_pain = unmet_pain8 if unmet_pain7 ==. & r8dresid ==6


gen unmet_bre = unmet_bre2
replace unmet_bre = unmet_bre3 if unmet_bre2 ==. & r3dresid ==6
replace unmet_bre = unmet_bre4 if unmet_bre3 ==. & r4dresid ==6
replace unmet_bre = unmet_bre5 if unmet_bre4 ==. & r5dresid ==6
replace unmet_bre = unmet_bre6 if unmet_bre5 ==. & r6dresid ==6
replace unmet_bre = unmet_bre7 if unmet_bre6 ==. & r7dresid ==6
replace unmet_bre = unmet_bre8 if unmet_bre7 ==. & r8dresid ==6


gen unmet_sad = unmet_sad2
replace unmet_sad = unmet_sad3 if unmet_sad2 ==. & r3dresid ==6
replace unmet_sad = unmet_sad4 if unmet_sad3 ==. & r4dresid ==6
replace unmet_sad = unmet_sad5 if unmet_sad4 ==. & r5dresid ==6
replace unmet_sad = unmet_sad6 if unmet_sad5 ==. & r6dresid ==6
replace unmet_sad = unmet_sad7 if unmet_sad6 ==. & r7dresid ==6
replace unmet_sad = unmet_sad8 if unmet_sad7 ==. & r8dresid ==6


gen unmet_relig = unmet_relig2
replace unmet_relig = unmet_relig3 if unmet_relig2 ==. & r3dresid ==6
replace unmet_relig = unmet_relig4 if unmet_relig3 ==. & r4dresid ==6
replace unmet_relig = unmet_relig5 if unmet_relig4 ==. & r5dresid ==6
replace unmet_relig = unmet_relig6 if unmet_relig5 ==. & r6dresid ==6
replace unmet_relig = unmet_relig7 if unmet_relig6 ==. & r7dresid ==6
replace unmet_relig = unmet_relig8 if unmet_relig7 ==. & r8dresid ==6


gen recode_had_bre = had_bre2
replace recode_had_bre = had_bre3 if had_bre2==-1 
replace recode_had_bre = had_bre4 if had_bre3==-1 
replace recode_had_bre = had_bre5 if had_bre4==-1 
replace recode_had_bre = had_bre6 if had_bre5==-1 
replace recode_had_bre = had_bre7 if had_bre6==-1 
replace recode_had_bre = had_bre8 if had_bre7==-1 

recode recode_had_bre (-8 =.) (-7=.) (-1=.) 

**Generate variable "recode_had_sad" for combined waves if pt had feelings of anxiety or sadness
**in last month of life, 1=yes

gen recode_had_sad = had_sad2
replace recode_had_sad = had_sad3 if had_sad2==-1 
replace recode_had_sad = had_sad4 if had_sad3==-1 
replace recode_had_sad = had_sad5 if had_sad4==-1 
replace recode_had_sad = had_sad6 if had_sad5==-1 
replace recode_had_sad = had_sad7 if had_sad6==-1 
replace recode_had_sad = had_sad8 if had_sad7==-1 

recode recode_had_sad (-8 =.) (-7=.) (-1=.) 


gen di_recode_always_respect = .  
replace di_recode_always_respect = 1 if recode_always_respect >=2 & recode_always_respect <=5
replace di_recode_always_respect = 0 if recode_always_respect ==1

**Generate variable di_recode_informed for not kept informed of condition (all responses other 
**than "always")

gen di_recode_informed = .  
replace di_recode_informed = 1 if recode_informed >=2 & recode_informed <=5
replace di_recode_informed  = 0 if recode_informed ==1


gen age_cat1 =0 
replace age_cat1 = deathage_cat==1
gen age_cat2 =0 
replace age_cat2 = deathage_cat==2
gen age_cat3 =0 
replace age_cat3 = deathage_cat==3
gen age_cat4 =0 
replace age_cat4 = deathage_cat==4
gen age_cat5 =0 
replace age_cat5 = deathage_cat==5
gen age_85 = 0
replace age_85 =1  if deathage_cat >=6
 
*************************************


gen resp_sex = is2prxygendr if r2dresid==6  
replace resp_sex = is3prxygendr if r3dresid==6  
replace resp_sex = is4prxygendr if r4dresid==6  
replace resp_sex = is5prxygendr if r5dresid==6 
replace resp_sex = is6prxygendr if r6dresid==6  
replace resp_sex = is7prxygendr if r7dresid==6  
replace resp_sex = is8prxygendr if r8dresid==6  
recode resp_sex (-1=.)

 

gen pweight = pweight2 
replace pweight = pweight3 if r3dresid==6
replace pweight = pweight4 if r4dresid==6 
replace pweight = pweight5 if r5dresid==6 
replace pweight = pweight6 if r6dresid==6
replace pweight = pweight7 if r7dresid==6
replace pweight = pweight8 if r8dresid==6


gen strata = strata2 
replace strata = strata3 if r3dresid==6
replace strata = strata4 if r4dresid==6
replace strata = strata5 if r5dresid==6
replace strata = strata6 if r6dresid==6
replace strata = strata7 if r7dresid==6
replace strata = strata8 if r8dresid==6

gen sunit = sunit2 
replace sunit= sunit3 if r3dresid==6
replace sunit= sunit4 if r4dresid==6
replace sunit= sunit5 if r5dresid==6
replace sunit= sunit6 if r6dresid==6
replace sunit= sunit7 if r7dresid==6
replace sunit= sunit8 if r8dresid==6


gen inanal = 0 
replace inanal = 1 if family_friend_resp ==1 & r2dresid==6
replace inanal = 1 if family_friend_resp3 ==1 & r3dresid==6
replace inanal = 1 if family_friend_resp4 ==1 & r4dresid==6
replace inanal = 1 if family_friend_resp5 ==1 & r5dresid==6
replace inanal = 1 if family_friend_resp6 ==1 & r6dresid==6
replace inanal = 1 if family_friend_resp7 ==1 & r7dresid==6
replace inanal = 1 if family_friend_resp8 ==1 & r8dresid==6

gen inanal_alldead= 0
replace inanal_alldead = 1 if r2dresid==6
replace inanal_alldead = 1 if r3dresid==6
replace inanal_alldead = 1 if r4dresid==6
replace inanal_alldead = 1 if r5dresid==6
replace inanal_alldead = 1 if r6dresid==6
replace inanal_alldead = 1 if r7dresid==6
replace inanal_alldead = 1 if r8dresid==6


gen inanal_butdontknow=0
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is2famrrutin ==3|is2famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is3famrrutin ==3|is3famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is4famrrutin ==3|is4famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is5famrrutin ==3|is5famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is6famrrutin ==3|is6famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is7famrrutin ==3|is7famrrutin ==4)
replace inanal_butdontknow = 1 if inanal_alldead==1 & (is8famrrutin ==3|is8famrrutin ==4)


svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

****

gen hosp_last_month = . 
replace hosp_last_month = 1 if pd3hospcelml ==1 |pd4hospcelml ==1 |pd5hospcelml ==1 |pd6hospcelml ==1 |pd7hospcelml ==1 |pd8hospcelml ==1
replace hosp_last_month = 0 if pd3hospcelml ==2 |pd4hospcelml ==2 |pd5hospcelml ==2 |pd6hospcelml ==2 |pd7hospcelml ==2 |pd8hospcelml ==2



** create disease categories 


gen mi_all = 0 
replace mi_all = 1 if  mi_1==1 & family_friend_resp ==1 & r2dresid==6
replace mi_all = 1 if  mi_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace mi_all = 1 if  mi_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace mi_all = 1 if  mi_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace mi_all = 1 if  mi_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace mi_all = 1 if  mi_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace mi_all = 1 if  mi_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen dm_all = 0 
replace dm_all = 1 if  dm_1==1 & family_friend_resp ==1 & r2dresid==6
replace dm_all = 1 if  dm_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace dm_all = 1 if  dm_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace dm_all = 1 if  dm_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace dm_all = 1 if  dm_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace dm_all = 1 if  dm_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace dm_all = 1 if  dm_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen lung_all = 0 
replace lung_all = 1 if  lung_1==1 & family_friend_resp ==1 & r2dresid==6
replace lung_all = 1 if  lung_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace lung_all = 1 if  lung_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace lung_all = 1 if  lung_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace lung_all = 1 if  lung_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace lung_all = 1 if  lung_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace lung_all = 1 if  lung_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen cva_all = 0 
replace cva_all = 1 if  cva_1==1 & family_friend_resp ==1 & r2dresid==6
replace cva_all = 1 if  cva_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace cva_all = 1 if  cva_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace cva_all = 1 if  cva_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace cva_all = 1 if  cva_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace cva_all = 1 if  cva_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace cva_all = 1 if  cva_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen dementia_all = 0 
replace dementia_all = 1 if  dementia_1==1 & family_friend_resp ==1 & r2dresid==6
replace dementia_all = 1 if  dementia_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace dementia_all = 1 if  dementia_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace dementia_all = 1 if  dementia_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace dementia_all = 1 if  dementia_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace dementia_all = 1 if  dementia_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace dementia_all = 1 if  dementia_7==1 & family_friend_resp8 ==1 & r8dresid==6


gen cancer_all = 0 
replace cancer_all = 1 if  cancer_1==1 & family_friend_resp ==1 & r2dresid==6
replace cancer_all = 1 if  cancer_2==1 & family_friend_resp3 ==1 & r3dresid==6
replace cancer_all = 1 if  cancer_3==1 & family_friend_resp4 ==1 & r4dresid==6
replace cancer_all = 1 if  cancer_4==1 & family_friend_resp5 ==1 & r5dresid==6
replace cancer_all = 1 if  cancer_5==1 & family_friend_resp6 ==1 & r6dresid==6
replace cancer_all = 1 if  cancer_6==1 & family_friend_resp7 ==1 & r7dresid==6
replace cancer_all = 1 if  cancer_7==1 & family_friend_resp8 ==1 & r8dresid==6



gen site_of_death_hospice = site_of_death_w2w8
replace site_of_death_hospice = 7 if site_of_death_w2w8 ==1 & hosp_last_month ==1
replace site_of_death_hospice = 8 if site_of_death_w2w8 ==5 & hosp_last_month ==1

**Generate variable "excellent" if overall care in last month of life rated excellent. 1=yes, 0 if otherwise

gen excellent = 0 if recode_overall_rate !=. 
replace excellent =1 if recode_overall_rate ==1 

*variable on transitions of care

gen los_last_place = -1
replace los_last_place = pd2staydays if r2dresid==6 
replace los_last_place = pd3staydays if r3dresid==6
replace los_last_place = pd4staydays if r4dresid==6
replace los_last_place = pd5staydays if r5dresid==6
replace los_last_place = pd6staydays if r6dresid==6
replace los_last_place = pd7staydays if r7dresid==6
replace los_last_place = pd8staydays if r8dresid==6


replace los_last_place = -2 if pd2stayunit >=2 & pd2stayunit <=4
replace los_last_place = -2 if pd3stayunit >=2 & pd3stayunit <=4
replace los_last_place = -2 if pd4stayunit >=2 & pd4stayunit <=4
replace los_last_place = -2 if pd5stayunit >=2 & pd5stayunit <=4
replace los_last_place = -2 if pd6stayunit >=2 & pd6stayunit <=4
replace los_last_place = -2 if pd7stayunit >=2 & pd7stayunit <=4
replace los_last_place = -2 if pd8stayunit >=2 & pd8stayunit <=4


gen late_transition = 0 if r2dresid ==6| r3dresid ==6| r4dresid ==6| r5dresid ==6| r6dresid ==6 | r7dresid ==6 | r8dresid ==6 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd4placepre >0 &  pd4placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd3placepre >0 &  pd3placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd2placepre >0 &  pd2placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd5placepre >0 &  pd5placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd6placepre >0 &  pd6placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd7placepre >0 &  pd7placepre <=91) 
replace late_transition = 1 if (los_last_place >=1 & los_last_place <=3) & ( pd8placepre >0 &  pd8placepre <=91) 


save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\nhats only.dta", replace


H="build data set step 2: add claims data"
*step 2: this merges in the claims- hospice/ma data to the nhats only data, creating a working dataset

use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\nhats only.dta", clear
tempfile nhats
save "`nhats'"

/*
use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", clear

merge 1:m bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", gen(hospm) keep(master match) keepusing(ptnt_dschrg_stus_cd )
gen ind_hospice=hospm==3
by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

drop ptnt_dschrg_stus_cd

duplicates drop 

merge 1:1 spid using "`nhats'", nogen 
merge 1:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\death_date.dta", nogen

*/


///////////////////////


//MBSF GETTING MA first part for methods 1 and 2. 


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
sort bene_id year 
keep if death_date!=.
keep bene_id death_date dual_stus_cd_*

gen death_month=month(death_date)

gen medicaid_death=.
forvalues i=1/9{
replace medicaid_death=0 if death_month==`i' & inlist(dual_stus_cd_0`i', "XX", "NA", "09", "99")
replace medicaid_death=1 if death_month==`i' & inlist(dual_stus_cd_0`i', "00", "01", "02", "03", "04", "05", "06", "08")
}

forvalues i=10/12{
replace medicaid_death=0 if death_month==`i' & inlist(dual_stus_cd_`i', "XX", "NA", "09", "99")
replace medicaid_death=1 if death_month==`i' & inlist(dual_stus_cd_`i', "00", "01", "02", "03", "04", "05", "06", "08")
}

label var medicaid_death "Medicaid at death Month"

tempfile death
save "`death'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", clear

sort bene_id clm_hospc_start_dt_id

gen hospice_month= month(clm_hospc_start_dt_id)
gen hospice_year= year(clm_hospc_start_dt_id)

gen los=disch_date-admit_date
bys bene_id: egen hs_los=total(los)

by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 1,0))

sort bene_id clm_hospc_start_dt_id

merge m:1 bene_id using "`death'", keep(match) nogen

sort bene_id clm_hospc_start_dt_id
gen hs_12_pre=0
by bene_id, sort: replace hs_12_pre=1 if (death_date-clm_hospc_start_dt_id<=366) & (death_date-clm_hospc_start_dt_id>=0)

//by bene_id, sort: egen ind_hs_12_pre=max(hs_12_pre)

sort bene_id clm_hospc_start_dt_id


bys bene_id hs_12_pre: keep if _n==1 
bys bene_id: keep if _n==_N

tempfile hs
save "`hs'"


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

gen death_month=month(death_date)

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1

gen ma1=0

di `a'
foreach x in `month'{
gen `x'_c=substr(hmoind12,`a',1)
replace `x'_c="1" if `x'_c!="0"
destring `x'_c, replace
replace ma1=1 if death_month==`a' & `x'_c==1
local a=`a'+1
di `a'
}



sort bene_id
tempfile ma1 
save "`ma1'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
//want 1 year prior to look at, thus we add 1 and merge
replace year=year+1

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1


foreach x in `month'{
gen `x'_c_1=substr(hmoind12,`a',1)
replace `x'_c_1="1" if `x'_c_1!="0"
destring `x'_c_1, replace
local a=`a'+1
}

keep *_c_1 year bene_id

tempfile ma2 
save "`ma2'"


use "`ma1'", clear

keep if death_date!=.

merge 1:1 bene_id year using "`ma2'", keep(match) nogen


gen ma2=0 


/*
consecutive MA status--doesn't matter
*/

replace ma2=1 if death_month==1 & (jan_c==1 | jan_c_1==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==2 & (feb_c==1 | jan_c==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==3 & (mar_c==1 | jan_c==1 | feb_c==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==4 & (apr_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==5 & (may_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==6 & (jun_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==7 & (jul_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==8 & (aug_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==9 & (sep_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==10 & (oct_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==11 & (nov_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==12 & (dec_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c==1 | dec_c_1==1)

sort bene_id year

//by bene_id: keep if _n==_N


merge m:1 bene_id using "`hs'", gen(hospm) keep(master match)
drop medicaid_death
merge m:1 bene_id using "`death'", keepusing(medicaid_death) keep(master match) nogen

gen ind_hospice=hospm==3

replace ma1=0 if ind_hospice==1
replace ma2=0 if ind_hospice==1

gen ma_month_bef_hs=0
local a=1
local month dec_c_1 jan_c feb_c mar_c apr_c may_c jun_c jul_c aug_c sep_c oct_c nov_c 
foreach x in `month'{
replace ma_month_bef_hs=1 if hospice_month==`a' & `x'==1 
local a=`a'+1
}

replace ma1=1 if ind_hospice==1  & ma_month_bef_hs==1

replace ma2=1 if hs_12_pre==1 &  ma_month_bef_hs==1

sort bene_id year 
by bene_id: keep if _n==_N


merge 1:1 bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", keep(match) nogen

keep bene_id spid ma1 ma2 hs_12_pre ind_died_on_hospice ind_hospice ma_month_bef_hs death_date year hospice_year death_month prvdr_num hs_los medicaid_death
merge 1:m spid using "`nhats'", nogen keep(match)

label var ma1 "MA approach 1"
label var ma2 "MA approach 2 (12 month)"
label var hs_12_pre "Hospice claim 12-months pre death"
label var ind_died_on_hospice "Died in Hospice"
label var ma_month_bef_hs "Had MA month before Hospice"

destring prvdr_num, replace
merge m:1 prvdr_num using  "D:\NHATS\Projects\MA after functional disability\cka_ma switches disability\data\bene spid and hospice_one yr only.dta"
drop if _merge==2

drop _merge
merge m:1 prvdr_num using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\more cahps.dta" 
drop if _merge==2


save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\claims and nhats.dta", replace


H="build data set step 3: merge in some more nhats vars"
*step 3: merging in other nhats data
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\claims and nhats.dta"
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\race var.dta"
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\female var.dta"
drop _merge
merge 1:1 spid using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\other nhats vars.dta"

save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace

H="build data step 4: merge HRRMA file"
*step 4

//first, pull the HRR numbers for each wave

cd "D:\NHATS\Shared\raw\NHATS\NHATS Restricted\NHATS Rounds1-7 HRR Files-STATA"
forvalues i=1/6 {
	use NHATS_Round_`i'_HRR_xref.dta, clear
	destring spid, replace
	rename hrrnum hrrnum
	gen wave=`i'
	tempfile t`i'
	save `t`i''
}

clear
forvalues i=1/6 {
	append using `t`i''
}

//now carryforward, bc we've only got HRR through wave 6
merge 1:1 spid wave using "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_7.dta", keepusing(spid) nogen
sort spid wave
by spid: carryforward hrrnum, replace

//merge with MA penetration and keep last obs
gen year=2010+wave
merge m:1 year hrrnum using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\int_data\hrrnum_year_avgMA.dta", nogen keep(match master)

sort spid wave
by spid: keep if _n==_N
tempfile hrr
save `hrr'

//now merge them
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", clear
drop _m
//hrr for each year
merge 1:1 spid using `hrr', nogen

svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)


//per-year quartile

gen avgma_quart=.
levelsof year, local(levels)
foreach l of local levels {
	xtile a=avg_MA [pw=pweight] if year==`l', nq(4)
	replace avgma_quart=a if year==`l'
	drop a
}
label var avgma_quart "Per-year in-sample quartile of MA penetration by HRR"

gen avgma_quint=.
levelsof year, local(levels)
foreach l of local levels {
	xtile a=avg_MA [pw=pweight] if year==`l', nq(5)
	replace avgma_quint=a if year==`l'
	drop a
}
label var avgma_quint "Per-year in-sample quintile of MA penetration by HRR"



save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace

H="build data step 5:  MA added in"

*step 5
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta"

tempfile nhats
save "`nhats'"

/*
use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", clear

merge 1:m bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", gen(hospm) keep(master match) keepusing(ptnt_dschrg_stus_cd )
gen ind_hospice=hospm==3
by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

drop ptnt_dschrg_stus_cd

duplicates drop 

merge 1:1 spid using "`nhats'", nogen 
merge 1:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\death_date.dta", nogen

*/


///////////////////////


//MBSF GETTING MA first part for methods 1 and 2. 


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear
sort bene_id year 
keep if death_date!=.
keep bene_id death_date
tempfile death
save "`death'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", clear

sort bene_id clm_hospc_start_dt_id

gen hospice_month= month(clm_hospc_start_dt_id)
gen hospice_year= year(clm_hospc_start_dt_id)

by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 0,1))

sort bene_id clm_hospc_start_dt_id

merge m:1 bene_id using "`death'", keep(master match) nogen

gen hs_12_pre=0
by bene_id, sort: replace hs_12_pre=1 if (death_date-clm_hospc_start_dt_id<=366) & (death_date-clm_hospc_start_dt_id>=0)

by bene_id, sort: egen ind_hs_12_pre=max(hs_12_pre)

by bene_id: keep if _n==1

tempfile hs
save "`hs'"


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

gen death_month=month(death_date)

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1

gen ma1=0

di `a'
foreach x in `month'{
gen `x'_c=substr(hmoind12,`a',1)
replace `x'_c="1" if `x'_c!="0"
destring `x'_c, replace
replace ma1=1 if death_month==`a' & `x'_c==1
local a=`a'+1
di `a'
}
sort bene_id
tempfile ma1 
save "`ma1'"

use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\mbsf_06_17.dta", clear

replace year=year+1

local month jan feb mar apr may jun jul aug sep oct nov dec
local a=1


foreach x in `month'{
gen `x'_c_1=substr(hmoind12,`a',1)
replace `x'_c_1="1" if `x'_c_1!="0"
destring `x'_c_1, replace
local a=`a'+1
}


keep *_c_1 year bene_id

tempfile ma2 
save "`ma2'"


use "`ma1'", clear

merge 1:1 bene_id year using "`ma2'", keep(match) nogen


gen ma2=0 


/*
consecutive MA status--don't want
*/

replace ma2=1 if death_month==1 & (jan_c==1 | jan_c_1==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==2 & (feb_c==1 | jan_c==1 | feb_c_1==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==3 & (mar_c==1 | jan_c==1 | feb_c==1 | mar_c_1==1 | apr_c_1==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==4 & (apr_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==5 & (may_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c_1==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==6 & (jun_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c_1==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==7 & (jul_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c_1==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==8 & (aug_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c_1==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==9 & (sep_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c_1==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==10 & (oct_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c_1==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==11 & (nov_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c_1==1 | dec_c_1==1)

replace ma2=1 if death_month==12 & (dec_c==1 | jan_c==1 | feb_c==1 | mar_c==1 | apr_c==1 | may_c==1 | jun_c==1 | jul_c==1 | aug_c==1 | sep_c==1 | oct_c==1 | nov_c==1 | dec_c_1==1)

sort bene_id year

//by bene_id: keep if _n==_N


merge m:1 bene_id using "`hs'", gen(hospm) keep(master match)

gen ind_hospice=hospm==3

gen ma_month_bef_hs=0
local a=1
local month dec_c_1 jan_c feb_c mar_c apr_c may_c jun_c jul_c aug_c sep_c oct_c nov_c 
foreach x in `month'{
replace ma_month_bef_hs=1 if hospice_month==`a' & `x'==1
local a=`a'+1
}

replace ma1=1 if ind_died_on_hospice==1 & year==hospice_year & ma_month_bef_hs==1

replace ma2=1 if ind_hs_12_pre==1 & year==hospice_year & ma_month_bef_hs==1

sort bene_id year
by bene_id: keep if _n==_N

merge 1:1 bene_id using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", keep(match) nogen

keep bene_id spid ma1 ma2 ind_hs_12_pre ind_died_on_hospice ind_hospice ma_month_bef_hs death_date year hospice_year
merge 1:m spid using "`nhats'", nogen

label var ma1 "MA approach 1"
label var ma2 "MA approach 2 (12 month)"
label var ind_hs_12_pre "Hospice claim 12-months pre death"
label var ind_died_on_hospice "Died in Hospice"
label var ma_month_bef_hs "Had MA month before Hospice"

save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace

H=" variable cleaning"
*more variable cleaning
recode deathage_cat (1/2=1 "65-74")(3/4=2 "75-84")(5/6=3 "85+"),gen(deathage_3cat)

*live discharge
gen livedischarge=0 if ind_hospice==1
replace livedischarge=1 if ind_hospice==1 & ind_died_on_hospice==0

*place of death
gen placedeath=.
replace placedeath= 1 if pd8placedied==1  & r8dlmlint==1 
replace placedeath= 1 if pd8placedied==4  & r8dlmlint==1 
replace placedeath= 2 if pd8placedied==2  & r8dlmlint==1  
replace placedeath= 2 if pd8placedied==5  & r8dlmlint==1  
replace placedeath= 3 if pd8placedied==3  & r8dlmlint==1  
replace placedeath= 4 if pd8placedied==91  & r8dlmlint==1  
replace placedeath= 4 if pd8placedied==-8  & r8dlmlint==1  

replace placedeath= 1 if pd7placedied==1  & r7dlmlint==1 
replace placedeath= 1 if pd7placedied==4  & r7dlmlint==1 
replace placedeath= 2 if pd7placedied==2  & r7dlmlint==1  
replace placedeath= 2 if pd7placedied==5  & r7dlmlint==1  
replace placedeath= 3 if pd7placedied==3  & r7dlmlint==1  
replace placedeath= 4 if pd7placedied==91  & r7dlmlint==1  
replace placedeath= 4 if pd7placedied==-8  & r7dlmlint==1  

replace placedeath= 1 if pd6placedied==1  & r6dlmlint==1 
replace placedeath= 1 if pd6placedied==4  & r6dlmlint==1 
replace placedeath= 2 if pd6placedied==2  & r6dlmlint==1  
replace placedeath= 2 if pd6placedied==5  & r6dlmlint==1  
replace placedeath= 3 if pd6placedied==3  & r6dlmlint==1  
replace placedeath= 4 if pd6placedied==91  & r6dlmlint==1  
replace placedeath= 4 if pd6placedied==-8  & r6dlmlint==1  

replace placedeath= 1 if pd5placedied==1  & r5dlmlint==1 
replace placedeath= 1 if pd5placedied==4  & r5dlmlint==1 
replace placedeath= 2 if pd5placedied==2  & r5dlmlint==1  
replace placedeath= 2 if pd5placedied==5  & r5dlmlint==1  
replace placedeath= 3 if pd5placedied==3  & r5dlmlint==1  
replace placedeath= 4 if pd5placedied==91  & r5dlmlint==1  
replace placedeath= 4 if pd5placedied==-8  & r5dlmlint==1  

replace placedeath= 1 if pd4placedied==1  & r4dlmlint==1 
replace placedeath= 1 if pd4placedied==4  & r4dlmlint==1 
replace placedeath= 2 if pd4placedied==2  & r4dlmlint==1  
replace placedeath= 2 if pd4placedied==5  & r4dlmlint==1  
replace placedeath= 3 if pd4placedied==3  & r4dlmlint==1  
replace placedeath= 4 if pd4placedied==91  & r4dlmlint==1  
replace placedeath= 4 if pd4placedied==-8  & r4dlmlint==1  

replace placedeath= 1 if pd3placedied==1  & r3dlmlint==1 
replace placedeath= 1 if pd3placedied==4  & r3dlmlint==1 
replace placedeath= 2 if pd3placedied==2  & r3dlmlint==1  
replace placedeath= 2 if pd3placedied==5  & r3dlmlint==1  
replace placedeath= 3 if pd3placedied==3  & r3dlmlint==1  
replace placedeath= 4 if pd3placedied==91  & r3dlmlint==1  
replace placedeath= 4 if pd3placedied==-8  & r3dlmlint==1  

replace placedeath= 1 if pd2placedied==1  & r2dlmlint==1 
replace placedeath= 1 if pd2placedied==4  & r2dlmlint==1 
replace placedeath= 2 if pd2placedied==2  & r2dlmlint==1  
replace placedeath= 2 if pd2placedied==5  & r2dlmlint==1  
replace placedeath= 3 if pd2placedied==3  & r2dlmlint==1  
replace placedeath= 4 if pd2placedied==91  & r2dlmlint==1  
replace placedeath= 4 if pd2placedied==-8  & r2dlmlint==1  
replace placedeath=. if placedeath==4

gen placedeathpre=.

label define pd3 1 "1 home or hospice residence" 2 "2 hospital or in transit to hospital" 3 "3 nursing home" 4 "4 other/dk"
label values  placedeath pd3
tab placedeath if inanal==1, m

foreach var of varlist pd8placepre pd7placepre pd6placepre pd5placepre pd4placepre pd3placepre pd2placepre {
replace placedeathpre=1 if `var'==1
replace placedeathpre=2 if `var'==2
replace placedeathpre=3 if `var'==3
replace placedeathpre=. if `var'==4 | `var'==5 | `var'==91
}
label values  placedeathpre pd3
replace placedeathpre=. if placedeath==4
tab placedeathpre if inanal==1, m

*NH exposure in last month
gen any_nh=0
replace any_nh=1 if placedeath==3
replace any_nh=1 if placedeathpre==3 & los_last_place>0 & los_last_place<30
replace any_nh=0 if inanal==0

*hospital exposure last month
gen any_hospital=0
replace any_hospital=1 if placedeath==2
replace any_hospital=1 if placedeathpre==2 & los_last_place>0 & los_last_place<30
replace any_hospital=0 if inanal==0

*died at home or in hospice residence
gen home_death=0
replace home_death=1 if placedeath==1
replace home_death=0 if inanal==0

recode excellent (1=0)(0=1), gen(not_excellent)

*hospice-level vars
gen perc_9or10=rating_9or10/100
gen perc_7or8=rating_7or8/100
gen perc_6orless=rating_6orless/100

foreach var of varlist symptoms_always symptoms_usually symptoms_rarenever comm_always comm_usually comm_rarenever timely_always timely_usually timely_rarenever recommend_def recommend_prob recommend_not {
replace `var'=`var'/100
}

gen lowest_inc_qrt=0
replace lowest_inc_qrt=1 if income_quart==1

recode hs_los (0/3=1)(4/99999999=0), gen (hs_shortstay)

*exclude duels
gen inanal_noduals=inanal
replace inanal_noduals=0 if inanal==1 & medicaid_death==1


*STRATIFY BY HOSPICE
gen inanal_hospice=inanal
replace inanal_hospice=0 if ind_hospice==0

gen inanal_nohospice=inanal
replace inanal_nohospice=0 if ind_hospice==1

*make a variable for missing data

foreach var of varlist not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed {
		gen `var'_missing=inanal
		replace `var'_missing=0 if `var'!=. & inanal==1
		}

		egen sumscore= rowtotal (not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed )
		replace sumscore=. if not_excellent ==. & unmet_pain==. & unmet_bre==. & unmet_sad==. & unmet_relig==. & di_recode_always_respect==. & recode_care_notwant==. & /// 
		recode_care_decision==. & di_recode_informed ==. 
recode sumscore (0=0)(1/9=1), gen(oneplusmsr)
recode sumscore (0/1=0)(2/9=1), gen(twoplusmsr)
recode sumscore (0/2=0)(3/9=1), gen(threeplusmsr)
recode sumscore (0/3=0)(4/9=1), gen(fourplusmsr)
recode sumscore (0=0 "0") (1=1 "1")(2=2 "2") (3/9=3 "3+"), gen(sumscore_cat)



*subpop in hospice
gen inanal_hosp=inanal
replace inanal_hosp=0 if ind_hospice==0

*lowest quartile hospice
xtile quart_symptoms_always= symptoms_always, nq(4)
xtile quart_comm_always=comm_always, nq(4)

gen low_quart_hosp=0 if ind_hospice==1 
replace low_quart_hosp=1 if ind_hospice==1 & (quart_symptoms_always==1 | quart_comm_always==1)

*recode race_cat
recode race_cat (1=1)(2/4=0), gen (whiterace)

		
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta", replace


H="analysis"
*analysis
use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\MA_eol_nhats.dta"


svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

		
*table 1: in MA at time of death vs not
*looking at quality variables
svy, subpop(inanal): tab ma1
tab ma1 if inanal==1, m


svy, subpop(inanal): tab ma1, count cellwidth(15) format (%15.2g)

svy, subpop(inanal): tab deathage_3cat ma1, column
svy, subpop(inanal): tab female ma1, column
svy, subpop(inanal): tab race_cat ma1, column
svy, subpop(inanal): tab income_quart ma1, column
svy, subpop(inanal): tab medicaid_death ma1, column
svy, subpop(inanal): tab metro_ind ma1, column
svy, subpop(inanal): tab avgma_quint ma1, column

svy, subpop(inanal): tab diff_get_out_bed ma1, column
svy, subpop(inanal): tab adl_impair ma1, column

svy, subpop(inanal): tab lung_all ma1, column
svy, subpop(inanal): tab cva_all ma1, column
svy, subpop(inanal): tab cancer_all ma1, column
svy, subpop(inanal): tab prob_dem ma1, column




*PROPENSITY SCORE MODEL
*create and assess propensity score
pscore ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, pscore(mapscore) blockid(mablock)logit	detail
psgraph, treated(ma1) pscore(mapscore)


*weight treatment and comparison by propensity score

*outcome 3+ measures
qui dr threeplusmsr ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen threeplusmsr_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome not excellent
qui dr not_excellent ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen not_excellent_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome unmet pain
qui dr unmet_pain ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen unmet_pain_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome unmet breathing
qui dr unmet_bre ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen unmet_bre_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome unmet sad
qui dr unmet_sad ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen unmet_sad_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome unmet relig
qui dr unmet_relig ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen unmet_relig_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome always respect
qui dr di_recode_always_respect ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen di_recode_always_respect_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome care not want
qui dr recode_care_notwant ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen recode_care_notwant_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome care decision
qui dr recode_care_decision ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen recode_care_decision_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*outcome informed
qui dr di_recode_informed ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen di_recode_informed_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat

*count of outcomes
qui dr sumscore_cat ma1 deathage_3cat female whiterace income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse pweight if inanal==1, genvars
egen sumofweights=total(iptw)
gen norm_weights=iptwt/sumofweights
gen sumscore_pweight= norm_weights*pweight
drop norm_weights sumofweights mudiff mu0 mu1 iptwt ptreat


****logistic models, inverse prob weighted *****

*care is not excellent: weighted model
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*unmet pain needs: weighted model
svyset sunit [pweight=unmet_pain_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_pain  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*unmet breathing needs: weighted model
svyset sunit [pweight=unmet_bre_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_bre  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
svydescribe if e(sample)
gen unmet_bre_strata=strata
replace unmet_bre_strata=53 if strata==52
svyset sunit [pweight=unmet_bre_pweight], strata (unmet_bre_strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_bre  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*unmet sad: weighted model
svyset sunit [pweight=unmet_sad_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_sad  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*unmet relig
svyset sunit [pweight=unmet_relig_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_relig  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
svydescribe if e(sample)
gen unmet_relig_strata=strata
replace unmet_relig_strata=55 if strata==54
svyset sunit [pweight=unmet_relig_pweight], strata (unmet_relig_strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic unmet_relig  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*not always respect: weighted
svyset sunit [pweight=di_recode_always_respect_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic di_recode_always_respect  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*care not want
svyset sunit [pweight=recode_care_notwant_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic recode_care_notwant  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*care_decision
svyset sunit [pweight=recode_care_decision_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic recode_care_decision  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)

*informed
svyset sunit [pweight=di_recode_informed_pweight], strata (strata) vce(linearized) singleunit(missing)
svy, subpop(inanal): logistic di_recode_informed  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)



***STRATIFICATIONS: 1. BY HOSPICE
*in hospice
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
qui svy, subpop(inanal_hospice): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
margins ma1

*no hospice
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
qui svy, subpop(inanal_nohospice): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
margins ma1

*2 BY PLACE OF DEATH

*IN NH
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
qui svy, subpop(any_nh): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
margins ma1

*IN HOSPITAL
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
qui svy, subpop(any_hospital): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
margins ma1

*DIED AT HOME
svyset sunit [pweight=not_excellent_pweight], strata (strata) vce(linearized) singleunit(missing)
qui svy, subpop(home_death): logistic not_excellent  i.deathage_3cat female whiterace i.income_quart medicaid_death metro_ind diff_get_out_bed adl_impair prob_dem child spouse  i.ma1, cformat(%4.2f)
margins ma1


*TABLE 3	
*looking at eol care characteristics and ma
svyset sunit [pweight=pweight], strata (strata) vce(linearized) singleunit(missing)

svy, subpop(inanal): tab ind_hospice ma1, column
svy, subpop(inanal_hosp): tab hs_shortstay ma1, column
svy, subpop(inanal_hosp): tab livedischarge ma1, column
svy, subpop(inanal_hosp): tab low_quart_hosp ma1, column
svy, subpop(inanal): tab placedeath ma1, column

svy, subpop(inanal): tab late_transition ma1, column
svy, subpop(inanal): tab week_transition ma1, column
svy, subpop(inanal): tab any_nh ma1, column
svy, subpop(inanal): tab any_hospital ma1, column


***for appendix

*appendix table 3: alt MA def, fully adjusted
foreach var of varlist threeplusmsr not_excellent unmet_pain unmet_bre unmet_sad unmet_relig di_recode_always_respect recode_care_notwant /// 
		recode_care_decision di_recode_informed  {
		svy, subpop(inanal): logistic `var' i.ma2 i.deathage_3cat female child  spouse  ///
		  diff_get_out_bed , cformat(%4.2f)
}


		  



H="Change log"


********************Change Log******************** 

11/8/2019 CK
reorganized headings so that each "build data step" and variable cleaning needs to be run to build final data set

Updates:
11/5/2019 MH
-----------
Added in Medicaid at death variable. 

11/1/2019 MH
-----------
Added in Hospice length of stay to step 2.

10/25/2019 EBL
------------
Merged in constructed MA penetration and reran Claire's analysis in "merge HRRMA file"

09/16/2019 MH
------------
Small change to keep only those people in NHATS who match with MA definition. 

08/08/2019 MH
------------
Made changes to the code to fix problem with MA population. 

08/07/2019 MH
------------
Have looked into problems around MA1 and hospice, have added into a working heading. 

8/7/2019 CA
re organized note tab, merged in race and sex variables, checking the hospice and ma variables and running prelim analysis.

07/22/2019 MH
-------------
Getting MA population and hopsice claims.  

7/14/2019 CKA
-------------
adapted code from joan teno to make and clean NHATS portion. note- need to bring in race variable. analysis sections posted as model.


*/

H="xxxxxDays at home prelim code"
/* Days at home code for claire */

/* Days at home code

/* Starting with death date as index and look 1 year back. */

data index;
set clean.death_date_2015;
index_date=death_all;
run; 

proc sort data=index out=index1 nodupkey;
by bid_hrs_22 id index_date;
run;

data index_548 (keep= id bid_hrs_22 date index_date index_548 death_year) ;
set index1;
index_548=index_date-548;
do i=index_548 to index_date;
date=i;
output;
end;
format date date9.;
format index_date date9.;
format index_548 date9.;
run;
run;

/**************************************************************************/
/**************** Claims Before Death  ******************************/
/**************************************************************************/
/*macro to get claims 548 days before death
saves datasets for each claim type */
%macro claimspre(days_start=,days_bef_index=,source=,suf=);

/*claims fully within x time of death date*/
proc sql;
create table &source._meet_1 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and &days_start<=b.index_date-a.admit_date<=&days_bef_index ;
quit;

/*claims that start earlier than x time but span into x time before death*/
proc sql;
create table &source._meet_2 as select a.*,b.index_date,b.id 
from medi.&source._1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and b.index_date-a.admit_date>&days_bef_index and b.index_date-a.disch_date<=&days_bef_index;
quit;

data &source._meet_&suf.(compress=yes);
set &source._meet_1 &source._meet_2;
run;

%mend;

/*18m before death*/
%claimspre(days_start=0,days_bef_index=548,source=hh,suf=18m); /*home health*/
%claimspre(days_start=0,days_bef_index=548,source=ip,suf=18m); /*inpatient*/
%claimspre(days_start=0,days_bef_index=548,source=dm,suf=18m); /*dme*/
%claimspre(days_start=0,days_bef_index=548,source=op,suf=18m); /*outpatient*/
%claimspre(days_start=0,days_bef_index=548,source=pb,suf=18m); /*carrier*/
%claimspre(days_start=0,days_bef_index=548,source=sn,suf=18m); /*snf*/

/* Hospice file a little different format than the rest, but does the same as above */

data hs_1998_2015 (keep= hspcstrt hs_start admit_date disch_date bid_hrs_22 provider) ;
set medi.hs_1998_2015;
hs_start=input(put(hspcstrt, 8.), yymmdd8.);
format hs_start date9.;
format admit_date date9.;
run;

/*claims fully within x time of death date*/
proc sql;
create table hs_meet_1 as select a.*,b.index_date,b.id 
from hs_1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and 0<=b.index_date-a.hs_start<=548;
quit;

/*claims that start earlier than x time but span into x time before death*/
proc sql;
create table hs_meet_2 as select a.*,b.index_date,b.id 
from hs_1998_2015 a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and b.index_date-a.hs_start>548 and b.index_date-a.disch_date<=548;
quit;

data hs_meet_18m(compress=yes);
set hs_meet_1 hs_meet_2;
run;

/*emergency and observation stays identified from the inpatient and outpatient file. */

%macro er_obs(source=);

data &source._meet_18m_er_obs;
set &source._meet_18m;
er_flag = 0;
obs_flag = 0;
array rvcntr rvcntr01-rvcntr45;
array hcpcs hcpscd01-hcpscd45;
array rvunt rvunt01-rvunt45;
do over rvcntr;
do over hcpcs;
do over rvunt;
if strip(rvcntr) in:("0450", "0451", "0452", "0456", "0459", "0981") then er_flag = 1;
if strip(rvcntr) in:("0762") then obs_flag =1;
/*if strip(rvcntr) in:("0760") and strip(hcpcs) in: ("G0378") and rvunt>=8 then obs_flag =1;*/
end;
end;
end;
run;

data &source._er_meet_18m;
set &source._meet_18m_er_obs;
if er_flag=1;
run;

data &source._obs_meet_18m;
set &source._meet_18m_er_obs;
if obs_flag=1;
run;

%mend;

/*4m before death*/
%er_obs(source=ip); /*inpatient file*/
%er_obs(source=op); /*outpatient file*/


/* Putting stays into 1 observation per day format. Flagging if they go to a different facility, but are still IP.*/

%macro dates(source=,suf=, npi=);

data &source._meet_&suf._d;
set &source._meet_&suf.;
format index_date date9.;
format admit_date date9.;
format disch_date date9.;
day_a=index_date-admit_date;
day_d=index_date-disch_date;
run;

data &source._meet_&suf._dates;
set &source._meet_&suf._d;
do i=admit_date to disch_date;
date=i;
output;
end;
format date date9.;
run;

data &source._&suf.; 
set &source._meet_&suf._dates;
where 0<=index_date-date<=548;
&source.=1;
&source._npi=&npi.;
run;

proc sort data=&source._&suf. out=&source._&suf. ;
by bid_hrs_22 date ;
run;

data &source._dup (keep= bid_hrs_22 bid_n hhidpn index_date flag date admit_date disch_date days_a days_d &source. fac_type provider &source._npi at_upin) ;
set &source._&suf.;
if date=lag(date) and bid_hrs_22=lag(bid_hrs_22) and (provider~=lag(provider) or &npi.~=lag(&npi.)) then flag=1;
run;

proc sort data=&source._dup nodupkey;
by bid_hrs_22 date &source. &source._npi;
run;

%mend;

%dates(source=ip,suf=18m,npi=ORGNPINM);
%dates(source=op_er,suf=18m,npi=ORGNPINM);
%dates(source=op_obs,suf=18m,npi=ORGNPINM);
%dates(source=ip_er,suf=18m,npi=ORGNPINM);
%dates(source=ip_obs,suf=18m,npi=ORGNPINM);
%dates(source=sn,suf=18m,npi=ORGNPINM);
%dates(source=hh,suf=18m,npi=ORGNPINM);
%dates(source=hs,suf=18m,npi=ORGNPINM);


/* Bringing in MDS section*/

proc import out=proj_int.mds datafile="D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data\mds.dta" replace; 
run;


/*MDS claims fully within x time of death date*/
proc sql;
create table mds_meet_1 as select a.*,b.index_date,b.id 
from proj_int.mds a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and 0<=b.index_date-a.admit<=548 ;
quit;

/*MDS claims that start earlier than x time but span into x time before death*/
proc sql;
create table mds_meet_2 as select a.*,b.index_date,b.id 
from proj_int.mds a inner join
index1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22))
and b.index_date-a.admit>548 and b.index_date-a.discharge<=0;
quit;

data mds_meet_18m (compress=yes);
set mds_meet_1 mds_meet_2;
run;


data mds_meet_18m_d;
set mds_meet_18m;
format index_date date9.;
day_a=index_date-admit;
day_d=index_date-discharge;
rename date=date_1;
run;


data mds_meet_18m_dates;
set mds_meet_18m_d;
do i=admit to discharge;
date=i;
output;
end;
format date date9.;
run;


data mds_18m; 
set mds_meet_18m_dates;
where 0<=index_date-date<=548;
mds=1;
run;

proc sort data=mds_18m out=mds_18m ;
by bid_hrs_22 date ;
run;


data mds_dup (keep= bid_hrs_22 target date admission discharge index_date day_a day_d date_1 mds) ;
set mds_18m;
run;


proc sort data=index_548;
by bid_hrs_22 date;
run;

/* merging all files together*/

data all_claims;
merge index_548 ip_dup ip_er_dup ip_obs_dup op_er_dup op_obs_dup sn_dup hh_dup hs_dup mds_dup;
by bid_hrs_22 date;
run;

/* keeping only 365 days before index(death) date). */
data all_claims;
set all_claims;
if index_date-date<=365 then days_365=1;
run;

data all_claims_365;
set all_claims;
where days_365=1;
run;

/* section to see hospice at home */


data pb_meet_18m_d;
set pb_meet_18m;
format index_date date9.;
format admit_date date9.;
format disch_date date9.;
day_a=index_date-admit_date;
day_d=index_date-disch_date;
run;

data pb_meet_18m_dates;
set pb_meet_18m_d;
do i=admit_date to disch_date;
date=i;
output;
end;
format date date9.;
run;

data pb_18m; 
set pb_meet_18m_dates;
where 0<=index_date-date<=548;
run;

proc sort data=pb_18m out=pb_18m ;
by bid_hrs_22 date ;
run;

proc sql;
create table pb_hs_meet_548 as select a.*, b.*
from pb_18m a inner join
index_365 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.date=b.date
inner join hs_18m c 
on trim(left(b.bid_hrs_22))=trim(left(c.bid_hrs_22))
and b.date=c.date;
quit;

data pb_hs_meet_365;
set pb_hs_meet_548;
where index_date-date<=365;
run;

data home_hospice;
set pb_hs_meet_365;
home_hs=0;
run;

data home_hospice1;
set home_hospice;
array place PLCRVC01-PLCRVC13;
do over place;
if place=12 then home_hs=1;
end;
run;

proc freq data=home_hospice1;
table home;
run;

/* end hopsice at home */

proc sql;
create table all_claims_365_1 as select a.*, b.bid_hrs_22, b.home_hs, b.date
from all_claims_365 a left join
home_hospice1 b
on trim(left(a.bid_hrs_22))=trim(left(b.bid_hrs_22)) and a.date=b.date;
quit;

proc sort data=all_claims_365_1;
by bid_hrs_22 date;
run;

data all_claims_365_2;
set all_claims_365_1;
not_home=0;
if ip=1 then not_home=1;
if ip_er=1 then not_home=1;
if ip_obs=1 then not_home=1;
if op_er=1 then not_home=1;
if op_obs=1 then not_home=1;
if sn=1 then not_home=1;
if mds=1 then not_home=1;
if hs=1 and home_hs=0 then not_home=1;
home=0;
if not_home=0 then home=1;
run;

proc sort data=all_claims_365_2 nodupkey;
by bid_hrs_22 date;
run;

proc sql;
create table total_home_days 
as select bid_hrs_22 ,
sum(home) as home
from all_claims_365_2
group by bid_hrs_22;
quit;



//until here 

data all_claims_365_2;
set all_claims_365_1;
home=0;
array check ip ip_er ip_obs op_er op_obs sn ;
do over check;
if check=1 then home=0;
if check=. then home=1;
end;
run;


/* Creating order based off of RHF paper, dictating which claims if overlap should be primary. */
data all_claims_365_order;
set all_claims;
order=. ;
npi=.;
if (ip=1 or ip_er=1 or ip_obs=1) then order=1;
if ip_npi~=. or ip_er_npi~=. or ip_obs_npi~=. then npi=ip_npi;
if (op_er=1 or op_obs=1) and order=. then order=2;
if  op_er_npi~=. and npi=. then npi=op_er_npi;
if  op_obs_npi~=. and npi=. then npi=op_obs_npi;
if sn=1 and order=. then order=3;
if  sn_npi~=. and npi=. then npi=sn_npi;
if hh=1 and order=. then order=4;
if  hh_npi~=. and npi=. then npi=hh_npi;
if hs=1 and order=. then order=5;
if  hs_npi~=. and npi=. then npi=hs_npi;
if mds=1 and order=. then order=6;
if order=. then order=0;
run;

proc sort data=all_claims_548_order out=all_claims_548_order ;
by bid_hrs_22 date ;
run;

/* Creating transitions */
data transit_548;
set all_claims_548_order;
transition=0;
if bid_hrs_22=lag(bid_hrs_22) and (order~=lag(order) or (order=lag(order) and (npi~=lag(npi) or flag~=lag(flag)))) then transition=1;
run;

data transit_548_cnt;
set transit_548;
by bid_hrs_22;
if first.bid_hrs_22 then t_count=0;
if transition=1 then t_count+1;
run;

proc freq data=transit_548_cnt;
table t_count;
run;

proc sort data=transit_548_cnt;
by bid_hrs_22 descending t_count;
run;

/* Finding if there are enough transitions to be budensome */
data transit_548_cnt_1;
set transit_548_cnt;
by bid_hrs_22;
retain burd_t;
if first.bid_hrs_22 then burd_t=t_count;
run;

proc sort data=transit_548_cnt_1  ;
by bid_hrs_22 date ;
run;

/* Using burden transitions definition of 3 or more transitions to flag for a burdensome transition, as per burdensome transition definition */
data burd_365;
set transit_365_cnt_1;
flag_burd=0;
if burd_t>=3 then flag_burd=1 ;
run;


proc sort data=burd_90 nodupkey;
by bid_hrs_22 ;
run;

proc freq data=burd_90;
table flag_burd;
run;

data burd_90_label (keep=id bid_hrs_22 death_year index_date days_90 burd_t flag_burd)  ;
set burd_90;
label	days_90 = "90 days bef. index"
	  	flag_burd = "burdensome transition"
		burd_t = "# of burdensome transitions" ;
run;


proc export data=burd_90_label outfile="D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data\transitions.dta" replace; 
run;

H="Part C from MBSF--not needed now"
use "D:\NHATS\Shared\base_data\CMS_claims\Stata\mbsf_06_17.dta" , clear

//people who have died, Part C for them. 
keep if death_date!=.

gen death_month=month(death_date)
gen death_year=year(death_date)
tab death_month

gen ma=0
forvalues i=1/9{
replace ma=1 if bene_hmo_ind_0`i'!="0" & death_month==`i' 
}
forvalues i=10/12{
replace ma=1 if bene_hmo_ind_`i'!="0" & death_month==`i' 
}
keep if ma==1

rename (ptc_plan_type_cd_0* ptc_cntrct_id_0* ptc_pbp_id_0*) (ptc_plan_type_cd_* ptc_cntrct_id_* ptc_pbp_id_*)

gen ptc_plan =""
gen ptc_cntrct=""
gen ptc_pbp =""
forvalues i=1/12{
	replace ptc_plan=ptc_plan_type_cd_`i' if death_month==`i'
	replace ptc_cntrct=ptc_cntrct_id_`i' if death_month==`i'
	replace ptc_pbp=ptc_pbp_id_`i' if death_month==`i'
	
	}
rename year year_mbsf	
gen year=death_year
	
	
tempfile part1
save "`part1'"


// people who died in hospice, part c for the month before hospice enrollment


use "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Merged\STATA\hs_09_17.dta", clear

sort bene_id clm_hospc_start_dt_id

gen hospice_month= month(clm_hospc_start_dt_id)
gen hospice_year= year(clm_hospc_start_dt_id)

by bene_id, sort: egen ind_died_on_hospice=max(cond(inlist(ptnt_dschrg_stus_cd,"20","40","41","42"), 1,0))

keep if ind_died_on_hospice==1


bys bene_id: keep if _n==1
codebook bene_id

tempfile died_in_hs
save "`died_in_hs'"

use "D:\NHATS\Shared\base_data\CMS_claims\Stata\mbsf_06_17.dta" , clear

merge m:1 bene_id using "`died_in_hs'", nogen keep(matched)

gen prev_hs_month=hospice_month-1
gen prev_hs_year=hospice_year
replace prev_hs_year=prev_hs_year-1 if prev_hs_month==0
//replace prev_hs_month=12 if prev_hs_month==0

gen ma=.

forvalues i=1/9{
replace ma=1 if bene_hmo_ind_0`i'!="0" & prev_hs_month==`i' & hospice_year==prev_hs_year
}
forvalues i=10/11{
replace ma=1 if bene_hmo_ind_`i'!="0" & prev_hs_month==`i' & hospice_year==prev_hs_year
}

replace ma=1 if bene_hmo_ind_12!="0" & prev_hs_month==0 & hospice_year-1==prev_hs_year

keep if ma==1


rename (ptc_plan_type_cd_0* ptc_cntrct_id_0* ptc_pbp_id_0*) (ptc_plan_type_cd_* ptc_cntrct_id_* ptc_pbp_id_*)

gen ptc_plan_type_cd_0=""
gen ptc_cntrct_id_0 =""
gen ptc_pbp_id_0 =""

sort bene_id year
by bene_id: replace ptc_plan_type_cd_0=ptc_plan_type_cd_12[_n-1]
by bene_id: replace ptc_cntrct_id_0=ptc_cntrct_id_12[_n-1]
by bene_id: replace ptc_pbp_id_0=ptc_pbp_id_12[_n-1]


gen ptc_plan =""
gen ptc_cntrct=""
gen ptc_pbp =""
forvalues i=1/12{
	replace ptc_plan=ptc_plan_type_cd_`i' if prev_hs_month==`i'
	replace ptc_cntrct=ptc_cntrct_id_`i' if prev_hs_month==`i'
	replace ptc_pbp=ptc_pbp_id_`i' if prev_hs_month==`i'
	
	}

by bene_id: keep if _n==1

rename (year prev_hs_year) (year_mbsf year)

tempfile part2
save "`part2'"


use "`part1'"
merge 1:1 bene_id using "`part2'"

keep bene_id ptc* year hmoind12
save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\partc.dta", replace


use "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\int_data\SNP_2010_2019 yrs.dta", clear

rename (ptc_pbp_id ptc_contrct_id) (ptc_pbp ptc_cntrct)

duplicates drop year ptc_pbp ptc_cntrct, force
merge 1:m year ptc_pbp ptc_cntrct using "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\partc.dta", keep(using matched)


save "D:\NHATS\Projects\MA and EOL care\cka_ MA vs TM EOL quality\data\final data\partc_snp.dta", replace