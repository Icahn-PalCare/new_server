= V4 Outline MultiLine NoSorting TabWidth=30

H="Project Outline"
/* 
********************HEADING******************** 

Project Name: How variations in state Medicaid affect caregiver burden

Date Started: 6/5/19

Primary Investigator: Amy Kelley
Funding Source:

Created by: OKR

Primary Analyst: OKR
Secondary Analyst: EBL

Datasets Used: HRS core, exit & OOP via Kelley R01

Simple Outline:

/* Data paths */

global datapath "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data" //stealing R01 for base data 
global ooppath "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data"
global int "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data"
global fin "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\final_data"
global ref "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\reference_docs"


H="Step 1"
use  "D:\HRS\Shared\base_data\hrs_cms\Stata\bqsf_1998_2015.dta" , clear

gen medicaid = 0
replace medicaid = 1 if buyin_mo>0

gsort bid_hrs_22 -medicaid +start_dt  
by bid_hrs_22: gen inc_maid = 1 if _n==1 & medicaid==1
label var inc_maid "Incident Medicaid"

gen inc_maid_date =start_dt if inc_maid==1
label var inc_maid_date "Date of incident medicaid"

gen inc_maid_year = year(inc_maid_date)
gen age = round((inc_maid_date - bene_dob)/365.25)
label var age "Age at incident medicaid"

gen inc_lookback = inc_maid_date - 365
format %td inc_lookback inc_maid_date

by bid_hrs_22: carryforward inc_lookback inc_maid_date age inc_maid_year, replace

gen lookback = start_dt <= inc_lookback if inc_lookback!=. //12m look back to confirm incidence
/*
bysort bid_hrs_22: egen nolookback = max(lookback)
recode nolookback (0=1) (1=0)
label var nolookback "Were not Medicare beneficaries 12 months prior to incident Medicaid"
*/
keep bid_hrs_22 inc_maid_date inc_maid_year age lookback //nolookback
gsort bid_hrs_22 -lookback inc_maid_date
duplicates drop bid_hrs_22, force
gen all = 1

/**** Merge xwalk, core, helper, exit and pdem *****/
merge 1:1 bid_hrs_22 using "D:\HRS\Shared\base_data\hrs_cms\Stata\xref2015medicare.dta", keepus(hhid pn) keep(match) nogen
merge 1:m hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\core_00_to_14.dta", keep(match)

/*
gen no_hrs_core = 0
replace no_hrs_core = 1 if _m==1
label var no_hrs_core "No HRS Core 1998-2014"
cap drop _m
*/
merge 1:1 hhid pn core_year using "D:\HRS\Shared\raw\HRS\hrs_public_2014\dementia\pdem_withvarnames_00_14.dta", keep(master match) nogen keepus(pdem)
append using "D:\HRS\Shared\base_data\hrs_cleaned\exit_02_to_16_dt.dta"

gen year = core_year
replace year = exit_year if year==.

replace year = 9999 if year==. // dealing with people missing cores/exit


merge 1:1 hhid pn year using "D:\HRS\Shared\base_data\hrs_cleaned\helper_hours_2016.dta", keep(master match) nogen

/**** Flag availability of N1 & P1/Exit*****/
bysort id: egen date = max(inc_maid_date)
replace inc_maid_date = date
drop date 

gen core_in_24 = 0
replace core_in_24 = 1 if (c_ivw_date-inc_maid_date)<=730 & (c_ivw_date-inc_maid_date)>=0
replace core_in_24 = 1 if (e_ivw_date-inc_maid_date)<=730 & (e_ivw_date-inc_maid_date)>=0
label var core_in_24 "1+ Core/Exit interview within 24m post incident medicaid"

gen n1_in_48 = 0
replace n1_in_48 = 1 if (inc_maid_date-c_ivw_date)<=1460 & (inc_maid_date-c_ivw_date)>=0
label var n1_in_48 "N1 core interview within 48 months of incident medicaid" 

gen age_66 = 0
replace age_66 = 1 if age<66

gen dementia = .
replace dementia = 0 if pdem!=.
replace dementia = 1 if pdem>=0.5 & pdem!=.

gen before_maid = c_ivw_date<=inc_maid_date & inc_maid_date!=.

gen date = c_ivw_date
replace date = e_ivw_date if date==.

gen post_maid = (date>inc_maid_date) & date!=. & inc_maid_date!=.

cap drop id
gen id = hhid + pn
preserve
keep if before_maid==1

gsort id -c_ivw_date

by id: gen n1_flag = 1 if _n==1 
keep id n1_flag c_ivw_date
keep if n1_flag==1
tempfile dates
save `dates'
restore

replace c_ivw_date = 99 if c_ivw_date==.
merge m:1 id c_ivw_date using "`dates'", keepus(n1_flag) nogen
preserve
keep if post_maid==1
gsort id date
by id: gen p1_flag = 1 if _n==1
keep id p1_flag date
keep if p1_flag==1
tempfile p1 
save `p1'
restore

merge m:1 id date using "`p1'", keepus(p1_flag) nogen
replace dementia=. if n1_flag!=1 & p1_flag!=1
preserve

/*pull bmi from rand file */
use hhid pn r9bmi r8bmi r7bmi r6bmi r5bmi r4bmi r3bmi r2bmi r1bmi r11bmi r10bmi using "D:\HRS\Shared\raw\HRS\hrs_public_2014\rand2014\main\randhrs1992_2014v2.dta", clear

*tostring hhidpn, generate(id)

tempfile randbmi
save `randbmi'
restore

merge m:1 hhid pn using "`randbmi'", keep(match) nogen
drop bmi
gen bmi = .

local j = 1998
forvalues i = 4/11 {
replace bmi=r`i'bmi if core_year==`j'

local j = `j' + 2
}

merge 1:1 id core_year using "D:\HRS\Shared\base_data\hrs_cleaned\family_r_clean_98_14.dta", keepus(living_kids_ind) keep(master match) nogen

gen overweight = .
replace overweight = 0 if bmi<30
replace overweight = 1 if bmi>=30 & bmi!=.

sort id year
by id: carryforward srh_pf networth smoke_curr overweight living_kids_ind, replace

/***** Create Sample Derivation Variables *****/

bysort id: egen dem_cohort = max(dementia)
label var dem_cohort "Probable Dementia at N1/P1"

by id: egen no_core_24 = max(core_in_24)
recode no_core_24 (0=1) (1=0)
label var no_core_24 "No core/exit interview within 24m post incident medicaid"

by id: egen age_lt_66 = max(age_66) 
*recode age_lt_66 (1=0) (0=1)
label var age_lt_66 "Age less than 66 at incident Medicaid"

by id: egen drop_medicaid = max(medicaid)
label var drop_medicaid "No Medicaid State Buy-in 1998-2015"
recode drop_medicaid (1=0) (0=1)

by id: egen no_n1 = max(n1_in_48)
recode no_n1 (1=0) (0=1)
label var no_n1 "No N1 core interview within 48 months prior to Incident Medicaid"

by id: egen nolookback = max(lookback)
recode nolookback (0=1) (1=0)
label var nolookback "Were not Medicare beneficaries 12 months prior to incident Medicaid"

save $int\medicaid_cg_int.dta, replace

H="Step 2"
use $int\medicaid_cg_int.dta, clear

duplicates drop bid_hrs_22, force
tempfile medaid
save `medaid'

use "D:\HRS\Shared\base_data\hrs_cms\Stata\bqsf_1998_2015.dta" , clear
duplicates drop bid_hrs_22, force
merge 1:1 bid_hrs_22 using "`medaid'", keepus(hhid pn no_core_24 age_lt_66 drop_medicaid nolookback no_n1 inc_maid_year dem_cohort) //no_hrs_core)

drop if _m==2
gen all = 1

gen no_core_ever = 0
replace no_core_ever = 1 if _m==1
label var no_core_ever "No core interview 1998 - 2014"

local sampvars drop_medicaid age_lt_66 nolookback no_core_ever no_core_24 no_n1
local rd: word count all `sampvars' 1 1
label var all "All HRS Medicare Beneficiaries 1998-2015"

mat tab1 = J(`rd',1,.)

sum all
mat tab1[1,1]=r(N)

local r = 2
foreach x of local sampvars {
sum `x'
mat tab1[`r',1] = r(sum)
drop if `x'==1
local ++r
}

sum all
mat tab1[`r',1] = r(N)

local ++r

sum dem_cohort 
mat tab1[`r',1] = r(sum)


mat rownames tab1 = all `sampvars' "Final Sample" "Final Sample with Dementia"

frmttable using "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\output\sample_derivation_`c(current_date)'.rtf", ///
statmat(tab1) varlabels title("Sample Derivation") sdec(0) replace

keep hhid pn bid_hrs_22 
save $int\id_list.dta, replace

H="Step 3"
// pull tracker
use "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 hhid pn using $int/id_list.dta, keep(match)


keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

rename c_ivw_year year

tempfile states
save `states'

use $int\medicaid_cg_int.dta, clear
cap drop _m
merge 1:1 hhid pn year using "`states'", keep(match)

save $int\medicaid_cg_states.dta, replace

H="Step 4"
local importfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George"
local ltssfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George\LTSS Expenditures\LTSS Expenditures"

cd "`importfolder'"

//import all excel files (there are both .xls and .xlsx files here) with MSIS pops for years 2000-2012
local filelist1 : dir . files  "*.xls"
local filelist2 : dir . files "*.xlsx"

local year=0
foreach f of local filelist1 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}



foreach f of local filelist2 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}


di `year'

clear all
forvalues year=0/12 {
	append using `msis`year''
}

//keep national, because it may be useful for missing states (12 in 2012 are empty, and ME in 2010 is)
replace state="Total" if state=="TOTAL"
drop if inlist(substr(state,1,3),"CMS","*Br")
drop if missing(state)

//save to merge with ltss data later
tempfile msis
save `msis'

//must drop the total because it won't match with a LTSS file
drop if inlist(substr(state,1,3),"Tot")

//pull 
levelsof state, local(levels)


tokenize 81 85 86 90 91 95 96 00 01 05 06 10 11 14

foreach l of local levels {
	forvalues year=1(2)14 {
	import excel "`ltssfolder'\LTSS_Historic_Exp_`l'.xlsx", sheet("`l' ``year''-``=`year'+1'' Expenditures") cellrange(A2) ///
	firstrow case(lower) clear allstring
	keep servicetype fy*
	keep if inlist(servicetype,"Total LTSS", "Total Institutional LTSS", "Total HCBS", "Total Medicaid (all services)")
	gen state="`l'"
	reshape long fy, i(servicetype) 
	destring fy, replace
	levelsof _j, local(lev2)
	foreach lev of local lev2 {
		egen tot_hcbs`lev'=max(cond(_j==`lev' & servicetype=="Total HCBS"),fy,.)
		egen tot_inst_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total Institutional LTSS"),fy,.) 
		egen tot_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total LTSS"),fy,.)
		egen tot_medicaid`lev'=max(cond(_j==`lev' & servicetype=="Total Medicaid (all services)"),fy,.)  
}
	keep state tot*
	duplicates drop
	reshape long tot_hcbs tot_inst_ltss tot_ltss tot_medicaid, i(state) j(year)
	tempfile t`year'
	save `t`year''
}
	clear all
	forvalues year=1(2)14 {
	append using `t`year''
}
	tempfile `l'
	save ``l''
}

clear all
foreach l of local levels {
	append using ``l''
}

keep if inrange(year,2000,2012)

merge 1:1 state year using `msis', gen(msisltssm)

label var tot_ltss "Total LTSS"
label var tot_inst_ltss "Total Institutional LTSS"
label var tot_hcbs "Total HCBS"
label var tot_medicaid "Total Medicaid (all services)"
label var totalb "Total Beneficiaries"
label var age "Beneficiaries 65+"

save "msis_ltss_by_state.dta", replace


H="Step 5"
// Pull weights directly from tracker
use "D:\HRS\Shared\raw\HRS\hrs_tracking_2016\TRK2016TR_R.dta", clear

rename *, l

keep hhid pn fwgtr gwgtr hwgtr jwgtr kwgtr lwgtr mwgtr nwgtr owgtr gwgtrnh hwgtrnh jwgtrnh kwgtrnh lwgtrnh mwgtrnh nwgtrnh // no nursing home weight for 1998

tempfile weights
save `weights'

use $int\medicaid_cg_states.dta, replace

keep if n1_flag==1 | p1_flag==1

cap drop _m

merge m:1 hhid pn using "`weights'" , keep(match) nogen

gen regwt = .
replace regwt=fwgtr if year==1998 // no nursing home weight for 1998
replace regwt=gwgtr if year==2000
replace regwt=hwgtr if year==2002
replace regwt=jwgtr if year==2004
replace regwt=kwgtr if year==2006
replace regwt=lwgtr if year==2008
replace regwt=mwgtr if year==2010
replace regwt=nwgtr if year==2012

replace regwt=gwgtrnh if year==2000 & nhres==1
replace regwt=hwgtrnh if year==2002 & nhres==1
replace regwt=jwgtrnh if year==2004 & nhres==1
replace regwt=kwgtrnh if year==2006 & nhres==1
replace regwt=lwgtrnh if year==2008 & nhres==1
replace regwt=mwgtrnh if year==2010 & nhres==1
replace regwt=nwgtrnh if year==2012 & nhres==1


merge 1:1 id core_year using "D:\HRS\Shared\base_data\hrs_cleaned\family_r_clean_98_14.dta", keepus(living_kids_ind) keep(master match) nogen


merge m:1 id using "D:\HRS\Shared\base_data\hrs_cleaned\death_date_2015.dta", keepus(death_all) keep(master match) nogen

gen death_2_yr = 0
replace death_2_yr = 1 if (death_all - inc_maid_date)>=0 & (death_all-inc_maid_date)<=730
label var death_2_yr "Died within 2 years of incident medicaid"

egen any_adl_diff = anymatch(adl_diff_dr adl_diff_wk adl_diff_bh adl_diff_e adl_diff_tx adl_diff_t), values(1)

label var any_adl_diff "Difficulty with 1+ ADL"

egen any_adl_help = anymatch(adl_bh adl_bh_core adl_dr adl_dr_core adl_e adl_e_core adl_t adl_t_core adl_tx adl_tx_core adl_wk adl_wk_core), values(1)
label var any_adl_help "Received Help with 1+ ADL"

egen depression = anymatch(cesd1 depr_2_wks_hrs), values(1)

label var depression "Depression"

gen comor_4 = 0
replace comor_4 = 1 if comor_in_hrs>=4 & comor_in_hrs!=.
label var comor_4 "4+ Comorbidities"

gen paid_cg = 0
replace paid_cg = 1 if hlphrs_f>0 & hlphrs_f!=.
label var paid_cg "Paid Caregiver"

gen informal_cg = 0
replace informal_cg = hlphrs_i>0 & hlphrs_i!=.
label var informal_cg "Informal Caregiver"

replace hlphrs_i = 720 if hlphrs_i>720 & hlphrs_i!=. // capping helperhrs reported to 24hrs(max)*30days per person

label var hlphrs_i "Hours of informal caregiving in last 30 days"
replace hlphrs_i = . if hlphrs_i==0 // not counting zero hours in average hours


gen months_from_medicaid = date - inc_maid_date if p1_flag==1
replace months_from_medicaid = months_from_medicaid * 0.0329
replace months_from_medicaid = ceil(months_from_medicaid)
replace months_from_medicaid = 1 if months_from_medicaid==0
label var months_from_medicaid "Months between incident medicaid and core interview"


gen state=stateusps
merge m:1 state year using $ref\msis_ltss_by_state.dta, keep(match master) // nogen
gsort id -core_year
carryforward state tot_* totalben age6, replace
sort id core_year
carryforward state tot_* totalben age6, replace

preserve


//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\ref_docs\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A year
rename B state
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate
drop if year==.
tempfile genworth
save `genworth'

import excel "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\ref_docs\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet5") firstrow clear

rename MedianDailyRateNursingHomeD nh_rate
rename *, l
drop if year==.
tempfile nhrate
save `nhrate'

restore
merge m:1 state year using "`genworth'", keep(match master) keepus(hr_rate) nogen
merge m:1 state year using "`nhrate'", keep(master match) keepus(nh_rate) nogen

gen cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

destring hr_rate, replace
destring nh_rate, replace
replace hr_rate = hr_rate*cpi_rate
replace nh_rate = nh_rate*cpi_rate

merge m:1 hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", nogen keep(match) keepus(hisp_eth white black other_na_api_race degree gender)

foreach x in hisp_eth white black {
replace `x' = 0 if `x'==.
}

cap drop hseduc female

replace other_na_api_race = 1 if other_na_api_race==.
gen hseduc = 0 if degree==0
replace hseduc = 1 if degree>0 & degree!=.

gen female = 0 if gender==1
replace female = 1 if gender==2

*rename dem_cohort dementia
drop hhid pn degree gender
label var inc_maid_year "Incident medicaid year"
label var dementia "Dementia probablity >= 0.5 at P1" 
label var hseduc "HS Grad or GED"
label var female "female"

bysort id: egen age_max = max(age)
replace age = age_max
by id: egen maid_max = max(inc_maid_year)
replace inc_maid_year = maid_max
/*
egen any_nh = anymatch(nhres nhres_2yr nhres_2yr_exit), values(1)
label var any_nh "Any Nursing home stay in the past 2 years" 



replace livealone = 1 if hhm==0 & nhres!=1 & livealone==.
replace livealone = 0 if hhm>0 & hhm!=. & livealone==.
replace livealone  = 0 if nhres==1
*/

cap drop livealone
gen livealone = 0
replace livealone = 1 if hhm==0 & nhres==0
label var livealone "Live Alone In Community"

gen live_in_comm = 0
replace live_in_comm = 1 if hhm>0  & nhres==0
label var live_in_comm "Live In Community with Others"

gen nh_minority = 0
replace nh_minority = 1 if black==1 | other_na_api_race==1
label var nh_minority "Non-Hispanic Minority Race"

replace networth = networth*cpi_rate
label var networth "Total Networth including second home*"

local ivars female nh_minority white hisp_eth hseduc married srh_pf dem_cohort dm_hrs depression heart_hrs lung_hrs stroke_hrs smoke_curr living_kids_ind death_2_yr any_adl_diff any_adl_help paid_cg informal_cg overweight comor_4 nhres livealone live_in_comm
local cvars months_from_medicaid age networth hlphrs_i hr_rate nh_rate
local full `ivars' `cvars'

gsort id -n1_flag

by id: carryforward living_kids_ind wgtr regwt, replace //smoke_curr, helper hrs, overweight??
keep if p1_flag==1

foreach x in hcbs inst_ltss ltss medicaid {
	gen `x'_persenior=tot_`x'*cpi_rate/age65
}
replace medicaid_persenior=medicaid_persenior*age65/totalbe
drop cpi_rate


foreach x in hcbs inst_ltss ltss medicaid {
	xtile `x'_persenior_quart=`x'_persenior, nq(4)
}
rename medicaid_persenior_quart medicaid_perbene_quart

label var hcbs_persenior_quart "Quartile of state-level HCBS spending per senior"
label var inst_ltss_persenior_quart "Quartile of state-level Institutional LTSS spending per senior"
label var ltss_persenior_quart "Quartile of state-level LTSS spending per senior"
label var medicaid_perbene_quart "Quartile of state-level total Medicaid spending per beneficiary"

set seed 12
gen rid = runiform()*10000000
replace rid = abs(rid)

save $fin\medicaid_cg_burden_id.dta, replace 

foreach x of local full {

gen miss_`x' = missing(`x')
sum miss_`x'
di r(sum)

}

keep `ivars' `cvars' rid ltss_persenior_quart wgtr regwt

save $fin\medicaid_cg_burden.dta, replace

/*
drop id months_n1 months_p1 months_p2 months_from_p2 months_from_medicaid_n1 exit_ivw_n1 exit_ivw_p1

save $fin\medicaid_cg_burden.dta, replace 
*/

H="Tables"
use $fin\medicaid_cg_burden_id.dta, clear

cap drop all
gen all = 1
label var all "Weighted Population Estimates"

local ivars female black hisp_eth hseduc married srh_pf dem_cohort dm_hrs depression heart_hrs lung_hrs stroke_hrs smoke_curr living_kids_ind death_2_yr any_adl_diff any_adl_help paid_cg informal_cg overweight comor_4 nhres livealone live_in_comm
local cvars months_from_medicaid age networth hlphrs_i 


local rd: word count 1 `ivars' 1 `cvars' 1 1 1 1 1 1

mat tab1 = J(`rd',4,.)

local r = 2
*local c = 1

foreach x of local ivars {

forvalues c = 1/4 {

sum `x' [fweight=regwt]if ltss_persenior_quart==`c'

mat tab1[`r',`c'] = r(mean)*100
}
local ++r
}

local ++r

foreach x of local cvars {

forvalues c = 1/4 {

sum `x' [fweight=regwt] if ltss_persenior_quart==`c'

mat tab1[`r',`c'] = r(mean)
}
local ++r
}

forvalues c = 1/4 {

sum ltss_persenior [fweight=regwt] if ltss_persenior_quart==`c', d

mat tab1[`r',`c'] = r(p50)

local ++r
sum hr_rate [fweight=regwt] if ltss_persenior_quart==`c', d
mat tab1[`r',`c'] = r(p50)

local ++r
mat tab1[`r',`c'] = r(max)

local r = `r' - 2
}

local r = `r' + 3


forvalues c = 1/4 {

sum nh_rate [fweight=regwt] if ltss_persenior_quart==`c', d
mat tab1[`r',`c'] = r(p50)

local ++r
mat tab1[`r',`c'] = r(max)

local --r
}

local r = `r' + 2



forvalues c = 1/4 {

sum `x' [fweight=regwt] if ltss_persenior_quart==`c'

mat tab1[`r',`c'] = r(N)
}



mat rownames tab1 = "Categorical (%)" `ivars' "Continuous (mean)" `cvars' "Median LTSS per 65+*" "Median Hourly Rate for HH Aide*" "Maximum Hourly Rate for HH Aide*" "Median Daily NH Rate*" "Maximum Daily NH Rate*" all

mat list tab1 

frmttable using "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\output\Table1_`c(current_date)'.rtf", ///
statmat(tab1) varlabels ctitles("Variables", "LTSS Quartile 1", "LTSS Quartile 2", "LTSS Quartile 3", "LTSS Quartile 4") title("Exhibit 1") sdec(2) note("*Indicates reported value was inflation adjusted to 2016 dollars") replace

H="******* 4th Iteration ************"


H="Step 1"
use  "D:\HRS\Shared\base_data\hrs_cms\Stata\bqsf_1998_2015.dta" , clear

gen medicaid = 0
replace medicaid = 1 if buyin_mo>0

gsort bid_hrs_22 -medicaid +start_dt  
by bid_hrs_22: gen inc_maid = 1 if _n==1 & medicaid==1
label var inc_maid "Incident Medicaid"

gen inc_maid_date =start_dt if inc_maid==1
label var inc_maid_date "Date of incident medicaid"

gen inc_maid_year = year(inc_maid_date)
gen age = round((inc_maid_date - bene_dob)/365.25)
label var age "Age at incident medicaid"

gen inc_lookback = inc_maid_date - 365
format %td inc_lookback inc_maid_date

by bid_hrs_22: carryforward inc_lookback inc_maid_date age inc_maid_year, replace

gen lookback = start_dt <= inc_lookback if inc_lookback!=. //12m look back to confirm incidence
/*
bysort bid_hrs_22: egen nolookback = max(lookback)
recode nolookback (0=1) (1=0)
label var nolookback "Were not Medicare beneficaries 12 months prior to incident Medicaid"
*/
keep bid_hrs_22 inc_maid_date inc_maid_year age lookback //nolookback
gsort bid_hrs_22 -lookback inc_maid_date
duplicates drop bid_hrs_22, force

/**** Merge xwalk, core, helper, exit and pdem *****/
merge 1:1 bid_hrs_22 using "D:\HRS\Shared\base_data\hrs_cms\Stata\xref2015medicare.dta", keepus(hhid pn) keep(match) nogen
merge 1:m hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\core_00_to_14.dta", keep(match) nogen
merge 1:1 hhid pn core_year using "D:\HRS\Shared\raw\HRS\hrs_public_2014\dementia\pdem_withvarnames_00_14.dta", keep(master match) nogen keepus(pdem)
append using "D:\HRS\Shared\base_data\hrs_cleaned\exit_02_to_16_dt.dta"

gen year = core_year
replace year = exit_year if year==.
merge 1:1 id year using "D:\HRS\Shared\base_data\hrs_cleaned\helper_hours_2016.dta", keep(master match) nogen


/**** Flag availability of N1, P1 & P2/Exit *****/
bysort id: egen date = max(inc_maid_date)
replace inc_maid_date = date
drop date 

gen core_in_24 = 0
replace core_in_24 = 1 if (c_ivw_date-inc_maid_date)<=730 & (c_ivw_date-inc_maid_date)>=0
label var core_in_24 "1+ Core interview within 24m of incident medicaid"

gen core_exit_48 = 0
replace core_exit_48 = 1 if (c_ivw_date-inc_maid_date)>730 & (c_ivw_date-inc_maid_date)<=1460
replace core_exit_48 = 1 if (e_ivw_date-inc_maid_date)>730 & (e_ivw_date-inc_maid_date)<=1460
label var core_exit_48 "1+ Core/Exit within 24-48m of incident medicaid"

*bysort hhidpn inc_maid_date: carryforward inc_maid_date, replace

gsort id c_ivw_date
by id: gen n1_date = c_ivw_date[_n-1]

gen n1_in_36 = 0
replace n1_in_36 = 1 if (c_ivw_date-n1_date)<=1095 & core_in_24==1 & (n1_date < inc_maid_date)

label var n1_in_36 "N1 core interview within 36 months of P1"

gen age_66 = 0
replace age_66 = 1 if age<66

gen dementia = .
replace dementia = 0 if pdem!=. & (n1_in_36==1 | core_in_24==1)
replace dementia = 1 if pdem>=0.5 & pdem!=. & (n1_in_36==1 | core_in_24==1)

/***** Create Sample Derivation Variables *****/

bysort id: egen dem_cohort = max(dementia)
label var dem_cohort "Probable Dementia at P1"

by id: egen no_core_24 = max(core_in_24)
recode no_core_24 (0=1) (1=0)
label var no_core_24 "No core interview within 24m of incident medicaid"

by id: egen no_core_exit = max(core_exit_48)
recode no_core_exit (0=1) (1=0)
label var no_core_exit "No core/exit 24-48m of incident medicaid"

by id: egen age_lt_66 = max(age_66) 
*recode age_lt_66 (1=0) (0=1)
label var age_lt_66 "Age less than 66 at incident Medicaid"

by id: egen drop_medicaid = max(medicaid)
label var drop_medicaid "No Medicaid State Buy-in 1998-2015"
recode drop_medicaid (1=0) (0=1)

by id: egen no_n1 = max(n1_in_36)
recode no_n1 (1=0) (0=1)
label var no_n1 "No N1 core interview within 36 months of P1"

by id: egen nolookback = max(lookback)
recode nolookback (0=1) (1=0)
label var nolookback "Were not Medicare beneficaries 12 months prior to incident Medicaid"

save $int\medicaid_cg_int.dta, replace


H="Step 2"
use $int\medicaid_cg_int.dta, clear

duplicates drop bid_hrs_22, force
tempfile medaid
save `medaid'

use "D:\HRS\Shared\base_data\hrs_cms\Stata\bqsf_1998_2015.dta" , clear
duplicates drop bid_hrs_22, force
merge 1:1 bid_hrs_22 using "`medaid'", keepus(hhid pn no_core_24 no_core_exit age_lt_66 drop_medicaid nolookback no_n1 inc_maid_year)

drop if _m==2
gen all = 1

gen no_core_ever = 0
replace no_core_ever = 1 if _m==1
label var no_core_ever "No core interview 1998 - 2014"

local sampvars drop_medicaid age_lt_66 nolookback no_core_ever no_core_24 no_n1 no_core_exit
local rd: word count all `sampvars' 1
label var all "All HRS Medicare Beneficiaries 1998-2015"

mat tab1 = J(`rd',1,.)

sum all
mat tab1[1,1]=r(N)

local r = 2
foreach x of local sampvars {
sum `x'
mat tab1[`r',1] = r(sum)
drop if `x'==1
local ++r
}

sum all
mat tab1[`r',1] = r(N)

mat rownames tab1 = all `sampvars' "Final Sample"

frmttable using "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\output\sample_derivation_`c(current_date)'.rtf", ///
statmat(tab1) varlabels title("Sample Derivation") sdec(0) replace

keep hhid pn bid_hrs_22 
save $int\id_list.dta, replace

H="Step 3"
// pull tracker
use "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 hhid pn using $int/id_list.dta, keep(match)


keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

rename c_ivw_year year

tempfile states
save `states'

use $int\medicaid_cg_int.dta, clear

merge 1:1 hhid pn year using "`states'", keep(match)

save $int\medicaid_cg_states.dta, replace


H="Step 4"
local importfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George"
local ltssfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George\LTSS Expenditures\LTSS Expenditures"

cd "`importfolder'"

//import all excel files (there are both .xls and .xlsx files here) with MSIS pops for years 2000-2012
local filelist1 : dir . files  "*.xls"
local filelist2 : dir . files "*.xlsx"

local year=0
foreach f of local filelist1 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}



foreach f of local filelist2 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}


di `year'

clear all
forvalues year=0/12 {
	append using `msis`year''
}

//keep national, because it may be useful for missing states (12 in 2012 are empty, and ME in 2010 is)
replace state="Total" if state=="TOTAL"
drop if inlist(substr(state,1,3),"CMS","*Br")
drop if missing(state)

//save to merge with ltss data later
tempfile msis
save `msis'

//must drop the total because it won't match with a LTSS file
drop if inlist(substr(state,1,3),"Tot")

//pull 
levelsof state, local(levels)


tokenize 81 85 86 90 91 95 96 00 01 05 06 10 11 14

foreach l of local levels {
	forvalues year=1(2)14 {
	import excel "`ltssfolder'\LTSS_Historic_Exp_`l'.xlsx", sheet("`l' ``year''-``=`year'+1'' Expenditures") cellrange(A2) ///
	firstrow case(lower) clear allstring
	keep servicetype fy*
	keep if inlist(servicetype,"Total LTSS", "Total Institutional LTSS", "Total HCBS", "Total Medicaid (all services)")
	gen state="`l'"
	reshape long fy, i(servicetype) 
	destring fy, replace
	levelsof _j, local(lev2)
	foreach lev of local lev2 {
		egen tot_hcbs`lev'=max(cond(_j==`lev' & servicetype=="Total HCBS"),fy,.)
		egen tot_inst_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total Institutional LTSS"),fy,.) 
		egen tot_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total LTSS"),fy,.)
		egen tot_medicaid`lev'=max(cond(_j==`lev' & servicetype=="Total Medicaid (all services)"),fy,.)  
}
	keep state tot*
	duplicates drop
	reshape long tot_hcbs tot_inst_ltss tot_ltss tot_medicaid, i(state) j(year)
	tempfile t`year'
	save `t`year''
}
	clear all
	forvalues year=1(2)14 {
	append using `t`year''
}
	tempfile `l'
	save ``l''
}

clear all
foreach l of local levels {
	append using ``l''
}

keep if inrange(year,2000,2012)

merge 1:1 state year using `msis', gen(msisltssm)

label var tot_ltss "Total LTSS"
label var tot_inst_ltss "Total Institutional LTSS"
label var tot_hcbs "Total HCBS"
label var tot_medicaid "Total Medicaid (all services)"
label var totalb "Total Beneficiaries"
label var age "Beneficiaries 65+"

save "msis_ltss_by_state.dta", replace


H="Step 5"
use $int\medicaid_cg_states.dta, replace

gen ivw_b4_maid = 0
replace ivw_b4_maid = 1 if c_ivw_date < inc_maid_date

gsort id -ivw_b4_maid -c_ivw_date

gen n1flag = 0
by id: replace n1flag = 1 if _n==1
label var n1flag "N1 interview"

gsort id +ivw_b4_maid +c_ivw_date

gen p1flag = 0
by id: replace p1flag = 1 if _n==1
label var p1flag "P1 interview"

gen p2flag = 0
by id: replace p2flag = 1 if _n==2
label var p2flag "P2/Exit Interview"

keep if n1flag==1 | p1flag==1 | p2flag==1

gen ivwflag = .
replace ivwflag = 1 if n1flag==1
replace ivwflag = 2 if p1flag==1
replace ivwflag = 3 if p2flag==1

replace hlphrs_i = 720 if hlphrs_i>720 & hlphrs_i!=. // capping helperhrs reported to 24hrs(max)*30days per person
replace hlphrs_i = 0 if hlphrs_i==.

gsort id ivwflag
replace c_ivw_date = e_ivw_date if c_ivw_date==.

by id: gen months = c_ivw_date - c_ivw_date[_n-1]
replace months = months * 0.0329
replace months = ceil(months)
label var months "Months between interviews"

by id: gen prev_help_hrs = 1 if hlphrs_i[_n-1]>0 & hlphrs_i[_n-1]!=.
label var prev_help_hrs "Indicator any reported helper hours at previous interview"
by id: gen prev_hlp_i = hlphrs_i[_n-1]
label var prev_hlp_i "Reported helper hours at previous interview"
gen total_hlp = hlphrs_i*4 if prev_help_hrs==.
replace total_hlp = hlphrs_i*4 + (months-4)*((hlphrs_i + prev_hlp_i)/2) if prev_help_hrs!=.

gen months_from_medicaid = c_ivw_date - inc_maid_date if ivwflag>1
replace months_from_medicaid = months_from_medicaid * 0.0329
replace months_from_medicaid = ceil(months_from_medicaid)
replace months_from_medicaid = 1 if months_from_medicaid==0
label var months_from_medicaid "Months between incident medicaid and core interview"


gen state=stateusps
merge m:1 state year using $ref\msis_ltss_by_state.dta, keep(match master) nogen
gsort id -core_year
carryforward state tot_* totalben age6, replace
sort id core_year
carryforward state tot_* totalben age6, replace

gen cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

foreach x in hcbs inst_ltss ltss medicaid {
	gen `x'_persenior=tot_`x'*cpi_rate/age65
}
replace medicaid_persenior=medicaid_persenior*age65/totalbe
drop cpi_rate


foreach x in hcbs inst_ltss ltss medicaid {
	xtile `x'_persenior_quart=`x'_persenior, nq(4)
}
rename medicaid_persenior_quart medicaid_perbene_quart

label var hcbs_persenior_quart "Quartile of state-level HCBS spending per senior"
label var inst_ltss_persenior_quart "Quartile of state-level Institutional LTSS spending per senior"
label var ltss_persenior_quart "Quartile of state-level LTSS spending per senior"
label var medicaid_perbene_quart "Quartile of state-level total Medicaid spending per beneficiary"


gen exit_ivw = 0
replace exit_ivw = 1 if exit_year!=.

replace core_year = exit_year if exit_ivw==1
replace nhres_2yr = nhres_2yr_exit if exit_ivw==1
replace proxy_core = proxy_exit if exit_ivw==1

foreach x in adl_dr adl_wk adl_bh adl_e adl_tx adl_t {
replace `x'_core = `x' if exit_ivw==1
}


keep dem_cohort hhid pn id age inc_maid_year adl_diff_bh adl_diff_dr adl_diff_e ///
adl_diff_t adl_diff_tx adl_diff_wk adl_dr_core adl_e_core adl_t_core adl_tx_core ///
adl_wk_core adl_bh_core comor_in_hrs core_year ///
married nhres nhres_2yr proxy_core srh_pf smoke_curr smoke_ever /*ltss_cat*/ ///
networth months_from_medicaid ltss_persenior_quart n1flag p1flag p2flag total_hlp months exit_ivw

merge m:1 hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", nogen keep(match) keepus(hisp_eth white black other_na_api_race degree gender)

foreach x in hisp_eth white black {
replace `x' = 0 if `x'==.
}


replace other_na_api_race = 1 if other_na_api_race==.
gen hseduc = 0 if degree==0
replace hseduc = 1 if degree>0 & degree!=.

gen female = 0 if gender==1
replace female = 1 if gender==2

rename dem_cohort dementia
drop hhid pn degree gender
label var inc_maid_year "Incident medicaid year"
label var dementia "Dementia probablity >= 0.5 at P1" 
label var hseduc "HS Grad or GED"
label var female "female"


gen ivw_label = "p1" if p1flag==1
replace ivw_label = "p2" if p2flag==1
replace ivw_label = "n1" if n1flag==1

bysort id: egen age_max = max(age)
replace age = age_max
by id: egen maid_max = max(inc_maid_year)
replace inc_maid_year = maid_max

drop n1flag p1flag p2flag age_max maid_max

local all adl_diff_bh adl_diff_dr adl_diff_e adl_diff_t adl_diff_tx adl_diff_wk adl_dr_core ///
adl_e_core adl_t_core adl_tx_core adl_wk_core adl_bh_core comor_in_hrs core_year married nhres ///
nhres_2yr proxy_core srh_pf smoke_curr smoke_ever /*ltss_cat*/ networth months_from_medicaid ///
ltss_persenior_quart total_hlp months exit_ivw

foreach x of local all {
rename `x' `x'_
local all2 `all2' `x'_
}

reshape wide `all2', i(id) j(ivw_label) string

sort id 
set seed 123
gen rid = runiform()*10000000
replace rid = abs(rid)

gen months_from_p2 = 24 - months_from_medicaid_p1
replace total_hlp_p2 = (total_hlp_p2/months_p2) * months_from_p2

gen hlphrs_post_2yr = .
replace hlphrs_post_2yr = total_hlp_p1 if months_from_medicaid_p1<=24
replace hlphrs_post_2yr = hlphrs_post_2yr + total_hlp_p2 if months_from_medicaid_p1<24

label var hlphrs_post_2yr "Total hours of informal care 2yrs post incident medicaid"
label var exit_ivw_p2 "Indicator that P2 is an exit interview"


save $fin\medicaid_cg_burden_id.dta, replace 

drop id months_n1 months_p1 months_p2 months_from_p2 months_from_medicaid_n1 exit_ivw_n1 exit_ivw_p1

save $fin\medicaid_cg_burden.dta, replace 

H="********* 3rd Iteration (OLD) ************"


H="Identifying index medicaid and cores need for computation"
use  "D:\HRS\Shared\base_data\hrs_cms\Stata\bqsf_1998_2015.dta" , clear

gen medicaid = 0
replace medicaid = 1 if buyin_mo>0

gsort bid_hrs_22 -medicaid +start_dt  
*browse bid_hrs_22 medicaid start_dt
by bid_hrs_22: gen inc_maid = 1 if _n==1 & medicaid==1
label var inc_maid "Incident Medicaid"

gen inc_maid_date =start_dt if inc_maid==1
label var inc_maid_date "Date of incident medicaid"

gen inc_maid_year = year(inc_maid_date)
gen age = round((inc_maid_date - bene_dob)/365.25)
label var age "Age at incident medicaid"


/*** sample derivation ***/
preserve
by bid_hrs_22: egen drop_medicaid = max(medicaid)
label var drop_medicaid "No Medicaid State Buy-in 1998-2015"

by bid_hrs_22: keep if _n==1

recode drop_medicaid (1=0) (0=1)

save $int\samplederivation.dta, replace 
restore
/**** ---------------- ***/

gen inc_lookback = inc_maid_date - 365
format %td inc_lookback inc_maid_date

by bid_hrs_22: carryforward inc_lookback inc_maid_date age inc_maid_year, replace

gen lookback = start_dt <= inc_lookback if inc_lookback!=. //12m look back to confirm incidence

/*** Sample Derivation ***/
preserve
*keep if lookback!=1
bysort bid_hrs_22: egen nolookback = max(lookback)
recode nolookback (0=1) (1=0)
label var nolookback "Were not Medicare beneficaries 12 months prior to incident Medicaid"
keep bid_hrs_22 start_dt nolookback inc_maid_date

merge 1:1 bid_hrs_22 start_dt using $int\samplederivation.dta, keep(match) nogen
save $int\samplederivation.dta, replace
restore
**** ----------------- ****/

keep if lookback==1
keep bid_hrs_22 inc_maid_date inc_maid_year age
duplicates drop bid_hrs_22, force

merge 1:1 bid_hrs_22 using "D:\HRS\Shared\base_data\hrs_cms\Stata\xref2015medicare.dta", keepus(hhid pn) keep(match) nogen
merge 1:m hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\core_00_to_14.dta", keep(match) nogen
merge 1:1 hhid pn core_year using "D:\HRS\Shared\raw\HRS\hrs_public_2014\dementia\pdem_withvarnames_00_14.dta", keep(master match) nogen keepus(pdem)

gen samp = 0
replace samp = 1 if (c_ivw_date- inc_maid_date)>=730 & (c_ivw_date - inc_maid_date)<2555
bysort id: egen insamp = max(samp)

/**** Sample Derivation ****/
preserve
gen age_lt_65 = 0
replace age_lt_65 = 1 if age<65
label var age_lt_65 "Age less than 65 at incident Medicaid"

gen no_ivw = 0
replace no_ivw = 1 if insamp!=1
label var no_ivw "No core interview 2-6 years post incident Mediciad"

drop if age==.
keep bid_hrs_22 inc_maid_date age_lt_65 no_ivw
duplicates drop

merge 1:1 bid_hrs_22 inc_maid_date using $int\samplederivation.dta, nogen

save $int\samplederivation.dta, replace
/***** -------------------- ****/
restore

keep if age>=65 & insamp==1

gen dem_cohort = 0 if pdem!=.
replace dem_cohort = 1 if pdem>=0.5 & pdem!=.

save $int\fullcore.dta, replace

drop if (c_ivw_date - inc_maid_date)>=2555
*drop if c_ivw_date<inc_maid_date

gsort id -core_year
by id: gen nflag = _n
replace nflag = nflag - 1

save "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data\samplecore.dta", replace

H="OOP & informal costs calculation"
global datapath "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data"
*local logpath "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\logs"
global ooppath "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\data\int_data"
*global output "E:\projects\burden_dementia\archive logs"
global int "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data"

/* Start with OOP dataset and then get interview dates for core and exit + death date */

use $ooppath\oopme_final_2016.dta, clear
drop nh_nights
rename *, l
gen id=hhid+pn

replace private_ltc=long_term_care if !missing(long_term_care)
foreach x in mc_b private_ltc {
	replace `x'_prem=`x'
	drop `x'
}



rename year core_year
merge 1:1 hhid pn core_year using "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data\samplecore.dta", keepus(c_ivw_date c_ivw_month c_ivw_year nflag) keep(match) nogen

gen year = core_year

merge 1:1 id year using "D:\HRS\Shared\base_data\hrs_cleaned\helper_hours_2016.dta", ///
keepus(n_i hlphrs_i *_s *_k *_f)
drop if _m==2
drop _m

/*
gsort id -year 
by id: gen next_date = c_ivw_date[_n+1]
format index_date next_date %td

gen death2_n1 = index_date - next_date if nflag==0

levelsof id if death2_n1<-30, local(drop)

foreach x of local drop {
replace droplist = 1 if id=="`x'"
}
drop if droplist==1

replace death2_n1 = death2_n1 * 0.0329
replace death2_n1 = ceil(death2_n1)
replace death2_n1 = 1 if death2_n1==0
replace months = death2_n1 if exit==1
*/

/* Capping OOP RX spending to $300/month to bring in line with Medicare Part D and
previous OOP paper */

replace rx_oop = 0 if rx_oop==.
gen rx_per_mo = rx_oop/months
replace rx_per_mo = 300 if rx_per_mo>0 & rx_per_mo!=.

gen mod_rx_oop = rx_per_mo * months

replace total_oop = total_oop - rx_oop + mod_rx_oop

/* Modifying Helper HRS + Helper OOP to match Helper hours imputation in previous OOP paper */

gsort id -year

replace hlphrs_i = 720 if hlphrs_i>720 & hlphrs_i!=. // capping helperhrs reported to 24hrs(max)*30days per person

foreach x in s k f {
	replace hlphrs_`x'=720 if hlphrs_`x'>720 & !missing(hlphrs_`x')
	replace hlphrs_`x'=0 if hlphrs_`x'==.
	replace hlphrs_`x'=hlphrs_i if hlphrs_`x'>hlphrs_i
}

gen hlphrs_ns=hlphrs_i-hlphrs_s
gen hlphrs_oth=hlphrs_i-hlphrs_s-hlphrs_k
gen hlphrs_oth_flag=hlphrs_oth<0
replace hlphrs_oth=0 if hlphrs_oth<0

by id: gen prev_help_hrs = 1 if hlphrs_i[_n+1]>0 & hlphrs_i[_n+1]!=. //check for helper hrs at prev ivw
by id: gen prev_hrs = hlphrs_i[_n+1] if hlphrs_i[_n+1]>0
by id: gen prev_oop_yes = 1 if helper_oop[_n+1]>0 & helper_oop[_n+1]!=.
by id: gen prev_hlp_oop = (helper_oop[_n+1]/months[_n+1]) if helper_oop[_n+1]>0

foreach x in s k f ns oth {
	by id: gen prev_hlp_hrs_`x'=1 if hlphrs_i[_n+1]>0 & hlphrs_i[_n+1]!=.
	by id: gen prev_hrs_`x'=hlphrs_`x'[_n+1] if hlphrs_i[_n+1]>0
}

gen helper_oop_per_mo = helper_oop/months
gen mod_helper_oop = helper_oop_per_mo * 4 if prev_oop_yes==. & months>=4
replace mod_helper_oop = helper_oop_per_mo * months if months<4
replace mod_helper_oop = (helper_oop_per_mo*4) + (months-4)*((helper_oop_per_mo+prev_hlp_oop)/2) ///
if prev_oop_yes==1 & months>=4
*replace mod_helper_oop = 

replace total_oop = total_oop - helper_oop + mod_helper_oop

/* Creating approximate 2/4 year helper hours based on above fomula */

gen total_hlp = hlphrs_i*4 if prev_help_hrs==. & months>=4
replace total_hlp=hlphrs_i*months if months<4
replace total_hlp = (hlphrs_i*4) + (months-4)*((hlphrs_i+prev_hrs)/2) ///
if prev_help_hrs==1 & months>=4

replace total_hlp = 0 if total_hlp==. // estimated total hours per interview

foreach x in s k f ns oth {
	gen total_hlp_`x'=hlphrs_`x'*4 if prev_help_hrs==. & months>=4
	replace total_hlp_`x'=hlphrs_`x'*months if months<4
	replace total_hlp_`x'=(hlphrs_`x'*4) + (months-4)*((hlphrs_`x'+prev_hrs_`x')/2) ///
	if prev_help_hrs==1 & months>=4
	replace total_hlp_`x'=0 if total_hlp_`x'==.
}

/* Create year variables to merge helper hours with yearly genworth costs */

gen c_ivw_year_n0 = c_ivw_year
*replace c_ivw_year_n0 = index_year if nflag==0
gen c_ivw_year_n1 = c_ivw_year_n0 - 1
label var c_ivw_year_n1 "calendar year prior to ivw date"
gen c_ivw_year_n2 = c_ivw_year_n0 - 2
label var c_ivw_year_n2 "calendar year 2 yrs prior to ivw date"
gen c_ivw_year_n3 = c_ivw_year_n0 - 3
label var c_ivw_year_n3 "calendar year 3 yrs prior to ivw date"
gen c_ivw_year_n4 = c_ivw_year_n0 - 4
label var c_ivw_year_n4 "calendar year 4 yrs prior to ivw date"
gen c_ivw_year_n5 = c_ivw_year_n0 - 5
label var c_ivw_year_n5 "calendar year 5 yrs prior to ivw date"

cap drop stateusups

save $int/cg_cost_int.dta, replace


/************** Get State information from tracker to match with genworth *************/
cd $int

use cg_cost_int.dta, clear
keep id

duplicates drop id, force
tempfile id
save `id'

// creating CPI-U 
clear
set obs 21
gen obs = _n
gen year = .
gen cpi_rate = .

forvalues i=1/21 {

replace year = 2017 - `i' if obs==`i'

}

replace cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

rename year c_ivw_year
label var cpi_rate "Inflation adjustment factor"
tempfile cpi
save `cpi'

// pull tracker
use "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", clear
drop id
gen id=hhid+pn

merge 1:1 id using "`id'"
keep if _m==3

keep hhid pn stateusps* zipcode*

gen stateusps16 = stateusps14
gen zipcode16 = zipcode14

foreach x of varlist stateusps* {

replace `x' = "" if `x'=="ZZ"

}

gen stateusps97=""
gen stateusps99=""

forvalues i= 1(2)15{
gen stateusps`i'=""
gen zipcode`i' = ""
}

forvalues i=0(2)8{
rename stateusps0`i' stateusps`i'
rename zipcode0`i' zipcode`i'
}
reshape long stateusps zipcode, i(hhid pn) j(c_ivw_year)

forvalues i=0/99{
qui replace c_ivw_year=200`i' if c_ivw_year==`i' & c_ivw_year<=9
qui replace c_ivw_year=20`i' if c_ivw_year==`i' & inrange(c_ivw_year, 10,16)
qui replace c_ivw_year=19`i' if c_ivw_year==`i' & c_ivw_year>=90
}

gen id= hhid+pn
sort id c_ivw_year
drop if id==""
by id: carryforward stateusps, replace

gsort id -c_ivw_year
by id: carryforward stateusps, replace

gen e_ivw_year=c_ivw_year
merge m:1 c_ivw_year using "`cpi'", keepus(cpi_rate)
cap drop _m

rename c_ivw_year c_ivw_year_n0
tempfile state
save "`state'"


rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename cpi_rate cpi_rate_n1
tempfile state_n1
save `state_n1'

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2 
rename cpi_rate_n1 cpi_rate_n2
tempfile state_n2
save `state_n2'

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3 
rename cpi_rate_n2 cpi_rate_n3
tempfile state_n3
save `state_n3'

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename cpi_rate_n3 cpi_rate_n4
tempfile state_n4
save `state_n4'

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename cpi_rate_n4 cpi_rate_n5
tempfile state_n5
save `state_n5'



use cg_cost_int.dta, clear
/*
gen e_ivw_year=year(e_ivw_date)
replace e_ivw_year=exit_year if missing(e_ivw_year)
merge m:1 id e_ivw_year using "`state'"
drop if _m==2
drop _m
*/

merge m:1 id c_ivw_year_n0 using "`state'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n1 using "`state_n1'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n2 using "`state_n2'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n3 using "`state_n3'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n4 using "`state_n4'"
drop if _m==2
cap drop _m
merge m:1 id c_ivw_year_n5 using "`state_n5'"
drop if _m==2
cap drop _m


save cg_cost_intb.dta, replace

//merging with the Genworth/Metlife hourly home health aide cost. 
import excel "D:\HRS\Projects\dementia_decedents\ask_r01_financial_burden_dementia_7_yrs\ref_docs\Cost Care Survey (Genworth-Metlife)\HHA_hourly_genworth.xlsx", sheet("Sheet1") firstrow clear

rename A c_ivw_year
rename B stateusps
rename HomeHealthAideServicesHourly state_hha
rename MedianHourlyRate hr_rate

drop if c_ivw_year==.
destring hr_rate, replace

expand 2 if c_ivw_year==1998, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
cap drop duptag

expand 2 if c_ivw_year==1997, gen(duptag)

replace c_ivw_year = c_ivw_year - 1 if duptag==1
drop duptag

//3/6/19-ebl-was not merging with exit data, so we were missing those years
gen e_ivw_year=c_ivw_year

rename c_ivw_year c_ivw_year_n0

tempfile rate
save "`rate'" // hourly rate for calendar c_ivw_year of i

rename c_ivw_year_n0 c_ivw_year_n1
rename stateusps stateusps_n1
rename state_hha state_hha_n1
rename hr_rate hr_rate_n1

tempfile rate_n1
save "`rate_n1'"

rename c_ivw_year_n1 c_ivw_year_n2
rename stateusps_n1 stateusps_n2
rename state_hha_n1 state_hha_n2
rename hr_rate_n1 hr_rate_n2

tempfile rate_n2
save "`rate_n2'"

rename c_ivw_year_n2 c_ivw_year_n3
rename stateusps_n2 stateusps_n3
rename state_hha_n2 state_hha_n3
rename hr_rate_n2 hr_rate_n3

tempfile rate_n3
save "`rate_n3'"

rename c_ivw_year_n3 c_ivw_year_n4
rename stateusps_n3 stateusps_n4
rename state_hha_n3 state_hha_n4
rename hr_rate_n3 hr_rate_n4

tempfile rate_n4
save "`rate_n4'"

rename c_ivw_year_n4 c_ivw_year_n5
rename stateusps_n4 stateusps_n5
rename state_hha_n4 state_hha_n5
rename hr_rate_n4 hr_rate_n5

tempfile rate_n5
save "`rate_n5'"


use cg_cost_intb.dta, clear
cap drop _m
merge m:1 c_ivw_year_n0 stateusps using "`rate'"
drop if _m==2
cap drop _m
/*
merge m:1 e_ivw_year stateusps using "`rate'"
drop if _m==2
cap drop _m
*/
merge m:1 c_ivw_year_n1 stateusps_n1 using "`rate_n1'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n2 stateusps_n2 using "`rate_n2'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n3 stateusps_n3 using "`rate_n3'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n4 stateusps_n4 using "`rate_n4'"
drop if _m==2
cap drop _m
merge m:1 c_ivw_year_n5 stateusps_n5 using "`rate_n5'"
drop if _m==2
cap drop _m


save cg_cost_intc.dta, replace


use cg_cost_intc.dta, replace
/*
gen mar_n0 = . //months observed (aka "at risk") within a calendar year for helper hours cost imputation
gen mar_n1 = .
gen mar_n2 = .
gen mar_n3 = .
gen mar_n4 = .
gen mar_n5 = .


// exit ivw
replace mar_n0 = index_month if nflag==0
replace mar_n0 = death2_n1 if (death2_n1-mar_n0 < 0) & nflag==0 // if they died the same year as their N1 ivw, then

replace mar_n1 = death2_n1 - mar_n0 if nflag==0
replace mar_n1 = 0 if mar_n1<0 & nflag==0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag==0

replace mar_n2 = death2_n1 - mar_n0 -mar_n1 if nflag==0
replace mar_n2 = 0 if mar_n2<0 & nflag==0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag==0

replace mar_n3 = death2_n1 - mar_n0 -mar_n1 -mar_n2 if nflag==0
replace mar_n3 = 0 if mar_n3<0 & nflag==0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag==0

replace mar_n4 = death2_n1 - mar_n0 -mar_n1 -mar_n2 - mar_n3 if nflag==0
replace mar_n4 = 0 if mar_n4<0 & nflag==0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag==0

// core ivw

replace mar_n0 = c_ivw_month if nflag>0
replace mar_n1 = months - c_ivw_month if nflag>0
replace mar_n1 = 0 if mar_n1<0 & nflag>0
replace mar_n1 = 12 if (mar_n1>12 & mar_n1!=.) & nflag>0

replace mar_n2 = months - 12 - c_ivw_month if nflag>0
replace mar_n2 = 0 if mar_n2<0 & nflag>0
replace mar_n2 = 12 if (mar_n2>12 & mar_n2!=.) & nflag>0

replace mar_n3 = months - 24 - c_ivw_month if nflag>0
replace mar_n3 = 0 if mar_n3<0 & nflag>0
replace mar_n3 = 12 if (mar_n3>12 & mar_n3!=.) & nflag>0

replace mar_n4 = months - 36 - c_ivw_month if nflag>0
replace mar_n4 = 0 if mar_n4<0 & nflag>0
replace mar_n4 = 12 if (mar_n4>12 & mar_n4!=.) & nflag>0

replace mar_n5 = months - 48 - c_ivw_month if nflag>0
replace mar_n5 = 0 if mar_n5<0 & nflag>0
replace mar_n5 = 12 if (mar_n5>12 & mar_n5!=.) & nflag>0
*/


// impute mean hourly rate for people missing states
//3/5/19-ebl-replace with national median in 2016
//3/6/19-ebl-hopefully fixed the merging issue with exits, so there shouldn't be missingness, leaving commented out for now
/*
foreach x in "" _n1 _n2 _n3 _n4 _n5 {
	replace cpi_rate`x'=1 if missing(cpi_rate`x')
	replace hr_rate`x'=20.25 if missing(hr_rate`x')
}

*/
foreach x of varlist hr_rate hr_rate_n1 hr_rate_n2 hr_rate_n3 hr_rate_n4 hr_rate_n5 cpi_rate cpi_rate_n1 cpi_rate_n2 cpi_rate_n3 cpi_rate_n4 cpi_rate_n5 {

replace `x' = 0 if `x'==.
}

gen hlp_i=total_hlp/months

foreach x in s k f ns oth {
	gen hlp_`x'=total_hlp_`x'/months
}

foreach x of varlist total_hlp {

*replace `x' = `x'/months // average # of helpers per month after 4/20 split
replace `x' = (`x'*hr_rate*cpi_rate) 
}

/*
foreach x in mc_b_prem private_ltc_prem nh_oop {
	replace `x'=0 if missing(`x')
	replace `x' = `x'/months
}
*/
save cg_cost_intd.dta, replace

use cg_cost_intd.dta, replace

cap drop hlp

gen hlp = total_hlp / months


cap drop oop 
gen oop = total_oop / months

keep id core_year nflag oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth months mc_b_prem private_ltc_prem nh_oop

reshape wide core_year oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth months mc_b_prem private_ltc_prem nh_oop, i(id) j(nflag)

forvalues i = 1/7 {

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {

gen `x'_y`i'=.

}

}
// Annualized Costs - Year 1

* start with oop at exit if months < 12. Subtract months - 12 so that it can be pulled from N1
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y1 = `x'0 * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12

* Pulling the leftover months from N1 (if exit < 12)
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y1 = `x'_y1 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

*Using full exit if exit months==12
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y1 = `x'0 * 12 if months0==12
}

replace months0 = 0 if months0==12

* Using 12 months from exit if exit months>12
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y1 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.
replace months0 = . if months0 <=0

// Annualized Costs - Year 2

* People with leftover oop exit data
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'0  * months0 if months0<12
}

replace months0 = months0 - 12 if months0<12


foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'_y2 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.


* People with no exit data leftover from y1

gen noop = 1 if oop_y2==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'_y2 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y2 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1
replace months0 = . if months0<=0
replace months1 = . if months1<=0
drop noop

// oop_y3

* People with leftover oop exit data
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 = `x'_y3 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 = `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'0 * 12 if months0>12 & months0!=.
}

replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'_y3 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y3==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y3 =   `x'2 * 12 if noop==1
}
replace months2 = months2 - 12 if noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 

// Annual Costs - Year 4


* People with leftover oop exit data
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'_y4 + (-months0)*`x'1 if months0<0
}
replace months1 = months1 + months0 if months0<0

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0==12
}
replace months0 = months0 - 12 if months0==12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =   `x'1 * months1 if months1<12 & noop==1
}
replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'_y4 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1==12 & noop==1
}
replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y4==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'_y4 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y4 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0

drop noop 


// oop_y5

* People with leftover oop exit data
foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'0 * months0 if months0<12
}
replace months0 = months0 - 12 if months0<12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'_y5 + (-months0)*`x'1 if months0<0
}

replace months1 = months1 + months0 if months0<0

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0==12
}

replace months0 = months0 - 12 if months0==12

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'0 * 12 if months0>12 & months0!=.
}
replace months0 = months0 - 12 if months0>12 & months0!=.

* People with leftover N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'_y5 + (-months1)*`x'2 if months1<0 & noop==1
}
replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'1 * 12 if months1>12 & months1!=. & noop==1
}
replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y5==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 =  `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 = `x'_y5 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 = `x'2 * 12  if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y5==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y5 = `x'3 * 12 if noop==1
}

replace months3 = months3 - 12 if noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// oop_y6

* People with leftover N1

gen noop = 1 if oop_y6==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'_y6 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y6==.


foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'2 * months2 if months2<12 & noop==1
}

replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'_y6 + (-months2)*`x'3 if months2<0 & noop==1
}

replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'2 * 12 if months2==12 & noop==1
}

replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y6==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 = `x'3 * months3 if months3<12 & noop==1
}
replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 =  `x'_y6 + (-months3)*`x'4 if months3<0 & noop==1
}

replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3==12 & noop==1
}


replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y6 =  `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop

// Annual Costs - Year 7

* People with leftover N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 =  `x'1 * months1 if months1<12 & noop==1
}

replace months1 = months1 - 12 if months1<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 =`x'_y7 + (-months1)*`x'2 if months1<0 & noop==1
}

replace months2 = months2 + months1 if months1<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'1 * 12 if months1==12 & noop==1
}

replace months1 = months1 - 12 if months1==12 & noop==1


foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'1 * 12 if months1>12 & months1!=. & noop==1
}

replace months1 = months1 - 12 if months1>12 & months1!=. & noop==1

drop noop

* People who exhausted N0 & N1

gen noop = 1 if oop_y7==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'2 * months2 if months2<12 & noop==1
}
replace months2 = months2 - 12 if months2<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'_y7 + (-months2)*`x'3 if months2<0 & noop==1
}
replace months3 = months3 + months2 if months2<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2==12 & noop==1
}
replace months2 = months2 - 12 if months2==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 =  `x'2 * 12 if months2>12 & months2!=. & noop==1
}

replace months2 = months2 - 12 if months2>12 & months2!=. & noop==1

drop noop 

* People who exhausted N0, N1 & N2

gen noop = 1 if oop_y7==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'3 * months3 if months3<12 & noop==1
}

replace months3 = months3 - 12 if months3<12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 =  `x'_y7 + (-months3)*`x'4 if months3<0 & noop==1
}
replace months4 = months4 + months3 if months3<0 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'3 * 12 if months3==12 & noop==1
}

replace months3 = months3 - 12 if months3==12 & noop==1

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'3 * 12 if months3>12 & months3!=. & noop==1
}

replace months3 = months3 - 12 if months3>12 & months3!=. & noop==1


replace months0 = . if months0<=0
replace months1 = . if months1<=0
replace months2 = . if months2<=0
replace months3 = . if months3<=0

drop noop
* People who exhausted N0, N1, N2 & N3

gen noop = 1 if oop_y7==.

foreach x in oop hlp hlp_s hlp_k hlp_f hlp_ns hlp_i hlp_oth mc_b_prem private_ltc_prem  nh_oop {
replace `x'_y7 = `x'4 * 12 if noop==1
}




gen oop_7yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6 + oop_y7
gen oop_6yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5 + oop_y6
gen oop_5yr = oop_y1+ oop_y2+ oop_y3+ oop_y4+ oop_y5
gen oop_4yr = oop_y1+ oop_y2+ oop_y3+ oop_y4
gen oop_3yr = oop_y1+ oop_y2+ oop_y3
gen oop_2yr = oop_y1+ oop_y2
gen oop_1yr = oop_y1


forvalues i = 1/7 {

rename hlp_y`i' informal_y`i'
}


gen informal_7yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6 + informal_y7
gen informal_6yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5 + informal_y6
gen informal_5yr = informal_y1+ informal_y2+ informal_y3+ informal_y4+ informal_y5
gen informal_4yr = informal_y1+ informal_y2+ informal_y3+ informal_y4
gen informal_3yr = informal_y1+ informal_y2+ informal_y3
gen informal_2yr = informal_y1+ informal_y2
gen informal_1yr = informal_y1


forvalues i = 1/7 {

label var oop_`i'yr "Cumulative spending `i' year prior to index"
label var informal_`i'yr "Cumulative spending `i' year prior to index"
}

save $int\R01_mini.dta, replace

H="extract the LTSS info "
local importfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George"
local ltssfolder "J:\Geriatrics\PCare\HRS Projects\Data & Project-based (reference docs, etc)\Student Projects\Datasets\George\LTSS Expenditures\LTSS Expenditures"

cd "`importfolder'"

//import all excel files (there are both .xls and .xlsx files here) with MSIS pops for years 2000-2012
local filelist1 : dir . files  "*.xls"
local filelist2 : dir . files "*.xlsx"

local year=0
foreach f of local filelist1 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}



foreach f of local filelist2 {
	import excel "`f'", cellrange(A5) firstrow case(lower) clear
	gen year=2000+`year'
	rename *totalbeneficiaries totalbeneficiaries
	keep state year total age65
	tempfile msis`year'
	save `msis`year''
	local year=`year'+1
}


di `year'

clear all
forvalues year=0/12 {
	append using `msis`year''
}

//keep national, because it may be useful for missing states (12 in 2012 are empty, and ME in 2010 is)
replace state="Total" if state=="TOTAL"
drop if inlist(substr(state,1,3),"CMS","*Br")
drop if missing(state)

//save to merge with ltss data later
tempfile msis
save `msis'

//must drop the total because it won't match with a LTSS file
drop if inlist(substr(state,1,3),"Tot")

//pull 
levelsof state, local(levels)


tokenize 81 85 86 90 91 95 96 00 01 05 06 10 11 14

foreach l of local levels {
	forvalues year=1(2)14 {
	import excel "`ltssfolder'\LTSS_Historic_Exp_`l'.xlsx", sheet("`l' ``year''-``=`year'+1'' Expenditures") cellrange(A2) ///
	firstrow case(lower) clear allstring
	keep servicetype fy*
	keep if inlist(servicetype,"Total LTSS", "Total Institutional LTSS", "Total HCBS", "Total Medicaid (all services)")
	gen state="`l'"
	reshape long fy, i(servicetype) 
	destring fy, replace
	levelsof _j, local(lev2)
	foreach lev of local lev2 {
		egen tot_hcbs`lev'=max(cond(_j==`lev' & servicetype=="Total HCBS"),fy,.)
		egen tot_inst_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total Institutional LTSS"),fy,.) 
		egen tot_ltss`lev'=max(cond(_j==`lev' & servicetype=="Total LTSS"),fy,.)
		egen tot_medicaid`lev'=max(cond(_j==`lev' & servicetype=="Total Medicaid (all services)"),fy,.)  
}
	keep state tot*
	duplicates drop
	reshape long tot_hcbs tot_inst_ltss tot_ltss tot_medicaid, i(state) j(year)
	tempfile t`year'
	save `t`year''
}
	clear all
	forvalues year=1(2)14 {
	append using `t`year''
}
	tempfile `l'
	save ``l''
}

clear all
foreach l of local levels {
	append using ``l''
}

keep if inrange(year,2000,2012)

merge 1:1 state year using `msis', gen(msisltssm)

label var tot_ltss "Total LTSS"
label var tot_inst_ltss "Total Institutional LTSS"
label var tot_hcbs "Total HCBS"
label var tot_medicaid "Total Medicaid (all services)"
label var totalb "Total Beneficiaries"
label var age "Beneficiaries 65+"

save "msis_ltss_by_state.dta", replace


H="Merging together and prorating costs"
use "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data\samplecore.dta", clear

merge m:1 id using $int\R01_mini.dta, keepus(oop_y* informal_y* hlp_i_y*) nogen

preserve 
keep if nflag==0
keep id c_ivw_date c_ivw_year
rename c_ivw_date index_date
rename c_ivw_year index_year
label var index_date "Date of index interview (y = 0)"

tempfile index
save `index'

restore
merge m:1 id using "`index'", nogen

*drop diff
gen diff = index_date - inc_maid_date

gen start_date = inc_maid_date + 730
gen end_date = inc_maid_date - 730

gen oopstart = index_date - start_date

forvalues i=1/7 {
gen start_in_`i' = 0
replace oop_y`i'=0 if oop_y`i'==.
replace informal_y`i'=0 if informal_y`i'==.
replace hlp_i_y`i'=0 if hlp_i_y`i'==.
}


replace start_in_1 = 1 if oopstart<=365
replace start_in_2 = 1 if oopstart>365 & oopstart<=730
replace start_in_3 = 1 if oopstart>730 & oopstart<=1095
replace start_in_4 = 1 if oopstart>1095 & oopstart<=1460
replace start_in_5 = 1 if oopstart>1460 & oopstart<=1825
replace start_in_6 = 1 if oopstart>1825 & oopstart<=2190
*drop if start_in_4==1


foreach x in oop informal hlp_i {

gen `x'_post_2yr = 0
label var `x'_post_2yr "Total `x' spending 2yr post incident medicaid"

replace `x'_post_2yr = (oopstart/365)*(`x'_y1) + `x'_y2 + (1-(oopstart/365))*(`x'_y3) if start_in_1==1
replace `x'_post_2yr = ((oopstart - 365)/365)*(`x'_y2) + `x'_y3 + (1-((oopstart - 365)/365))*(`x'_y4) if start_in_2==1 
replace `x'_post_2yr = ((oopstart - 730)/365)*(`x'_y3) + `x'_y4 + (1-((oopstart - 730)/365))*(`x'_y5) if start_in_3==1
replace `x'_post_2yr =  ((oopstart - 1095)/365)*(`x'_y4) + `x'_y5 + (1-((oopstart - 1095)/365))*(`x'_y6) if start_in_4==1
replace `x'_post_2yr = ((oopstart - 1460)/365)*(`x'_y5) + `x'_y6 + (1-((oopstart - 1460)/365))*(`x'_y7) if start_in_5==1

}

rename hlp_i_post_2yr hlphrs_post_2yr

keep oop_post_2yr informal_post_2yr hlphrs_post_2yr id
duplicates drop 

merge 1:m id using $int\fullcore.dta, nogen


merge m:m id core_year using cg_cost_intc.dta, keep(master match) nogen keepus(stateusps)
merge m:1 stateusps using statenames.dta, keep(master match) nogen
*merge m:1 state_name using ltss.dta, keepus(ltss_cat) nogen keep(master match)
//7/10/19-ebl-switched to new ltss info
gen state=stateusps
gen year=core_year
merge m:1 state year using msis_ltss_by_state.dta, keep(match master) nogen
gsort id -core_year
carryforward state tot_* totalben age6, replace
sort id core_year
carryforward state tot_* totalben age6, replace

gen cpi_rate = 1 if year==2016
replace cpi_rate=1.01262 if year==2015
replace cpi_rate=1.01382 if year==2014
replace cpi_rate=1.03026 if year==2013
replace cpi_rate=1.04535 if year==2012
replace cpi_rate=1.06699 if year==2011
replace cpi_rate=1.10067 if year==2010
replace cpi_rate=1.11872 if year<=2009
replace cpi_rate=1.11474 if year==2008
replace cpi_rate=1.15754 if year==2007
replace cpi_rate=1.19051 if year==2006
replace cpi_rate=1.22891 if year==2005
replace cpi_rate=1.27055 if year==2004
replace cpi_rate=1.30439 if year==2003
replace cpi_rate=1.33411 if year==2002
replace cpi_rate=1.35521 if year==2001
replace cpi_rate=1.39377 if year==2000
replace cpi_rate=1.44062 if year==1999
replace cpi_rate=1.47244 if year<=1998

foreach x in hcbs inst_ltss ltss medicaid {
	gen `x'_persenior=tot_`x'*cpi_rate/age65
}
replace medicaid_persenior=medicaid_persenior*age65/totalbe
drop cpi_rate

/*
gen dem_cohort = .
replace dem_cohort = 0 if pdem<0.5
replace dem_cohort = 1 if pdem>=0.5 & pdem!=.
*/
bysort id: egen dementia = max(dem_cohort)

drop if c_ivw_date < inc_maid_date

gsort id +core_year
by id: gen nflag = _n
replace nflag = nflag - 1

keep if nflag<=1

gen months_from_medicaid = ceil((c_ivw_date - inc_maid_date)*0.0329)
label var months_from_medicaid "Months between incident medicaid and core interview"

foreach x in hcbs inst_ltss ltss medicaid {
	xtile `x'_persenior_quart=`x'_persenior, nq(4)
}
rename medicaid_persenior_quart medicaid_perbene_quart

label var hcbs_persenior_quart "Quartile of state-level HCBS spending per senior"
label var inst_ltss_persenior_quart "Quartile of state-level Institutional LTSS spending per senior"
label var ltss_persenior_quart "Quartile of state-level LTSS spending per senior"
label var medicaid_perbene_quart "Quartile of state-level total Medicaid spending per beneficiary"

keep dementia nflag hhid pn id age inc_maid_year adl_diff_bh adl_diff_dr adl_diff_e ///
adl_diff_t adl_diff_tx adl_diff_wk adl_dr_core adl_e_core adl_t_core adl_tx_core ///
adl_wk_core adl_bh_core comor_in_hrs core_year hlphrs_post_2yr informal_post_2yr ///
married nhres nhres_2yr oop_post_2yr proxy_core srh_pf smoke_curr smoke_ever /*ltss_cat*/ ///
networth months_from_medicaid ltss_persenior_quart 

merge m:1 hhid pn using "D:\HRS\Shared\base_data\hrs_cleaned\restr_tracker_v2014.dta", nogen keep(match) keepus(hisp_eth white black other_na_api_race degree gender)

foreach x in hisp_eth white black {
replace `x' = 0 if `x'==.
}


replace other_na_api_race = 1 if other_na_api_race==.
gen hseduc = 0 if degree==0
replace hseduc = 1 if degree>0 & degree!=.

gen female = 0 if gender==1
replace female = 1 if gender==2

drop hhid pn degree gender
label var inc_maid_year "Incident medicaid year"
label var dementia "Dementia probablity >= 0.5 within +/- 4 years of incident mediciaid" 
label var hseduc "HS Grad or GED"
label var female "female"
label var hlphrs_post_2yr "Total unpaid helper hours 2yrs post incident medicaid"

gen ivw_label = "p1" if nflag==0
replace ivw_label = "p2" if nflag==1
drop nflag



save cg_penultimate.dta, replace

use cg_penultimate.dta, replace


*markstat using cg_summary.stmd


use cg_penultimate.dta, replace


local all adl_diff_bh adl_diff_dr adl_diff_e adl_diff_t adl_diff_tx adl_diff_wk adl_dr_core ///
adl_e_core adl_t_core adl_tx_core adl_wk_core adl_bh_core comor_in_hrs core_year married nhres ///
nhres_2yr proxy_core srh_pf smoke_curr smoke_ever /*ltss_cat*/ networth months_from_medicaid ///
ltss_persenior_quart

foreach x of local all {
rename `x' `x'_
local all2 `all2' `x'_
}


reshape wide `all2', i(id) j(ivw_label) string

sort id 
set seed 123
gen rid = runiform()*10000000
replace rid = abs(rid)

save $fin\medicaid_cg_burden_id.dta, replace 

drop id

save $fin\medicaid_cg_burden.dta, replace 



H="Sample Derivation"
use "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\data\int_data\samplederivation.dta", clear
 
gen all = 1
 
local sampvars drop_medicaid nolookback dropped_nocore age_lt_65 no_ivw 
local rd: word count all `sampvars' 1
label var all "All HRS Medicare Beneficiaries 1998-2015"
 
mat tab1= J(`rd',1,.)

sum all
mat tab1[1,1]=r(N)

local r = 2
foreach x of local sampvars {
sum `x'
mat tab1[`r',1] = r(sum)
drop if `x'==1
local ++r
}

sum all
mat tab1[`r',1] = r(N)

mat rownames tab1 = all `sampvars' "Final Sample"

frmttable using "D:\HRS\Projects\dementia_decedents\ask_medicaid_caregiver_burden\output\sample_derivation_`c(current_date)'.rtf", ///
statmat(tab1) varlabels title("Sample Derivation") sdec(0) replace

H="Markdown log"
## Markdown Log Creation

The dataset consists of the first two interviews post incident medicaid as identified in Medicare Master Beneficiary Summary File. It allows for a "washout period" of 12 months, so anyone identified as incident Medicaid must have been a Medicare beneficiary for at least 12 months prior to incidence.  
Variables with the suffix **p1** represent the first interview post incident medicaid, and variables with the suffix **p2** refer to the second interview post medicaid. Because transposing a dataset from long to wide destroys variable labels, I've printed them here for you to see.  

	describe
	
I'll show you how to go from long from to wide form using the `reshape` command, as well as a neat tool call `local`.  You'll notice that the number of observations we end with will be more than half of what we started with. This is because we have an unbalanced panel; not everyone has two interviews post Medicaid, some only have one.  

	local all adl_diff_bh adl_diff_dr adl_diff_e adl_diff_t adl_diff_tx adl_diff_wk adl_dr_core adl_e_core adl_t_core adl_tx_core adl_wk_core adl_bh_core comor_in_hrs core_year married nhres nhres_2yr proxy_core srh_pf smoke_curr smoke_ever ltss_cat networth months_from_medicaid

	foreach x of local all {
	rename `x' `x'_
	local all2 `all2' `x'_
	}

	reshape wide `all2', i(id) j(ivw_label) string
	
`reshape` requires listing all the variables that need to be transposed. If you need to frequently reference a long list of variables, instead of typing it out each time you can save it to a local. Now lets try `describe` again.

	describe

Your datatset contains HRS respondents who were:

- Medicare Beneficaries between 1998 - 2015
- Aged 65+ at time of incident medicaid buy-in (Medicaid paying for Medicare premium)
- Were Medicare Beneficaries 12 months prior to incident Medicaid
- Are alive 2 years post incident medicaid
- Has at least 1 HRS core interview 2-6 years post incident Medicaid 

## Quick hack for exploratory data analys  

You can write a loop to visualize some of variables
	foreach x in age oop_post_2yr informal_post_2yr {
	hist `x', bin(20)
	graph export `x'.png, width(500) replace
	}

![Age at incident Medicaid](age.png)

![Total OOP 2 years post Medicaid](oop_post_2yr.png)

![Total informal care costs 2 years post Medicaid](informal_post_2yr.png)


H="Changelog"
8/30/19 - Separated NH, Live in Comm (alone vs with others) into mutually exclusive categories. Also carried forward N1 values for people misssing a P1 Core. OKR

8/23/19 - Fixed informal care hours (changed missing hours to zero) and fixed livesalone for non-exit interviews (only exit dataset has a livealone variable). OKR

8/22/19 - Added NH resdients to table and replace survey weights with nh weights for people in nursing home. OKR

8/09/19 - Recreated Dataset using new critieria (require only N1 & P1), and generated a weighted population table. Omari

7/23/19 - Recreated Dataset using new criteria (require N1, P1 & P2) and prospective approach to calculating costs. OKR

7/11/2019 - Added Sample Derivation. Omari

7/10/19 - Added the new per-year LTSS info in the "extract the LTSS info" header and merged in "merging together..." header. Evan

7/3/2019 - Fixed the numbering of interviews so that it p1 is the first interview post medicaid, and p2 is the second. Omari

6/21/19 to 6/26/19 - Rebuilt data from ground starting with HRS base. Chose incident medicaid and then required the 7 year OOP calculations to contain pre incident interview + post incident interview, with a 2 year lookback from incident. Omari 

6/8/19 - Had to remove state due to HRS requirements. Created deciles for LTSS spending 