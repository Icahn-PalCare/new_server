= V4 Outline MultiLine NoSorting TabWidth=30

H="**** HBMC New Server *****"


H="Project Outline"
/* 
********************HEADING******************** 

Project Name: Home Based Medicare Care (HBMC)

Date Started: September 2017
Primary Investigator: Ornstein
Funding Source:

Created by: OKR

Primary Analyst: OKR
Secondary Analyst: EBL

Datasets Used: NHATS Waves 1-7, Medicare

Simple Outline: Uses CPT codes from Carrier to determine utilization of home based care


*/
 
//STATA
// Global Macros use $ symbol to be called. 

//Intermediate Data Path
global intpath "E:\nhats\data\Projects\..."

// Final Data Path
gloabl datapath "E:\nhats\data\Projects\..."

//Log files path
gloabl logpath "E:\nhats\data\Projects\..."


//SAS 


//Intermediate Data Path
//libname intpath "E:\nhats\data\Projects\..."

// Final Data Path
//libname datapath "E:\nhats\data\Projects\..."

//Log files path
//libname logpath "E:\nhats\data\Projects\..."


H="Get index date"
libname proj_int 'D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data';


proc import datafile="D:\nhats\shared\base_data\nhats cleaned\sp_round_1_7.dta" out=proj_int.nhats replace; run;

data index1;
set proj_int.nhats (keep=spid ivw_date ivw_month ivw_year);
index_date=ivw_date;
index_month=ivw_month;
index_year=ivw_year;
run;

proc import out=xwalk
datafile = "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta" replace; 
run;

proc sql;
create table index as select a.*, b.bene_id
from index1 a left join
xwalk b 
on a.spid=b.spid;
quit;

proc sort data=index out=proj_int.index nodupkey;
by spid bene_id index_year;
run;


H="Get cont. ffs before index"
libname medi 'D:\NHATS\Shared\base_data\CMS_claims\SAS'; 


/*sort claims denominator file*/

proc sort data=medi.mbsf_06_17 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),1,index_month);
hmo_iy=substr(trim(left(HMOIND12)),1,index_month);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;

proc sql;
create table mbsf_index_year_bef as select
a.bene_id,a.year as index_year,
b.year as index_year_bef,
b.year, b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.year-b.year<=1 order by bene_id,year;
quit;


/* and the year before... 1922 have the -2 year dn file*/
proc sql;
create table mbsf_index_year_2bef as select
a.bene_id,a.bene_id,a.index_year,a.index_year_bef,
b.year as index_year_2bef,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_bef a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.index_year_bef-b.year<=1 order by bene_id,year;
quit;

/*merge the insurance data for death year, -1 and -2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
mbsf_index_year2 a
left join
mbsf_index_year_bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2bef,b.HMOIND12 as hmo_2bef from
all_insurance a
left join
mbsf_index_year_2bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year; 
quit;


/*merge death year and year before death buy-in and hmo variables
Trim so the final variable _6m is 6 months pre-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months pre-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_2bef))||trimn(left(buyin_bef))||trimn(left(buyin_iy));
hmo_2y=trimn(left(hmo_2bef))||trimn(left(hmo_bef))||trimn(left(hmo_iy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));


/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y_r,"0","1","2","A","B")=0 then part_ab_n_mos=length(buyin_2y_r)-1;
if indexc(buyin_2y_r,"0","1","2","A","B") then part_ab_n_mos=indexc(buyin_2y_r,"0","1","2","A","B")-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C")=0 then non_hmo_d_n_mos=length(hmo_2y_r)-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C") then non_hmo_d_n_mos=indexc(hmo_2y_r,"1","2","4","A","B","C")-1;
if part_ab_n_mos<=non_hmo_d_n_mos then cont_ffs_n_mos=part_ab_n_mos;
if non_hmo_d_n_mos<part_ab_n_mos then cont_ffs_n_mos=non_hmo_d_n_mos;
run;


data proj_int.ffs_before;
set all_insurance3;
run;


H="Get cont. ffs after index "

/*sort claims denominator file*/

proc sort data=medi.mbsf_06_17 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),index_month,13-index_month);
hmo_dy=substr(trim(left(HMOIND12)),index_month,13-index_month);
buyin_at_death=substr(trim(left(buyin12)),index_month,1);
hmo_at_death=substr(trim(left(HMOIND12)),index_month,1);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;


proc sql;
create table mbsf_index_year_aft as select
a.bene_id,a.bene_id,a.year as index_year,
b.year as index_year_aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.year-b.year=-1 order by bene_id,year;
quit;


/* and the year aftore... 1790 have the +2 year dn file*/
proc sql;
create table mbsf_index_year_2aft as select
a.bene_id,a.bene_id,a.index_year,a.index_year_aft,
b.year as index_year_2aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_aft a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year_aft-b.year=-1 order by bene_id,year;
quit;

/*merge the insurance data for death year, +1 and +2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
mbsf_index_year2 a
left join
mbsf_index_year_aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2aft,b.HMOIND12 as hmo_2aft from
all_insurance a
left join
mbsf_index_year_2aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


/*merge death year and year aftore death buy-in and hmo variables
Trim so the final variable _p6m is 6 months post-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months post-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_iy))||trimn(left(buyin_aft))||trimn(left(buyin_2aft));
hmo_2y=trimn(left(hmo_dy))||trimn(left(hmo_aft))||trimn(left(hmo_2aft));

/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y,"0","1","2","A","B")=0 then part_ab_p_mos=length(buyin_2y);
if indexc(buyin_2y,"0","1","2","A","B") then part_ab_p_mos=indexc(buyin_2y,"0","1","2","A","B");
if indexc(hmo_2y,"1","2","4","A","B","C")=0 then non_hmo_d_p_mos=length(hmo_2y);
if indexc(hmo_2y,"1","2","4","A","B","C") then non_hmo_d_p_mos=indexc(hmo_2y,"1","2","4","A","B","C");
if indexc(buyin_at_death,"0","1","2","A","B")=1 then part_ab_at_death=0;
if indexc(buyin_at_death,"0","1","2","A","B")=0 then part_ab_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=1 then hmo_d_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=0 then hmo_d_at_death=0;

if part_ab_p_mos<=non_hmo_d_p_mos then cont_ffs_p_mos=part_ab_p_mos;
if non_hmo_d_p_mos<part_ab_p_mos then cont_ffs_p_mos=non_hmo_d_p_mos;
run;

data proj_int.ffs_after;
set all_insurance3;
run;

H="get claims before index"

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_pre(days_start=,days_bef_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_bef_index. as select a.index_date,a.index_year,b.*
from proj_int.index a inner join
medi.&source._&yrs. b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.index_date-b.disch_date<=&days_bef_index;
quit;

%mend;

/*run to get claims list 6 mo pre-ivw for ip*/
%claims_pre(days_start=0,days_bef_index=183,yrs=06_17,source=ip);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=snf);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=op);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=pb);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=hh);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=hs);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_17,source=dm);

/*1yr*/
%claims_pre(days_start=0,days_bef_index=365,yrs=06_17,source=ip);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=snf);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=op);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=pb);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=hh);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=hs);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_17,source=dm);

/*2yrs*/
%claims_pre(days_start=0,days_bef_index=730,yrs=06_17,source=ip);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=snf);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=op);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=pb);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=hh);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=hs);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_17,source=dm);

%macro ip_drop(days_bef_index=);
data proj_int.ip_meet_&days_bef_index.;
set ip_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 icarecnt crnrydaycnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 hcpcscd1-hcpcscd49);
run;
%mend ip_drop;

%macro snf_drop(days_bef_index=);
data proj_int.snf_meet_&days_bef_index.;
set snf_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 );
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_bef_index=);
data proj_int.hh_meet_&days_bef_index.;
set hh_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_bef_index=);
data proj_int.hs_meet_&days_bef_index.;
set hs_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_bef_index=);
data proj_int.dm_meet_&days_bef_index.;
set dm_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date 
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 h_o2);
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_bef_index=);
data proj_int.op_meet_&days_bef_index.;
set op_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt obs_stay);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_bef_index=);
data proj_int.pb_meet_&days_bef_index.;
set pb_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
run;
%mend pb_drop;

%ip_drop(days_bef_index=183);
%op_drop(days_bef_index=183);
%pb_drop(days_bef_index=183);
%snf_drop(days_bef_index=183);
%hh_drop(days_bef_index=183);
%dm_drop(days_bef_index=183);
%hs_drop(days_bef_index=183);
%ip_drop(days_bef_index=365);
%ip_drop(days_bef_index=730);
%snf_drop(days_bef_index=365);
%snf_drop(days_bef_index=730);
%hh_drop(days_bef_index=365);
%hh_drop(days_bef_index=730);
%hs_drop(days_bef_index=365);
%hs_drop(days_bef_index=730);
%dm_drop(days_bef_index=365);
%dm_drop(days_bef_index=730);
%op_drop(days_bef_index=365);
%op_drop(days_bef_index=730);
%pb_drop(days_bef_index=365);
%pb_drop(days_bef_index=730);



/****************************************************************************/
/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.pb_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.op_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25  );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

proc contents data=proj_int.ip_meet_365; run;


/*Dataset being created: ip_last_&range2._dx2*/
data ip_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.ip_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 hcpcscd1-hcpcscd49);
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=ip_last_&range2._dx out=ip_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Dataset being created: snf_last_&range2._dx2*/
data snf_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.snf_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=snf_last_&range2._dx out=snf_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.dm_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hh_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hs_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data ip_last_&range2._dx3;
length diag $7;
set ip_last_&range2._dx2;
run;
data snf_last_&range2._dx3;
length diag $7;
set snf_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_1&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
ip_last_&range2._dx3
snf_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sql;
create table dx_all_last_&range2. as select * from
proj_int.index a 
left join 
dx_all_last_1&range2. b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit; 

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bene_id index_year diag;
run;


%mend;

/*1 and 2 years pre-interview: proj_int.dx_0_1yr, proj_int.dx_0_2yr */
%dx_time_range(range1=0, range2=6m, days_bef_core=183);
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);



data dx_all_last_6m_w_dups;
set hs_last_6m_dx
hh_last_6m_dx
ip_last_6m_dx
snf_last_6m_dx
dm_last_6m_dx
op_last_6m_dx
pb_last_6m_dx;
if diag~='.';
run;



/*****************************************/
/*check dementia diagnosis frequencies, need to pull this into main dataset
dx list is from Elixhauser code*/
data proj_int.dem_dx_freq;
set dx_all_last_6m_w_dups;
	dementia=0;
	dem_icd10=0;
	if (substr(diag,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(diag,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
/*ICD-10*/		

if (substr(diag,1,5)='F0150'
or substr(diag,1,5)='F0151'
or substr(diag,1,5)='F0280'
or substr(diag,1,5)='F0281'
or substr(diag,1,5)='F0390'
or substr(diag,1,5)='F0391'
or substr(diag,1,4)='F051'
or substr(diag,1,5)='F1027'
or substr(diag,1,5)='F1097'
or substr(diag,1,4)='G300'
or substr(diag,1,4)='G301'
or substr(diag,1,4)='G308'
or substr(diag,1,4)='G309'
or substr(diag,1,5)='G3101'
or substr(diag,1,5)='G3109'
or substr(diag,1,4)='G311'
or substr(diag,1,5)='G3183'
or substr(diag,1,4)='A811'
or substr(diag,1,4)='A812'
or substr(diag,1,4)='A818'
or substr(diag,1,5)='A8100'
or substr(diag,1,5)='A8101'
or substr(diag,1,5)='A8109'
or substr(diag,1,5)='A8181'
or substr(diag,1,5)='A8182'
or substr(diag,1,5)='A8183'
) 
		and dem_icd10=0 
          then dem_icd10=1;
if dem_icd10=1 then dementia=1;
run;



H="get claims after index"
/* aims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_post(days_start=,days_aft_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_aft_index.p as select a.*,b.index_date,b.index_year
from medi.&source._&yrs. a inner join
proj_int.index b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.admit_date-b.index_date<=&days_aft_index;
quit;

%mend;

/*6m*/
%claims_post(days_start=0,days_aft_index=183,yrs=06_17,source=ip);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=snf);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=op);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=pb);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=hh);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=hs);
%claims_post(days_start=0,days_aft_index=183,yrs=09_17,source=dm);

/*1yr*/
%claims_post(days_start=0,days_aft_index=365,yrs=06_17,source=ip);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=snf);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=op);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=pb);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=hh);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=hs);
%claims_post(days_start=0,days_aft_index=365,yrs=09_17,source=dm);

/*2yrs*/
%claims_post(days_start=0,days_aft_index=730,yrs=06_17,source=ip);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=snf);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=op);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=pb);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=hh);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=hs);
%claims_post(days_start=0,days_aft_index=730,yrs=09_17,source=dm);

%macro ip_drop(days_aft_index=);
data proj_int.ip_meet_&days_aft_index.p;
set ip_meet_&days_aft_index.p(keep=clm_pmt_amt clm_pass_thru_per_diem_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 crnrydaycnt icarecnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend ip_drop;

%macro snf_drop(days_aft_index=);
data proj_int.snf_meet_&days_aft_index.p;
set snf_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_aft_index=);
data proj_int.hh_meet_&days_aft_index.p;
set hh_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_aft_index=);
data proj_int.hs_meet_&days_aft_index.p;
set hs_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_aft_index=);
data proj_int.dm_meet_&days_aft_index.p;
set dm_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_aft_index=);
data proj_int.op_meet_&days_aft_index.p;
set op_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_aft_index=);
data proj_int.pb_meet_&days_aft_index.p;
set pb_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend pb_drop;

%ip_drop(days_aft_index=183);
%ip_drop(days_aft_index=365);
%ip_drop(days_aft_index=730);
%snf_drop(days_aft_index=183);
%snf_drop(days_aft_index=365);
%snf_drop(days_aft_index=730);
%hh_drop(days_aft_index=183);
%hh_drop(days_aft_index=365);
%hh_drop(days_aft_index=730);
%hs_drop(days_aft_index=183);
%hs_drop(days_aft_index=365);
%hs_drop(days_aft_index=730);
%dm_drop(days_aft_index=183);
%dm_drop(days_aft_index=365);
%dm_drop(days_aft_index=730);
%op_drop(days_aft_index=183);
%op_drop(days_aft_index=365);
%op_drop(days_aft_index=730);
%pb_drop(days_aft_index=183);
%pb_drop(days_aft_index=365);
%pb_drop(days_aft_index=730);
 

H="Dartmouth"

/*Add indicator variables for the Dartmouth chronic diseases */

/*Dartmouth code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 9 different chronic 
	diseases from the Dartmouth Index.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes from pdf "List of ICD-9_CM codes by Chronic Disease Category 
	(Nine chronic conditions used in the dartmouth atlas of health care 2008) from March 3, 2008*/


/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro dartmouth(range1=,range2=);

data dx_dartmouth;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   dartmouth_1=0;
   dartmouth_1a=0;
   dartmouth_1b=0;
   dartmouth_2=0;
   dartmouth_3=0;
   dartmouth_4=0;
   dartmouth_5=0;
   dartmouth_6=0;
      dartmouth_7=0;
	     dartmouth_8=0;
		    dartmouth_9=0;
			   dartmouth_10=0;
			      dartmouth_11=0;
				     dartmouth_12=0;
					    dartmouth_13=0;
						   dartmouth_14=0;
						      dartmouth_15=0;
							     dartmouth_16=0;
								    dartmouth_17=0;

*do over dx;
	*Cancer with poor prognosis;
	if (substr(dx,1,4) in('1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512',
			 	'1513','1514','1515','1516','1518','1519','1550','1551','1552','1570','1571',
			 	'1572','1573','1574','1578','1579','1580','1588','1589','1620','1622','1623',
			 	'1624','1625','1628','1629','1630','1631','1638','1639','1830','1832','1833',
			 	'1834','1835','1838','1839','1910','1911','1912','1913','1914','1915','1916',
			 	'1917','1918','1919','2890') 
		or substr(dx,1,5) in('20400','20410','20420','20480','20490','20500','20510',
				'20520','20530','20580','20590','20600','20610','20620','20680','20690','20700',
				'20710','20720','20780','20800','20810','20820','20880'))
               and dartmouth_1a=0
               then dartmouth_1a=1;
	*Metastatic Cancer;
	if (substr(dx,1,4) in('1960','1961','1962','1963','1965','1966','1968','1969','1970','1971','1972',
				'1973','1974','1975','1976','1977','1978','1980','1981','1982','1983','1984',
				'1985','1986','1987','1990','1991') or 
		substr(dx,1,5) in('19881','19882','19889'))
				and dartmouth_1b=0
				then dartmouth_1b=1;
	*Malignant Cancer, Leukemia;
	if dartmouth_1a=1 or dartmouth_1b=1 then dartmouth_1=1;
	*COPD;
	if (substr(dx,1,3) in('494','496','501','515') or
		substr(dx,1,4) in('4911,4918,4919,4920,4928,4940,4941,5064') or
		substr(dx,1,5) in('49120,49121,49122,49310,49311,49312,49320,49321,49322,49390,49391,49392'))
				and dartmouth_2=0
				then dartmouth_2=1;
	*CAD;
	if (substr(dx,1,3)='412' or
		substr(dx,1,4) in('4111','4118','4130','4139','4140','4148','4149') or
		substr(dx,1,5) in('41181','41189','41400','41401','41402','41403','41404','41405','41406','41407'))
				and dartmouth_3=0
				then dartmouth_3=1;
	*CHF;
	if (substr(dx,1,4) in('4280','4281','4282','4283','4284','4289') or
		substr(dx,1,5) in('42820','42821','42822','42823','42830','42831','42832','42833','42840','42841',
								'42842','42843','40201','40211','40291','39891','40401','40403','40411','40491',
								'40493'))
				and dartmouth_4=0
				then dartmouth_4=1;
	*PVD;
	if (substr(dx,1,4) in('4400','4401','4403','4408','4409','4410','4411','4412','4413','4414','4415','4416',
								'4417','4419','4439') or
		substr(dx,1,5) in('44020','44021','44022','44023','44024','44029','44030','44031','44032','44100','44101','44102','44103'))
				and dartmouth_5=0
				then dartmouth_5=1;
	*Severe Chronic Liver Disease;
	if substr(dx,1,4) in('5712','5715','5716','5723')
				and dartmouth_6=0
				then dartmouth_6=1;
	*Diabetes w/ End Organ Damage;
	if ((substr(dx,1,3)='250' and substr(dx,4,1) in('4','5','6','7','9') and substr(dx,5,1) in('0','1','2','3')) or
		substr(dx,1,4)='3572' or
		substr(dx,1,5) in('36641','36201','36202'))
				and dartmouth_7=0
				then dartmouth_7=1;
	*Renal Failure;
	if (substr(dx,1,3)='585' or
		substr(dx,1,4) in('5851','5852','5853','5854','5855','5856','5859','V451','V560','V568') or
		substr(dx,1,5) in('40301','40311','40391'))
				and dartmouth_8=0
				then dartmouth_8=1;
	*Dementia;
	if (substr(dx,1,3)='797' or
		substr(dx,1,4) in('2900','2903','2908','2909','2940','2941','2948','2949','3310','3312') or
		substr(dx,1,5) in('29101','29011','29012','29013','29020','29021','29040','29041','29042',
								'29043','29410','29411'))
				and dartmouth_9=0
				then dartmouth_9=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(dartmouth_1a) as dmouth_a,
sum(dartmouth_1b) as dmouth_b,
sum(dartmouth_1) as cha_1,
sum(dartmouth_2) as cha_2,
sum(dartmouth_3) as cha_3,
sum(dartmouth_4) as cha_4,
sum(dartmouth_5) as cha_5,
sum(dartmouth_6) as cha_6,
sum(dartmouth_7) as cha_7,
sum(dartmouth_8) as cha_8,
sum(dartmouth_9) as cha_9
from dx_dartmouth
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data dartmouth_1(keep=bene_id index_year dmouth_1-dmouth_9 dmouth_index dmouth_index_wt);
set cha_test1;
array list_cha cha_1-cha_9;
array list_cha_bin dmouth_1-dmouth_9 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*replace cancer subtypes with indicators*/
if dmouth_a>1 then dmouth_a=1;
if dmouth_b>1 then dmouth_b=1;
/*note this dmouth_index count count is not weighted for morbidity*/
dmouth_index=dmouth_1+dmouth_2+dmouth_3+dmouth_4+dmouth_5+dmouth_6+dmouth_7+dmouth_8+dmouth_9;


label dmouth_a ="Poor prognosis cancer, Dartmouth";
label dmouth_b ="Metastatic cancer, Dartmouth";
label dmouth_1 ="Malignant Cancer or Leukemia, Dartmouth";
label dmouth_2 ="Chronic Pulmonary Disease, Dartmouth";
label dmouth_3 ="CAD, Dartmouth";
label dmouth_4 ="CHF, Dartmouth";
label dmouth_5 ="PVD, Dartmouth";
label dmouth_6 ="Severe Chronic Liver Disease, Dartmouth";
label dmouth_7 ="Diabetes w/ End Organ Damage, Dartmouth";
label dmouth_8 ="Renal Failure, Dartmouth";
label dmouth_9 ="Dementia, Dartmouth";
label dmouth_index ="Count Chronic Diseases, Dartmouth";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=dartmouth_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.dmouth_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 dmouth: index_year:;
run;
proc sort data=proj_int.dmouth_&range1._&range2.;
by bene_id index_year;
run;

%mend;

%dartmouth(range1=0, range2=6m);
%dartmouth(range1=0, range2=1yr);



proc freq; run;

H="Elixhauser"
/*

Created by: EBL
Date Created: 2/7/19

Updated by:
Date Updated:




**************************************************

/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!
*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set proj_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	if (substr(dx,1,4)='I099' or
		substr(dx,1,4)='I110' or
		substr(dx,1,4)='I130' or
		substr(dx,1,4)='I132' or
		substr(dx,1,4)='I255' or
		substr(dx,1,4)='I420' or
		substr(dx,1,4)='I425' or
		substr(dx,1,4)='I426' or
		substr(dx,1,4)='I427' or
		substr(dx,1,4)='I428' or
		substr(dx,1,4)='I429' or
		substr(dx,1,3)='I43' or
		substr(dx,1,4)='P290' or
		substr(dx,1,3)='I50') 
		and comorbi_1=0 
		then comorbi_1=1;

		*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	if (substr(dx,1,4)='I441' or
		substr(dx,1,4)='I442' or
		substr(dx,1,4)='I443' or
		substr(dx,1,4)='I456' or
		substr(dx,1,4)='I459' or
		substr(dx,1,3)='I47' or
		substr(dx,1,3)='I48' or
		substr(dx,1,3)='I49' or
		substr(dx,1,4)='ROOO' or
		substr(dx,1,4)='ROO1' or
		substr(dx,1,4)='ROO8' or
		substr(dx,1,4)='R000' or
		substr(dx,1,4)='R001' or
		substr(dx,1,4)='R008' or
		substr(dx,1,4)='T821' or
		substr(dx,1,4)='Z450' or
		substr(dx,1,4)='Z950')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,4)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	if (substr(dx,1,4)='A520' or
		substr(dx,1,4)='I05' or
		substr(dx,1,3)='I06' or
		substr(dx,1,3)='I07' or
		substr(dx,1,3)='I08' or
		substr(dx,1,4)='I091' or
		substr(dx,1,4)='I098' or
		substr(dx,1,3)='I34' or
		substr(dx,1,3)='I35' or
		substr(dx,1,3)='I36' or
		substr(dx,1,3)='I37' or
		substr(dx,1,3)='I38' or
		substr(dx,1,3)='I39' or
		substr(dx,1,4)='Q230' or
		substr(dx,1,4)='Q231' or
		substr(dx,1,4)='Q232' or
		substr(dx,1,4)='Q233' or
		substr(dx,1,4)='Z952' or
		substr(dx,1,4)='Z954')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	if (substr(dx,1,3)='I26' or
		substr(dx,1,3)='I27' or
		substr(dx,1,4)='I280' or
		substr(dx,1,4)='I288' or
		substr(dx,1,4)='I289')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	if (substr(dx,1,3)='I70' or
		substr(dx,1,3)='I71' or
		substr(dx,1,4)='I731' or
		substr(dx,1,4)='I738' or
		substr(dx,1,4)='I739' or
		substr(dx,1,4)='I771' or
		substr(dx,1,4)='I790' or
		substr(dx,1,4)='I792' or
		substr(dx,1,4)='K551' or
		substr(dx,1,4)='K558' or
		substr(dx,1,4)='K559' or
		substr(dx,1,4)='X958' or
		substr(dx,1,4)='Z959')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	if (substr(dx,1,3)='I10' or
		substr(dx,1,3)='I11' or
	    substr(dx,1,3)='I12' or
		substr(dx,1,3)='I13' or
		substr(dx,1,3)='I15')
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	if (substr(dx,1,4)='G041' or
		substr(dx,1,4)='G114' or
		substr(dx,1,4)='G801' or
		substr(dx,1,4)='G802' or
		substr(dx,1,3)='G81' or
		substr(dx,1,3)='G82' or
		substr(dx,1,4)='G830' or 
		substr(dx,1,4)='G831' or 
		substr(dx,1,4)='G832' or 
		substr(dx,1,4)='G833' or 
		substr(dx,1,4)='G834' or 
		substr(dx,1,4)='G839')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	if (substr(dx,1,3)='G10' or
		substr(dx,1,3)='G13' or
		substr(dx,1,3)='G20' or
		substr(dx,1,3)='G22' or
		substr(dx,1,4)='G254' or
		substr(dx,1,4)='G255' or
		substr(dx,1,4)='G312' or
		substr(dx,1,4)='G318' or
		substr(dx,1,4)='G319' or
		substr(dx,1,3)='G32' or
		substr(dx,1,3)='G35' or
		substr(dx,1,3)='G36' or
		substr(dx,1,3)='G37' or
		substr(dx,1,3)='G40' or
		substr(dx,1,3)='G41' or
		substr(dx,1,4)='G931' or
		substr(dx,1,4)='G934' or
		substr(dx,1,4)='R470' or
		substr(dx,1,4)='R560') 
			and comorbi_8=0 
		then comorbi_8=1;	
		*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	if (substr(dx,1,4)='I278' or
		substr(dx,1,4)='I279' or
		substr(dx,1,3)='J40' or
		substr(dx,1,3)='J41' or
		substr(dx,1,3)='J42' or
		substr(dx,1,3)='J43' or
		substr(dx,1,3)='J44' or
		substr(dx,1,3)='J45' or
		substr(dx,1,3)='J46' or
		substr(dx,1,3)='J47' or
		substr(dx,1,3)='J60' or
		substr(dx,1,3)='J61' or
		substr(dx,1,3)='J62' or
		substr(dx,1,3)='J63' or
		substr(dx,1,3)='J64' or
		substr(dx,1,3)='J65' or
		substr(dx,1,3)='J66' or
		substr(dx,1,3)='J67' or
		substr(dx,1,4)='J684' or
		substr(dx,1,4)='J701' or
		substr(dx,1,4)='J703') 
			and comorbi_9=0 
		then comorbi_9=1;	
		*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	if (substr(dx,1,4)='E100' or
		substr(dx,1,4)='E101' or
		substr(dx,1,4)='E109' or
		substr(dx,1,4)='E110' or
		substr(dx,1,4)='E111' or
		substr(dx,1,4)='E119' or
		substr(dx,1,4)='E120' or
		substr(dx,1,4)='E121' or
		substr(dx,1,4)='E129' or
		substr(dx,1,4)='E130' or
		substr(dx,1,4)='E131' or
		substr(dx,1,4)='E139' or
		substr(dx,1,4)='E140' or
		substr(dx,1,4)='E141' or
		substr(dx,1,4)='E149') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	if (substr(dx,1,4)='E102' or
		substr(dx,1,4)='E103' or
		substr(dx,1,4)='E104' or
		substr(dx,1,4)='E105' or
		substr(dx,1,4)='E106' or
		substr(dx,1,4)='E107' or
		substr(dx,1,4)='E108' or
		substr(dx,1,4)='E112' or
		substr(dx,1,4)='E113' or
		substr(dx,1,4)='E114' or
		substr(dx,1,4)='E115' or
		substr(dx,1,4)='E116' or
		substr(dx,1,4)='E117' or
		substr(dx,1,4)='E118' or
		substr(dx,1,4)='E122' or
		substr(dx,1,4)='E123' or
		substr(dx,1,4)='E124' or
		substr(dx,1,4)='E125' or
		substr(dx,1,4)='E126' or
		substr(dx,1,4)='E127' or
		substr(dx,1,4)='E128' or
		substr(dx,1,4)='E132' or
		substr(dx,1,4)='E133' or
		substr(dx,1,4)='E134' or
		substr(dx,1,4)='E135' or
		substr(dx,1,4)='E136' or
		substr(dx,1,4)='E137' or
		substr(dx,1,4)='E138' or
		substr(dx,1,4)='E142' or
		substr(dx,1,4)='E143' or
		substr(dx,1,4)='E144' or
		substr(dx,1,4)='E145' or
		substr(dx,1,4)='E146' or
		substr(dx,1,4)='E147' or
		substr(dx,1,4)='E148') 
			and comorbi_11=0 
		then comorbi_11=1;
		*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	if (substr(dx,1,3)='E00' or
		substr(dx,1,3)='E01' or
		substr(dx,1,3)='E02' or
		substr(dx,1,3)='E03' or
		substr(dx,1,4)='E890') 	
			and comorbi_12=0 
		then comorbi_12=1;
		*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	if (substr(dx,1,4)='I120' or
		substr(dx,1,4)='I131' or
		substr(dx,1,4)='N185' or
		substr(dx,1,4)='N186' or
		substr(dx,1,3)='N19' or
		substr(dx,1,4)='N250' or
		substr(dx,1,4)='Z490' or
		substr(dx,1,4)='Z491' or
		substr(dx,1,4)='Z492' or
		substr(dx,1,4)='Z940' or
		substr(dx,1,4)='Z992') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – 
		alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
/*1/25/19--changed liver to reflect just what we want in the ICD-10 codes*/
		if (substr(dx,1,5)='I8500'
		or substr(dx,1,5)='I8501'
		or substr(dx,1,5)='I8510'
		or substr(dx,1,5)='I8511'
		or substr(dx,1,4)='K702'
		or substr(dx,1,5)='K7030'
		or substr(dx,1,5)='K7031'
		or substr(dx,1,5)='K7040'
		or substr(dx,1,5)='K7041'
		or substr(dx,1,5)='K7210'
		or substr(dx,1,5)='K7290'
		or substr(dx,1,4)='K740'
		or substr(dx,1,4)='K741'
		or substr(dx,1,4)='K742'
		or substr(dx,1,4)='K743'
		or substr(dx,1,4)='K744'
		or substr(dx,1,4)='K745'
		or substr(dx,1,5)='K7460'
		or substr(dx,1,5)='K7469'
		or substr(dx,1,4)='K766'
		or substr(dx,1,4)='K767') 
					and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	if (substr(dx,1,4)='K257' or
		substr(dx,1,4)='K259' or
		substr(dx,1,4)='K267' or
		substr(dx,1,4)='K269' or
		substr(dx,1,4)='K277' or
		substr(dx,1,4)='K279' or
		substr(dx,1,4)='K287' or
		substr(dx,1,4)='K289') 
			and comorbi_15=0 
		then comorbi_15=1;
		*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
		if (substr(dx,1,3)='B20' or
		substr(dx,1,3)='B21' or
		substr(dx,1,3)='B22' or
		substr(dx,1,3)='B24') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,3)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	if (substr(dx,1,3)='C81' or
		substr(dx,1,3)='C82' or
		substr(dx,1,3)='C83' or
		substr(dx,1,3)='C84' or
		substr(dx,1,3)='C85' or
		substr(dx,1,3)='C88' or
		substr(dx,1,3)='C96' or
		substr(dx,1,4)='C900' or
		substr(dx,1,4)='C902')
			and comorbi_17=0 
		then comorbi_17=1;
		*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	if (substr(dx,1,3)='C77' or
		substr(dx,1,3)='C78' or
		substr(dx,1,3)='C79' or
		substr(dx,1,3)='C80') 
			and comorbi_18=0 
		then comorbi_18=1;	
		*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	if (substr(dx,1,2)='C0' or
		substr(dx,1,2)='C1' or
		substr(dx,1,3)='C20' or
		substr(dx,1,3)='C21' or
		substr(dx,1,3)='C22' or
		substr(dx,1,3)='C23' or
		substr(dx,1,3)='C24' or
		substr(dx,1,3)='C25' or
		substr(dx,1,3)='C26' or
		substr(dx,1,3)='C30' or
		substr(dx,1,3)='C31' or
		substr(dx,1,3)='C32' or
		substr(dx,1,3)='C33' or
		substr(dx,1,3)='C34' or
		substr(dx,1,3)='C37' or
		substr(dx,1,3)='C38' or
		substr(dx,1,3)='C39' or
		substr(dx,1,3)='C40' or
		substr(dx,1,3)='C41' or
		substr(dx,1,3)='C43' or
		substr(dx,1,3)='C45' or
		substr(dx,1,3)='C46' or
		substr(dx,1,3)='C47' or
		substr(dx,1,3)='C48' or
		substr(dx,1,3)='C49' or
		substr(dx,1,3)='C50' or
		substr(dx,1,3)='C51' or
		substr(dx,1,3)='C52' or
		substr(dx,1,3)='C53' or
		substr(dx,1,3)='C54' or
		substr(dx,1,3)='C55' or
		substr(dx,1,3)='C56' or
		substr(dx,1,3)='C57' or
		substr(dx,1,3)='C58' or
		substr(dx,1,3)='C60' or
		substr(dx,1,3)='C61' or
		substr(dx,1,3)='C62' or
		substr(dx,1,3)='C63' or
		substr(dx,1,3)='C64' or
		substr(dx,1,3)='C65' or
		substr(dx,1,3)='C66' or
		substr(dx,1,3)='C67' or
		substr(dx,1,3)='C68' or
		substr(dx,1,3)='C69' or
		substr(dx,1,3)='C70' or
		substr(dx,1,3)='C71' or
		substr(dx,1,3)='C72' or
		substr(dx,1,3)='C73' or
		substr(dx,1,3)='C74' or
		substr(dx,1,3)='C75' or
		substr(dx,1,3)='C76' or
		substr(dx,1,3)='C97')
			and comorbi_19=0 
		then comorbi_19=1;
		*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	if (substr(dx,1,4)='L940' or
		substr(dx,1,4)='L941' or
		substr(dx,1,4)='L943' or
		substr(dx,1,3)='M05' or
		substr(dx,1,3)='M06' or
		substr(dx,1,3)='M08' or
		substr(dx,1,4)='M120' or
		substr(dx,1,4)='M123' or
		substr(dx,1,3)='M30' or
		substr(dx,1,4)='M310' or
		substr(dx,1,4)='M311' or
		substr(dx,1,4)='M312' or
		substr(dx,1,4)='M313' or
		substr(dx,1,3)='M32' or
		substr(dx,1,3)='M33' or
		substr(dx,1,3)='M34' or
		substr(dx,1,3)='M35' or
		substr(dx,1,3)='M45' or
		substr(dx,1,4)='M461' or
		substr(dx,1,4)='M468' or
		substr(dx,1,4)='M469') 
			and comorbi_20=0 
		then comorbi_20=1;
		*Coagulopathy;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	if (substr(dx,1,3)='D65' or
		substr(dx,1,3)='D66' or
		substr(dx,1,3)='D67' or
		substr(dx,1,3)='D68' or
		substr(dx,1,4)='D691' or
		substr(dx,1,4)='D693' or
		substr(dx,1,4)='D694' or
		substr(dx,1,4)='D695' or
		substr(dx,1,4)='D696') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780'  or
		substr(dx,1,3)='E66')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263' or
		substr(dx,1,3)='E40' or
		substr(dx,1,3)='E41' or
		substr(dx,1,3)='E42' or
		substr(dx,1,3)='E43' or
		substr(dx,1,3)='E44' or
		substr(dx,1,3)='E45' or
		substr(dx,1,3)='E46' or
		substr(dx,1,4)='R634' or
		substr(dx,1,3)='R64' ) 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276' or
		substr(dx,1,4)='E222' or
		substr(dx,1,3)='E86' or
		substr(dx,1,3)='E87' ) 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800' or
		substr(dx,1,4)='D500' ) 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859' or
		substr(dx,1,4)='D508' or
		substr(dx,1,3)='D509' or
		substr(dx,1,3)='D51' or
		substr(dx,1,3)='D52' or
		substr(dx,1,3)='D53' ) 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113' or
		substr(dx,1,3)='F10' or
		substr(dx,1,3)='E52' or
		substr(dx,1,4)='G621' or
		substr(dx,1,4)='I426' or
		substr(dx,1,4)='K292' or
		substr(dx,1,4)='K700' or
		substr(dx,1,4)='K703' or
		substr(dx,1,4)='K709' or
		substr(dx,1,3)='T51' or
		substr(dx,1,4)='Z502' or
		substr(dx,1,4)='Z715' or
		substr(dx,1,4)='Z722') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059' or
		substr(dx,1,3)='F11' or
		substr(dx,1,3)='F12' or
		substr(dx,1,3)='F13' or
		substr(dx,1,3)='F14' or
		substr(dx,1,3)='F15' or
		substr(dx,1,3)='F16' or
		substr(dx,1,3)='F18' or
		substr(dx,1,3)='F19' or
		substr(dx,1,4)='Z715' or
		substr(dx,1,4)='Z722')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991' or
		substr(dx,1,3)='F20' or
		substr(dx,1,3)='F22' or
		substr(dx,1,3)='F23' or
		substr(dx,1,3)='F24' or
		substr(dx,1,3)='F25' or
		substr(dx,1,3)='F28' or
		substr(dx,1,3)='F29' or
		substr(dx,1,4)='F302' or
		substr(dx,1,4)='F312' or
		substr(dx,1,4)='F315' ) 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311' or
		substr(dx,1,3)='294' or
		substr(dx,1,4)='F313' or
		substr(dx,1,4)='F314' or
		substr(dx,1,4)='F315' or
		substr(dx,1,3)='F32' or
		substr(dx,1,3)='F33' or
		substr(dx,1,4)='F341' or
		substr(dx,1,4)='F412' or
		substr(dx,1,4)='F432' )
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
/*dementia*/
if (substr(dx,1,5)='F0150'
or substr(dx,1,5)='F0151'
or substr(dx,1,5)='F0280'
or substr(dx,1,5)='F0281'
or substr(dx,1,5)='F0390'
or substr(dx,1,5)='F0391'
or substr(dx,1,4)='F051'
or substr(dx,1,5)='F1027'
or substr(dx,1,5)='F1097'
or substr(dx,1,4)='G300'
or substr(dx,1,4)='G301'
or substr(dx,1,4)='G308'
or substr(dx,1,4)='G309'
or substr(dx,1,5)='G3101'
or substr(dx,1,5)='G3109'
or substr(dx,1,4)='G311'
or substr(dx,1,5)='G3183'
or substr(dx,1,4)='A811'
or substr(dx,1,4)='A812'
or substr(dx,1,4)='A818'
or substr(dx,1,5)='A8100'
or substr(dx,1,5)='A8101'
or substr(dx,1,5)='A8109'
or substr(dx,1,5)='A8181'
or substr(dx,1,5)='A8182'
or substr(dx,1,5)='A8183'
)  
		and dementia=0 
          then dementia=1;
	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct bene_id,index_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=bene_id index_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by bene_id index_year;
run;

data proj_int.elix_&range1._&range2;
set comorbidity_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set proj_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data proj_int.elix_&range1._&range2._2(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 comorb: index_year:;
run;
proc sort data=proj_int.elix_&range1._&range2._2;
by bene_id index_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are proj_int.elix_0_1yr_2, proj_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=6m);
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=proj_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=proj_int.elix_0_2yr_2;
table comorb:;
run;


/*this is merged into the main dataset when the elixhauser indicator variables 
in the next section*/
proc sql;
create table dem_dx_freq_2 as select distinct bene_id,index_year,
sum(dementia) as dem_dx_6m label="count dementia dx 6m pre core ivw"
 from proj_int.dem_dx_freq group by bene_id,index_year;
quit;

/* merge in the 1 year count of dementia diagnoses from the previous section*/
proc sql;
create table elix_6m_dm_dx_count as select a.*,b.dem_dx_6m from
proj_int.elix_0_6m_2 a left join
dem_dx_freq_2 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*overwrite the previously saved dataset with one with the additional dementia variable added*/
data proj_int.elix_0_6m_2;
set elix_6m_dm_dx_count;
if comorb_31_0_6m=0 and dem_dx_6m<=0 then dem_dx_6m=0;
run;

proc freq data=proj_int.elix_0_6m_2;
table comorb:;
run;

 

H="Charlson"
/*

Created by: EBL
Date Created: 2/7/19

Updated by:
Date Updated:




**************************************************


/*Add indicator variables for the Charlson comorbidities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    Comorbidity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining Comorbidities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

/*final datasets to be merged are proj_int.charls_0_1yr and proj_int.charls_0_2yr*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro charlson(range1=,range2=);

data dx_charlson;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;

*do over dx;
   *Myocardial Infarction;
   if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412')
               and charlson_1=0
               then charlson_1=1;
   *Congestive heart failure;
   if(substr(dx,1,5)='39891' or
               substr(dx,1,5)='40201' or
               substr(dx,1,5)='40211' or
               substr(dx,1,5)='40291' or
               substr(dx,1,5)='40401' or
               substr(dx,1,5)='40403' or
               substr(dx,1,5)='40411' or
               substr(dx,1,5)='40413' or
               substr(dx,1,5)='40491' or
               substr(dx,1,5)='40493' or
               substr(dx,1,4)='4254' or
               substr(dx,1,4)='4255' or
               substr(dx,1,4)='4256' or
               substr(dx,1,4)='4257' or
               substr(dx,1,4)='4258' or
               substr(dx,1,4)='4259' or
               substr(dx,1,3)='428')
               and charlson_2=0
               then charlson_2=1;
   *Periphral Vascular Disease;
    if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434')
               and charlson_3=0
               then charlson_3=1;
    *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438')
               and charlson_4=0
               then charlson_4=1;
    *Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312')
               and charlson_5=0
               then charlson_5=1;
   *Chronic Pulmonary Disease ;
        if(substr(dx,1,5)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088')
               and charlson_6=0
               then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725')
               and charlson_7=0
               then charlson_7=1;
 *Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534')
               and charlson_8=0
               then charlson_8=1;
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427')
               and charlson_9=0
               then charlson_9=1;
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509')
               and charlson_10=0
               then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507')
		and charlson_11=0
                then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449')
		and charlson_12=0
                then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' )
		and charlson_13=0
                then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,3)='2386' )
		and charlson_14=0
                then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      		substr(dx,1,4)='5728' )
		and charlson_15=0
                then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' )
		and charlson_16=0
                then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' )
		and charlson_17=0
                then charlson_17=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data charlson_1(keep=bene_id index_year charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.charls_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 charls: index_year:;
run;
proc sort data=proj_int.charls_&range1._&range2.;
by bene_id index_year;
run;

%mend;

%charlson(range1=0, range2=6m);
%charlson(range1=0, range2=1yr);
%charlson(range1=0, range2=2yr);

proc freq data=proj_int.charls_0_1yr;
table charls:;
run;

proc freq data=proj_int.charls_0_6m;
table charls:;
run;

H="CCW"
/*

Created by: EBL
Date Created: 2/7/19

Updated by: EBL
Date Updated: 6/6/19




**************************************************


/*CMS Data Warehouse Chronic Conditions*/
/*final datasets to merge are proj_int.chronic_21_1yr3_0 & proj_int.chronic_21_2yr3_0*/
/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=proj_int.dx_0_6m
outfile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_6m.dta" replace;
run;

proc export data=proj_int.dx_0_1yr
outfile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_1yr.dta" replace;
run;

proc export data=proj_int.dx_0_2yr
outfile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

capture log close
clear
set more off
local datapath D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data

use `datapath'\dx_0_6m.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_6m_2.dta,replace
outsheet using `datapath'\dx_0_6m_2.csv, comma replace


use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace
outsheet using `datapath'\dx_0_1yr_2.csv, comma replace


clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace
outsheet using `datapath'\dx_0_2yr_2.csv, comma replace


/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/
/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


proc import 
datafile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_1yr_2.csv" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_6m_2.csv" 
out=dx_0_6m_2 replace;
run;

proc import 
datafile="D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\data\int_data\dx_0_2yr_2.csv" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='D:\NHATS\Projects\serious_illness\ask_identifying_serious_illness_icd9_to_10\ref_docs\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore. as
select distinct bene_id,index_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bene_id,index_year;
quit;

proc sort data=bid_dx_0_&precore. nodupkey;
by bene_id index_year;
run;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data proj_int.chronic_21_&precore.3_0;
set test;
bene_id=bene_id_&precore.;
index_year=index_year_&precore.;
drop bene_id_&precore. index_year_&precore.;
run;

%mend;

/*2 datasets are proj_int.chronic_21_1yr_0 and proj_int.chronic_21_2yr_0*/
%cc(precore=6m);
%cc(precore=1yr);
%cc(precore=2yr);

data proj_int.ccw;
set proj_int.chronic_21_6m3_0;
index_year2=input(index_year,8.);
drop index_year;
rename index_year2=index_year;
run;

H="Utilization pre-index"



/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if index_date-admit_date>&days. then do;
	admit_date=index_date-&days.;
	admit_trunc=1;
	end;
if index_date<disch_date then do;
	disch_date=index_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre ivw ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre ivw ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre ivw ivw",
/*ICU stays*/
count(case when icu_days>0 then 1 else . end) as n_icu_stays_&suffix. 
	label="ICU stays &suffix pre ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre ivw ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre ivw ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre ivw ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre ivw ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre ivw ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;



proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_6m as select a.*,b.icu_days_6m,b.n_icu_stays_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ip1 as select a.*,b.icu_days_12m,b.n_icu_stays_12m,
b.n_ip_admit_12m,b.n_hospd_12m,b.n_em_urgent_admit_12m,b.n_em_admit_12m,
b.n_urgent_admit_12m,b.n_elect_admit_12m,b.n_ED_ip_12m
from ip_6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip1 ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_12m n_ip_admit_12m n_hospd_12m n_em_urgent_admit_12m
	n_em_admit_12m n_urgent_admit_12m n_elect_admit_12m n_ED_ip_12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre ivw";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre ivw";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre ivw";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre ivw";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre ivw";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre ivw";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre ivw";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre ivw, from charges";

 if n_ip_admit_12m=0 then ind_hosp_adm_12m=0;
 if n_ip_admit_12m>0 & n_ip_admit_12m~=. then ind_hosp_adm_12m=1;
 label ind_hosp_adm_12m="Indicator for any hospital admission 12m pre ivw";

 if n_em_urgent_admit_12m=0 then ind_em_ur_adm_12m=0;
 if n_em_urgent_admit_12m>0 & n_em_urgent_admit_12m~=. then ind_em_ur_adm_12m=1;
 label ind_em_ur_adm_12m="Ind any urgent or emergent hospital admission 12m pre ivw";

 if n_em_admit_12m=0 then ind_em_adm_12m=0;
 if n_em_admit_12m>0 & n_em_admit_12m~=. then ind_em_adm_12m=1;
 label ind_em_adm_12m="Ind any emergency hospital admission 12m pre ivw";

 if n_urgent_admit_12m=0 then ind_ur_adm_12m=0;
 if n_urgent_admit_12m>0 & n_urgent_admit_12m~=. then ind_ur_adm_12m=1;
 label ind_ur_adm_12m="Ind any urgent hospital admission 12m pre ivw";

 if n_elect_admit_12m =0 then ind_elect_adm_12m=0;
 if n_elect_admit_12m >0 & n_elect_admit_12m ~=. then ind_elect_adm_12m=1;
 label ind_elect_adm_12m="Ind any elective hospital admission 12m pre ivw";

 if (n_ip_admit_12m - n_elect_admit_12m)=0 then ind_nonelect_adm_12m=0;
 if (n_ip_admit_12m - n_elect_admit_12m)>0 & n_elect_admit_12m~=. then ind_nonelect_adm_12m=1;
 label ind_nonelect_adm_12m="Ind any non-elective hospital admission 12m pre ivw";

 n_nonelect_adm_12m=(n_ip_admit_12m - n_elect_admit_12m);
 label n_nonelect_adm_12m="total n non-elective ip admit 12m pre ivw";

 if n_ED_ip_12m=0 then ind_ED_adm_12m=0;
 if n_ED_ip_12m>0 & n_ED_ip_12m~=. then ind_ED_adm_12m=1;
 label ind_ED_adm_12m="Ind ED use with hospital admission 12m pre ivw, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_12m n_ip_admit_12m n_hospd_12m ind_hosp_adm_12m n_em_urgent_admit_12m ind_em_ur_adm_12m
	ind_em_adm_12m ind_ur_adm_12m ind_nonelect_adm_12m n_nonelect_adm_12m n_ED_ip_12m ind_ED_adm_12m 
	ind_em_adm_12m*ind_ED_adm_12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set proj_int.snf_meet_365;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set proj_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_12m
	from pre_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_12m=0 then ind_snf_use_12m=0;
 if n_snf_days_12m>0 & n_snf_days_12m~=. then ind_snf_use_12m=1;
 label ind_snf_use_12m="Indicator for any SNF stay 12m pre ivw";
 label n_snf_days_12m="SNF Days 12m pre ivw";

run;


proc freq data=snf; tables n_snf_days_12m / missprint; run;
/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_17 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_183;
oxygen=0;
if h_o2>0 then oxygen=1;
if oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_09_17; run;
data ed_op_1;
set proj_int.op_meet_183(keep=bene_id admit_date disch_date index_date index_year erdaycnt obs_stay);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
if obs_stay=. then obs_stay=0;
if obs_stay>1 then obs_stay=1;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_12m,
sum(obs_stay) as n_obs_stay_12m,
max(obs_stay) as obs_stay_12m
	from ed_op_1 group by bene_id,index_year;
quit;




proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed ;
set ed_op_2;
if n_ed_op_visits_12m=. then n_ed_op_visits_12m=0;
label n_ed_op_visits_12m="Count ED OP visits, 1yr pre ivw";

if n_ed_op_visits_12m=0 then ind_ed_op_12m=0;
if n_ed_op_visits_12m>0 & n_ed_op_visits_12m~=. then ind_ed_op_12m=1;
label ind_ed_op_12m="Indicator any ED OP visits, 1 yr pre ivw";

if n_obs_stay_12m=. then n_obs_stay_12m=0;
label n_obs_stay_12m="Number obs stays, 1 yr pre ivw";

if n_obs_stay_12m=. then obs_stay_12m=0;
label obs_stay_12m="Indicator any obs stay, 1 yr pre ivw";
run;

proc freq; tables n_ed_op_visits_12m n_obs_stay_12m /missprint; run;

data hh(keep=bene_id index_year ind_hh_12m);
set proj_int.hh_meet_365;
ind_hh_12m=1;
run;

proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;
proc sort data=hh out=hh nodupkey; by bene_id index_year; run;


/*housecalls

housecall codes (from Bruce Kinosian from CMS on 8/16/17) are 99341-99350
and dom care codes are 99324-99328 and 99334-99337

POS codes are 12 13 14

*/

%macro pb_pre (days=,suf=);

proc sql;
create table pb_meet_&days.d_bef as select * from
proj_int.index a
left join medi.pb_09_17 b
on a.bene_id=b.bene_id and admit_date<=index_date<=admit_date+&days;
quit;


data hc;
set pb_meet_&days.d_bef;
array this hcpcscd1-hcpcscd13;
code=0;
do over this;
if in(this,"99324","99325","99326","99327","99328","99334","99335","99336","99337", 
	"99341","99342","99343","99344","99345","99346","99347","99348","99349","99350") and code=0 
	then code=1;
end;
array that pos1-pos13;
place=0;
do over that;
if in(that,"12","13","14") and place=0 then place=1;
end;
housecall=place=1 and code=1;
run;

proc sql; 
create table hc_&suf as select distinct bene_id, index_date,
sum(housecall) as n_housecalls_&suf
from hc
group by bene_id, index_date;
quit;

%mend;

/*housecalls

housecall codes (from Bruce Kinosian from CMS on 8/16/17) are 99341-99350
and dom care codes are 99324-99328 and 99334-99337

POS codes are 12 13 14

*/

%macro pb_post (days=,suf=);

proc sql;
create table pb_meet_&days.d_bef as select * from
proj_int.index a
left join medi.pb_09_17 b
on a.bene_id=b.bene_id and admit_date>=index_date>=admit_date-&days;
quit;


data hc;
set pb_meet_&days.d_bef;
array this hcpcscd1-hcpcscd13;
code=0;
do over this;
if in(this,"99324","99325","99326","99327","99328","99334","99335","99336","99337", 
	"99341","99342","99343","99344","99345","99346","99347","99348","99349","99350") and code=0 
	then code=1;
end;
array that pos1-pos13;
place=0;
do over that;
if in(that,"12","13","14") and place=0 then place=1;
end;
housecall=place=1 and code=1;
run;

proc sql; 
create table hc_&suf as select distinct bene_id, index_date,
sum(housecall) as n_housecalls_&suf
from hc group by bene_id, index_date;
quit;

%mend;

%pb_pre(days=365,suf=n12m);
%pb_pre(days=90,suf=n3m);
%pb_post(days=365,suf=p12m);
%pb_post(days=90,suf=p3m);

proc sql;
create table pb as select * from
proj_int.index a
left join 
hc_n3m b
on a.bene_id=b.bene_id and a.index_date=b.index_date
left join
hc_n12m c
on a.bene_id=c.bene_id and a.index_date=c.index_date
left join 
hc_p3m d
on a.bene_id=d.bene_id and a.index_date=d.index_date
left join
hc_p12m e
on a.bene_id=e.bene_id and a.index_date=e.index_date;
quit;

proc sql;
create table proj_int.utilization_pre as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year
left join
hh g
on trim(left(a.bene_id))=trim(left(g.bene_id)) and a.index_year=g.index_year
left join 
pb h
on trim(left(a.bene_id))=trim(left(h.bene_id)) and a.index_year=h.index_year;
quit;

proc contents data=proj_int.utilization_pre; 
run;



H="Get spending"
/*Add total Medicare payments from claims 1 index_date after interview
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 index_date of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from proj_int.&source._meet_&days_after_core.p
where &days_start<=disch_date-index_date<=&days_after_core and
&days_start<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date>&days_after_core and 0<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((index_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date<=&days_after_core and admit_date-index_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-index_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;
/*note-12/5/18, switched to CPI-U for inflation adjustment for all projects
adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 index_date period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
end;


if year(admit_date)=2017 then rate=1;
if year(admit_date)=2016 then rate=1.020859;
if year(admit_date)=2015 then rate=1.033057;
if year(admit_date)=2014 then rate=1.034204;
if year(admit_date)=2013 then rate=1.049621;
if year(admit_date)=2012 then rate=1.06334;
if year(admit_date)=2011 then rate=1.082331;
if year(admit_date)=2010 then rate=1.110411;
if year(admit_date)=2009 then rate=1.124767;
if year(admit_date)=2008 then rate=1.121642;
if year(admit_date)=2007 then rate=1.15412;
if year(admit_date)=2006 then rate=1.177546;

&source._paid_by_mc=rate*(clm_pmt_amt+clm_pass_thru_per_diem_amt);
run;
*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by bene_id,index_date;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source._&name._post ;
 by bene_id index_date;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set proj_int.&source._meet_&days_after_core.p;
/*adjust to 2014 dollars*/

if year(admit_date)=2017 then rate=1;
if year(admit_date)=2016 then rate=1.020859;
if year(admit_date)=2015 then rate=1.033057;
if year(admit_date)=2014 then rate=1.034204;
if year(admit_date)=2013 then rate=1.049621;
if year(admit_date)=2012 then rate=1.06334;
if year(admit_date)=2011 then rate=1.082331;
if year(admit_date)=2010 then rate=1.110411;
if year(admit_date)=2009 then rate=1.124767;
if year(admit_date)=2008 then rate=1.121642;
if year(admit_date)=2007 then rate=1.15412;
if year(admit_date)=2006 then rate=1.177546;

&source._paid_by_mc=rate*(clm_pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by bene_id,index_date;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source&month_n._post ;
 by bene_id index_date;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 index_dates prior to death*/
/******************************************************************/
 %all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data proj_int.mc_costs_all;
merge ip_12m_post snf_12m_post hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m_post snf_6m_post hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by bene_id index_date;
run;

proc means data=proj_int.mc_costs_all; run;

H="Other outcomes from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.p;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if disch_date-index_date>&days. then do;
	disch_date=index_date+&days.;
	admit_trunc=1;
	end;
if admit_date<index_date then do;
	admit_date=index_date;
	admit_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. post ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. post ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. post ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. post ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. post ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. post ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. post ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. post ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=p6m);
%admissions(days=365,suffix=p12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;


proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_p6m as select a.*,b.icu_days_p6m,
b.n_ip_admit_p6m,b.n_hospd_p6m,b.n_em_urgent_admit_p6m,b.n_em_admit_p6m,
b.n_urgent_admit_p6m,b.n_elect_admit_p6m,b.n_ED_ip_p6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ip1 as select a.*,b.icu_days_p12m,
b.n_ip_admit_p12m,b.n_hospd_p12m,b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from ip_p6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip1 ;
 array list icu_days_p6m n_ip_admit_p6m n_hospd_p6m n_em_urgent_admit_p6m 
	n_em_admit_p6m n_urgent_admit_p6m n_elect_admit_p6m n_ED_ip_p6m
	icu_days_p12m n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_p6m=0 then ind_hosp_adm_p6m=0;
 if n_ip_admit_p6m>0 & n_ip_admit_p6m~=. then ind_hosp_adm_p6m=1;
 label ind_hosp_adm_p6m="Indicator for any hospital admission 6m post ivw";

 if n_em_urgent_admit_p6m=0 then ind_em_ur_adm_p6m=0;
 if n_em_urgent_admit_p6m>0 & n_em_urgent_admit_p6m~=. then ind_em_ur_adm_p6m=1;
 label ind_em_ur_adm_p6m="Ind any urgent or emergent hospital admission 6m post ivw";

 if n_em_admit_p6m=0 then ind_em_adm_p6m=0;
 if n_em_admit_p6m>0 & n_em_admit_p6m~=. then ind_em_adm_p6m=1;
 label ind_em_adm_p6m="Ind any emergency hospital admission 6m post ivw";

 if n_urgent_admit_p6m=0 then ind_ur_adm_p6m=0;
 if n_urgent_admit_p6m>0 & n_urgent_admit_p6m~=. then ind_ur_adm_p6m=1;
 label ind_ur_adm_p6m="Ind any urgent hospital admission 6m post ivw";

 if n_elect_admit_p6m =0 then ind_elect_adm_p6m=0;
 if n_elect_admit_p6m >0 & n_elect_admit_p6m ~=. then ind_elect_adm_p6m=1;
 label ind_elect_adm_p6m="Ind any elective hospital admission 6m post ivw";

 if (n_ip_admit_p6m - n_elect_admit_p6m)=0 then ind_nonelect_adm_p6m=0;
 if (n_ip_admit_p6m - n_elect_admit_p6m)>0 & n_elect_admit_p6m~=. then ind_nonelect_adm_p6m=1;
 label ind_nonelect_adm_p6m="Ind any non-elective hospital admission 6m post ivw";

 n_nonelect_adm_p6m=(n_ip_admit_p6m - n_elect_admit_p6m);
 label n_nonelect_adm_p6m="total n non-elective ip admit 6m post ivw";

 if n_ED_ip_p6m=0 then ind_ED_adm_p6m=0;
 if n_ED_ip_p6m>0 & n_ED_ip_p6m~=. then ind_ED_adm_p6m=1;
 label ind_ED_adm_p6m="Ind ED use with hospital admission 6m post ivw, from charges";

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m post ivw";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m post ivw";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m post ivw";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m post ivw";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m post ivw";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m post ivw";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m post ivw";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m post ivw, from charges";

run;

 proc freq;
 table icu_days_p6m n_ip_admit_p6m n_hospd_p6m ind_hosp_adm_p6m n_em_urgent_admit_p6m ind_em_ur_adm_p6m 
	ind_em_adm_p6m ind_ur_adm_p6m ind_nonelect_adm_p6m n_nonelect_adm_p6m n_ED_ip_p6m ind_ED_adm_p6m 
	ind_em_adm_p6m*ind_ED_adm_p6m /missprint;
 run;

proc freq;
table icu_days_p12m n_ip_admit_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months after the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months post-interview*/
data snf_meet_365;
set proj_int.snf_meet_365p;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_aft_365_1;
set snf_meet2_aft_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_aft_365_1;
set snf_meet3_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_aft_365_1;
set snf_meet4_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_aft_365;
set snf_meet1_aft_365 snf_meet2_aft_365_1 snf_meet3_aft_365_1 snf_meet4_aft_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_aft_365 ;
set  snf_meet_aft_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data aft_snf_days_1;
set proj_int.snf_meet_aft_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=aft_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_p12m
	from aft_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_p12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_p12m=0 then ind_snf_use_p12m=0;
 if n_snf_days_p12m>0 & n_snf_days_p12m~=. then ind_snf_use_p12m=1;
 label ind_snf_use_p12m="Indicator for any SNF stay 12m post ivw";
 label n_snf_days_p12m="SNF Days 12m post ivw";

run;

/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_17 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_365p;
oxygen=0;
if h_o2>0 then oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_06_17; run;
data ed_op_1;
set proj_int.op_meet_365p(keep=bene_id admit_date disch_date index_date index_year erdaycnt);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_p12m
	from ed_op_1 group by bene_id,index_year;
quit;

proc freq;
table n_ed_op_visits_p12m;
run;


proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed ;
set ed_op_2;
if n_ed_op_visits_p12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_p12m=0;
label n_ed_op_visits_p12m="Count ED OP visits, 1yr post ivw";

if n_ed_op_visits_p12m=0 then ind_ed_op_p12m=0;
if n_ed_op_visits_p12m>0 & n_ed_op_visits_p12m~=. then ind_ed_op_p12m=1;
label ind_ed_op_p12m="Indicator any ED OP visits, 1 yr post ivw";
run;

proc freq;
table n_ed_op_visits_p12m*ind_ed_op_p12m;
run;

data ed_op_1;
set proj_int.op_meet_183p(keep=bene_id admit_date disch_date index_date index_year erdaycnt);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_p6m
	from ed_op_1 group by bene_id,index_year;
quit;

proc freq;
table n_ed_op_visits_p6m;
run;


proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed_6m ;
set ed_op_2;
if n_ed_op_visits_p6m=. and comorb_1_0_1yr~=. then n_ed_op_visits_p6m=0;
label n_ed_op_visits_p6m="Count ED OP visits, 1yr post ivw";

if n_ed_op_visits_p6m=0 then ind_ed_op_p6m=0;
if n_ed_op_visits_p6m>0 & n_ed_op_visits_p6m~=. then ind_ed_op_p6m=1;
label ind_ed_op_p6m="Indicator any ED OP visits, 1 yr post ivw";
run;



proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;
proc sort data=ed_6m out=ed_6m nodupkey; by bene_id index_year; run;


proc sql;
create table proj_int.utilization_post as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year
left join 
ed_6m g
on trim(left(a.bene_id))=trim(left(g.bene_id)) and a.index_year=g.index_year;
quit;

proc contents data=proj_int.utilization_post; 
run;

H="combine claims and interviews"

data proj_int.index;
set proj_int.index;
if index_date = . then delete;
run;


data proj_int.index;
set proj_int.index;
if bene_id =" " then delete;
run;


proc sql; 
create table tomerge as select * from
proj_int.index a left join
proj_int.ffs_before b 
on a.bene_id=b.bene_id and a.index_year=b.index_year
left join 
proj_int.ffs_after c
on a.bene_id=c.bene_id and a.index_year=c.index_year
left join 
proj_int.elix_0_6m_2 d
on a.bene_id=d.bene_id and a.index_year=d.index_year
left join 
proj_int.charls_0_6m e
on a.bene_id=e.bene_id and a.index_year=e.index_year
left join
proj_int.dmouth_0_6m f
on a.bene_id=f.bene_id and a.index_year=f.index_year
left join 
proj_int.utilization_pre g
on a.bene_id=g.bene_id and a.index_year=g.index_year
left join
proj_int.mc_costs_all h
on a.bene_id=h.bene_id and a.index_year=h.index_year
left join 
proj_int.utilization_post i
on a.bene_id=i.bene_id and a.index_year=i.index_year;
quit;

proc sql;
create table proj_int.serious_ill_int_dataset as select * from
proj_int.nhats a 
left join
tomerge b 
on a.spid=b.spid and a.ivw_year=b.index_year;
quit;

proc export data=proj_int.serious_ill_int_dataset outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\serious_ill_int_dataset.dta" 
replace;
run;

H="Create IAH Flags"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\serious_ill_int_dataset.dta", replace
merge m:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta", nogen keepus(bene_id) update replace
preserve
gen all = 1
gen drop_nocd = 0
replace drop_nocd = 1 if community_dwelling==0
label var drop_nocd "Dropped - Not Community Dwelling"
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
restore

keep if community_dwelling
*keep if wave<6
cap drop bene_id 

merge m:1 spid using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Crosswalks\xwalk_2016.dta" 

keep if _m==3

save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_fullsample.dta", replace


keep bene_id spid wave ivw_month ivw_year


saveold "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_ivwdates.dta", version(12) replace



use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_fullsample.dta", clear

cap drop _merge


gen ffs_6m = 0
replace ffs_6m = 1 if cont_ffs_n_mos>=6 & cont_ffs_n_mos!=.

tempfile d
save `d'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", clear
merge 1:1 bene_id wave using "`d'", keepus(ffs_6m)

gen drop_noffs = 0
replace drop_noffs = 1 if ffs_6m==0
label var drop_noffs "Dropped - No 6m FFS"
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace

use `d', clear



local cvars sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever sr_dementia_ever

 
egen c_con = anycount(`cvars'), values(1)
gen cc_flag = 0
replace cc_flag = 1 if c_con>=2
label var cc_flag "2+ Chronic Conditions"
 
local avars adl_eat_help adl_bath_help adl_toil_help adl_dres_help adl_bed_help adl_ins_help
egen adl_con = anycount(`avars'), values(1)
gen adl_flag = 0
replace adl_flag = 1 if adl_con>=2 
label var adl_flag "2+ ADL Impairment"

gen homebound = 0
replace homebound = 1 if homebound_cat==1

gen homebound_never = 0
replace homebound_never = 1 if homebound_cat==2

rename cc_flag iah_chronic
rename adl_flag iah_adl
rename ind_nonelect_adm_12m iah_nonelect

keep if ffs_6m==1


saveold "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_wave1-7.dta", version(12) replace


H="Search for IP rehab and home calls"
libname claims "D:\NHATS\Shared\base_data\CMS_claims\SAS";
libname cyears "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Cumulative";

proc import datafile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_wave1-7.dta" out=iv_mb2 dbms=stata replace; run; 


/* Identifying Inpatient Rehab */

data ip_check (keep = bene_id index_date index_month year wave ffs_6m);
set iv_mb2;
run;

data inpatient;
set claims.ip_06_17;
run;

data ip_rev;
set cyears.inpatient_revenue_center_j_06_17;
run;

proc sql;
create table ip_clm_rev as select a.*, b.*
from inpatient a
inner join ip_rev b
on a.bene_id = b.bene_id and a.clm_id = b.clm_id;
quit;

proc freq data=inpatient; tables PTNT_DSCHRG_STUS_CD; run;
proc freq data=ip_rev; tables REV_CNTR_UNIT_CNT; run;
 

data ip_clm_rev;
set ip_clm_rev;
disch_rehab = 0;
ip_rehab = 0;
if PTNT_DSCHRG_STUS_CD='62' or PTNT_DSCHRG_STUS_CD='90' then disch_rehab = 1;
if REV_CNTR_UNIT_CNT = 24 then ip_rehab = 1;
run;


proc freq data=ip_clm_rev; tables disch_rehab; run;
proc freq data=ip_clm_rev; tables ip_rehab; run;


data disch_2_iprehab;
set ip_clm_rev;
where disch_rehab = 1;
run;

data ip_rehab;
set ip_clm_rev;
where ip_rehab = 1;
run;

data test;
set disch_2_iprehab ip_rehab;
run;

proc sort data=test nodupkey; by bene_id admit_date; run;


proc sql;
create table ip_restays as select a.*, b.admit_date, b.disch_date
from ip_check a
inner join test b
on a.bene_id = b.bene_id and 0 < a.index_date-b.admit_date <365;
quit;

proc sort data=ip_restays out=ip_rehabstays nodupkey; by bene_id index_date; run;

data ip_rehabstays; /*inpatient hospital rehab stays */
set ip_rehabstays;
ip_rehab = 1;
run;

/* Checking for HH/SNF within 7 days of disch_date */

data homehealth;
set claims.hh_09_17;
run;

data snf;
set claims.snf_09_17;
run;

proc sql;
create table hh_nhats as select a.*, b.*
from ip_check a
inner join homehealth b
on a.bene_id = b.bene_id
where 0 <= a.index_date - b.disch_date <= 365;
quit;

data hh_nhats_short (keep = bene_id index_date admit_date disch_date hh);
set hh_nhats;
hh = 1;
run;

proc sql;
create table snf_nhats as select a.*, b.*
from ip_check a
inner join snf b
on a.bene_id = b.bene_id
where 0 <= a.index_date - b.disch_date <= 365;
quit;

data snf_nhats_short (keep = bene_id index_date admit_date disch_date snf);
set snf_nhats;
snf = 1;
run;

data rehab (rename=(admit_date = rehab_admit disch_date = rehab_disch));
set snf_nhats_short hh_nhats_short;
*format rehab_admit rehab_disch date10.;
run;

proc sql;
create table ip1 as select a.admit_date, a.disch_date, b.*
from inpatient a
inner join rehab b
on a.bene_id = b.bene_id
where 0 <= b.rehab_admit-a.disch_date < 8;
quit;

data ip1;
set ip1 ip_rehabstays;
run;

proc sort data=ip1; by bene_id index_date; run;
proc sort data=ip1 nodupkey; by bene_id index_date; run;

proc freq data=ip1; tables ip_rehab; run;

proc export data=ip1 outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_rehab_flag.dta" replace; run;


/***** Identifying any Home Health Claim +/- 90 days of interview ******/

data homehealth;
set claims.hh_09_17;
run;

proc sql;
create table nhats_hh as select a.*, b.admit_date
from ip_check a
inner join homehealth b
on a.bene_id=b.bene_id and -90<=a.index_date - b.admit_date<=90;
quit;

proc sort data=nhats_hh nodupkey; by bene_id wave; run;

proc export data=nhats_hh outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\homehealth_visit.dta" dbms=stata replace; run;

/****** Identifying any NH claims +/- 90 days of interview *******/

data snf;
set claims.snf_09_17;
run;

proc sql;
create table nhats_snf as select a.*, b.admit_date
from ip_check a
inner join snf b
on a.bene_id=b.bene_id and -90<=a.index_date - b.admit_date <=90;
quit;

proc sort data=nhats_snf nodupkey; by bene_id wave; run;

proc export data=nhats_snf outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\snf_visit.dta" dbms=stata replace; run;



/********** Identifying house calls ************/

/* Identifying house calls */

data carrier;
set claims.pb_09_17;
array dx hcpcscd1--hcpcscd13;
do over dx;
hcpcs_cd=dx;
output;
end;
run;

data carrier1;
set carrier;
cptcodes1 = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier1;
set carrier1;
cpt1flag = 0;
if 99341<=cptcodes1<=99350 or 99324<=cptcodes1<=99328 or 99334<=cptcodes1<=99337 then cpt1flag = 1;
run;

data carrier1;
set carrier1;
where cpt1flag = 1;
run;

proc sort data=carrier1 nodupkey; by bene_id clm_id; run;

data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes);
set cyears.bcarrier_line_j_09_17;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data linecalls;
set carrierline;
where cptflag = 1; * or posflag = 1;
run;

proc sql;
create table carrier2 as select a.*, b.*
from carrier1 a
full outer join linecalls b
on a.bene_id=b.bene_id and a.clm_id = b.clm_id;
quit;

data carrier2;
set carrier2;
if cpt1flag = 1 then cptflag = 1;
run;

data carrier2;
set carrier2;
where cptflag = 1;
year = year(admit_date);
run;

proc sort data=carrier2 nodupkey; by bene_id clm_id; run;

proc sql;
create table annual as select distinct bene_id, year,
sum(cptflag) as housecalls_count
from carrier2
group by bene_id, year;
quit;

proc export data=annual(rename=(year = index_year)) outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\annualcpt_count.dta" replace; run;

proc sql;
create table homecallsb4_90 as select a.*, b.cptcodes, b.admit_date
from ip_check a
inner join carrier2 b
on a.bene_id=b.bene_id and -90<a.index_date-b.admit_date<=90;
quit;

proc sort data=homecallsb4_90 out=test nodupkey; by bene_id wave; run;

proc sql;
create table homecalls_90 as select distinct bene_id, wave,
count(cptcodes) as housecalls90_count
from homecallsb4_90
group by bene_id, wave;
quit;



/*
data homecalls_90;
set homecallsb4_90_1 homecallsb4_90_2 homecallsb4_90_3 homecallsb4_90_4 homecallsb4_90_5;
run;

*/
proc export data=homecalls_90 outfile="D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\homecalls_90.dta" replace; run;



H="Merging it together"

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_wave1-7.dta", clear

/* merge IP rehab */
cap drop _m
merge 1:1 bene_id index_date using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\iah_rehab_flag.dta", keepus(ip_rehab snf hh)
replace ip_rehab=0 if ip_rehab==.
gen ip_rehab_only = 0
replace ip_rehab_only = 1 if ip_rehab==1 & snf==. & hh==.
label var ip_rehab "Inpatient Rehab or SNF/HH within 7 days of IP discharge, 1 yr prior to ivw"
label var ip_rehab_only "Inpatient rehab (no SNF/HH), 1 yr prior to ivw"

/*merge nh */
cap drop _m
merge 1:1 bene_id index_date using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\snf_visit.dta"
gen nh_90 = 0
replace nh_90 = 1 if _m==3
label var nh_90 " NH stay +/- 90 days of ivw"

gen death_90 = 0
replace death_90 = 1 if death_date - index_date <=90

/* merge housecalls flag */
cap drop _m
merge 1:1 bene_id wave using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\homecalls_90.dta"
gen hcalls = 0
replace hcalls = 1 if (housecalls90_count>1 & housecalls90_count!=.) | (housecalls90_count==1 & nh_90==1) | (housecalls90_count==1 & death_90==1) 
label var hcalls "2+ housecalls or 1 + NH/Death +/- 90 days of ivw"


/* house calls count */
cap drop _m
merge 1:1 bene_id index_year using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\annualcpt_count.dta"
drop if _m==2

label var housecalls_count "Ave. number of house calls in calendar year of interview"
cap drop _m

save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", replace


/*Income adjustment to $2017 dollars */
gen income_adj=0
replace income_adj= 1.09*aveincome if wave==1
replace income_adj= 1.07*aveincome if wave==2
replace income_adj= 1.06*aveincome if wave==3
replace income_adj= 1.05*aveincome if wave==4
replace income_adj= 1.04*aveincome if wave==5
replace income_adj= 1.02*aveincome if wave==6
replace income_adj = aveincome if wave==7

xtile income_quart_adj=income_adj, nq(4) 
sum income_adj, d

replace housecalls_count = 0 if housecalls_count==.

gen iah_rehab = 0
replace iah_rehab = 1 if ip_rehab==1 |snf==1 |hh==1

cap drop iah_all

gen iah_all = 0
replace iah_all = 1 if iah_adl==1 & iah_chronic==1 & iah_nonelect==1 & iah_rehab==1

forvalues w = 1/4 {

gen income_quart_`w' = . 
gen income_cat_`w' = 0
replace income_cat_`w'= 1 if income_quart_ad==`w'

replace income_quart_`w' = income_adj if income_quart_adj==`w'
sum income_quart_`w', d
local p = 25*`w' 
local q = r(mean)
local r = round(`q',1)


label var income_quart_`w' "Ave. Income in `p'th quartile (adjusted to 2017 dollars)"
label var income_cat_`w' "% with income in the `p'th quartile"

} 
gen pos_dem = 0
replace pos_dem = 1 if dem_3_cat==2 
label var pos_dem "Indicator Possible Dementia"

merge 1:1 bene_id wave using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\homehealth_visit.dta", keepus(admit_date)

gen mc_hh = 0
replace mc_hh = 1 if _m==3
label var mc_hh "Medicare HH claim +/- 90 days of ivw"
drop _m

gen ind_icu_12m = 0
replace ind_icu_12m = 1 if icu_days_12m>0 & icu_days_12m!=.
label var ind_icu_12m "Indicator ICU stay 12m pre ivw"

gen tot_paid_by_mc_12m=0
foreach x in ip snf hh hs pb op dm {
replace tot_paid_by=tot_paid_by+`x'_paid_by_mc_12m
}


H="housecalls setup"
gen iah_pacute = 0
replace iah_pacute = 1 if iah_rehab==1

label var iah_pacute "IAH - Post Acute Care 12m prior"
label var iah_all "IAH - All Criteria Met"


/* Housecalls population */

merge 1:1 bene_id wave using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\homecalls_90.dta"
drop if _m==2
*drop _m

gen housecalls_90 = .
replace housecalls_90 = 1 if _m==3
label var housecalls_90 "1+ housecalls +/- 90 days of ivw"
bysort spid: egen anyhousecall = count(housecalls_90) 
replace housecalls_90 = 0 if housecalls_90==.
replace anyhousecall = 1 if anyhousecall>1 & anyhousecall!=.
label var anyhousecall "1+ housecalls +/- 90 days of ivw"
preserve
keep spid anyhousecall
duplicates drop

tempfile anycall
save `anycall'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
cap drop _m
merge m:1 spid using "`anycall'"

save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace

restore, preserve 

keep if hcalls==1

gsort spid -wave
by spid: gen ind2=_n==1 
keep if ind2==1 /* keep most recent wave where they had housecalls */
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\housecalls.dta", replace
levelsof spid, local(list)
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
cap drop _m
merge 1:1 spid wave using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\housecalls.dta", keepus(ind2) update replace
label var ind2 "Housecall, most recent wave"
cap drop _m
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
restore
gen droplist = 0
foreach x in `list' {

replace droplist=1 if spid==`x'
}

drop if droplist==1 /* drop spid for those who have housecalls */
gsort spid -wave
*drop if wave==7
by spid: gen ind3=_n==1
keep if ind3==1 /* keep most recent nonhousecalls -- limit to wave 6 for 1 year followup*/
cap drop _m
tempfile d
save `d'
preserve
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
cap drop _m
merge 1:1 spid wave using "`d'", keepus(ind3)
label var ind3 "No Housecall, most recent wave"
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", replace
restore


append using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\housecalls.dta"

cap drop st_date
save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\housecalls.dta", replace 

use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_7.dta" , replace

keep if wave==1
gen old = 1
label var old "Original Cohort in Wave 1"
tempfile old
*gen st_date = index_date - 90 
*label var st_date "Start of observation period, 90 days pre ivw"

save `old'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\housecalls.dta", clear
cap drop _m
merge 1:1 spid using "`old'", keepus(old) update replace
drop if _m==2
drop _m

replace old = 0 if old==.
/*
replace st_date = ivw_date - 90 if wave==5 & st_date==.

gen end_dt = ivw_date + 90

gen person_time = admit_date - st_date
replace person_time = end_dt - st_date if person_time==.
replace person_time = person_time*0.00273

egen person_yrs = total(person_time)
*/

* censoring 1 year outcomes for wave 7

foreach x in ind_hosp_adm_p12m ind_ed_adm_p12m tot_paid_by_mc_12m {

replace `x' = . if wave==7
}

save "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", replace 


H="Graphs"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear

global output "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"

gen homebound_part = 0
replace homebound_part = 1 if inrange(homebound_cat,2,3)
label var homebound_part "Partially Homebound"
label var homebound "Completely Homebound"

gen homebound_not = 0
replace homebound_not = 1 if homebound_cat>=4
label var homebound_not "Indepent"

gen homebound_3cat = .
replace homebound_3cat = 1 if homebound==1
replace homebound_3cat = 2 if homebound_part==1
replace homebound_3cat = 3 if homebound_3cat==.
la define hblbl 1"Complete HB"2"Partial HB"3"Independent"
la values homebound_3cat hblbl

gen anyhcall = 0
replace anyhcall = 1 if housecalls_count>=1 & housecalls_count!=.

/***** Predictive margins for prevalence *******/
svyset spid [pw=anfinwgt], strata(varstrat)

svy: logit anyhcall year##homebound_3cat
margins year##homebound_3cat
marginsplot, title("Any housecall in calendar year (6m FFS + CD + Weights)") ytitle("Housecalls (%)") legend(size(medsmall) order(1 "Completely Homebound" 2 "Partially Homebound" 3 "Independent" 4 "All"))

graph export "$output\anyhcall_`c(current_date)'.png", replace

svy: logit hcalls year##homebound_3cat
margins year##homebound_3cat
marginsplot, title("2+ Hcalls OR 1 + NH/Death 90 days of IVW (6m FFS + CD + Weights)") ytitle("Housecalls (%)") legend(size(medsmall) order(1 "Completely Homebound" 2 "Partially Homebound" 3 "Independent" 4 "All"))

graph export "$output\hcalls_`c(current_date)'.png", replace

foreach x in rcfres metro_ind iah_nonelect livealone {

replace `x' = `x'*100
}

graph bar rcfres metro_ind iah_nonelect livealone, over(homebound_3cat) blabel(bar)


H="housecalls table 1"
/* Table 1 */

replace homebound_cat = 4 if homebound_cat==.

sum housecalls_count if hcalls==1 // all respondents
sum housecalls_count if hcalls==1 & homebound_cat<4 // any homebound
sum housecalls_count if hcalls==1 & homebound_cat==1 // never rarely leaves home
sum housecalls_count if hcalls==1 & homebound_cat==2 // 
sum housecalls_count if hcalls==1 & homebound_cat==3 
sum housecalls_count if hcalls==1 & homebound_cat==4 & housecalls_count<45 // independent, drop outlier

H="housecalls table 4 column"

use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", clear
sort spid wave
by spid: replace metro_ind=metro_ind[_n-1] if missing(metro_ind)
tempfile t1
save `t1'


use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 

drop metro_ind
merge 1:1 spid wave using `t1', nogen keep(match master) 


local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)


replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 income_cat_1 income_cat_2 income_cat_3 income_cat_4 female white  ///
black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem pos_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_12m ind_ed_adm_12m ind_icu_12m died_12 hcalls homebound homebound_2 homebound_3 homebound_4 mc_hh
local cvars2 housecalls_count

local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

sum `full'

local rd: word count `full' 1

mat tab1 = J(`rd',4,.)
mat stars = J(`rd',4,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==1, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==0, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r
}

foreach x of local ivars1 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' cp_hb if hcalls==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0  & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==0  & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' cp_hb if hcalls==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}

foreach x of local ivars2 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' cp_hb if hcalls==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0  & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==0  & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' cp_hb if hcalls==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}

foreach x of local ivars3 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' cp_hb if hcalls==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0  & hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if cp_hb==0  & hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' hcalls if cp_hb==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}
 
foreach x of local cvars2 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==1, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==0, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r
}

sum age if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable, statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "Complete/Partial HB", "", "", "Not HB", \"", "No Housecalls", "Housecalls", "No Housecalls", "Housecalls") sdec(2) annotate(stars) asymbol(*,**) landscape ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


H="housecalls table 4 column -- UW censored"

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 

local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 income_cat_1 income_cat_2 income_cat_3 income_cat_4 female white  ///
black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem pos_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_12m ind_ed_adm_12m ind_icu_12m died_12 hcalls homebound homebound_2 homebound_3 homebound_4 mc_hh
local cvars2 housecalls_count


local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

local rd: word count `full' 1

mat tab1 = J(`rd',4,.)
mat stars = J(`rd',4,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==1, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==0, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r
}

foreach x of local ivars1 {

*
sum `x' if cp_hb==1 & hcalls==0
local a = r(mean)*r(N)

sum `x' if cp_hb==1 & hcalls==1
local b = r(mean)*r(N)
*
//

sum `x' if cp_hb==1 & hcalls==0
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==1 & hcalls==1
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c
*
sum `x' if cp_hb==0 & hcalls==0
local e = r(mean)*r(N)

sum `x' if cp_hb==0 & hcalls==1
local d = r(mean)*r(N)
*
//

sum `x' if cp_hb==0  & hcalls==0
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==0  & hcalls==1
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}

foreach x of local ivars2 {

*
sum `x' if cp_hb==1 & hcalls==0
local a = r(mean)*r(N)

sum `x' if cp_hb==1 & hcalls==1
local b = r(mean)*r(N)
*
//

sum `x' if cp_hb==1 & hcalls==0
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==1 & hcalls==1
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c
*
sum `x' if cp_hb==0 & hcalls==0
local e = r(mean)*r(N)

sum `x' if cp_hb==0 & hcalls==1
local d = r(mean)*r(N)
*
//

sum `x' if cp_hb==0  & hcalls==0
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==0  & hcalls==1
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}

foreach x of local ivars3 {

*
sum `x' if cp_hb==1 & hcalls==0
local a = r(mean)*r(N)

sum `x' if cp_hb==1 & hcalls==1
local b = r(mean)*r(N)
*
//

sum `x' if cp_hb==1 & hcalls==0
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==1 & hcalls==1
if `a'>=11 & `b'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `a'<11 | `b'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==1, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local ++c
*
sum `x' if cp_hb==0 & hcalls==0
local e = r(mean)*r(N)

sum `x' if cp_hb==0 & hcalls==1
local d = r(mean)*r(N)
*
//

sum `x' if cp_hb==0  & hcalls==0
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

local ++c

sum `x' if cp_hb==0  & hcalls==1
if `e'>=11 & `d'>=11 mat tab1[`r',`c'] = r(mean)*100
*if `e'<11 | `d'<11 mat tab1[`r',`c'] = "NR"

tab `x' hcalls if cp_hb==0, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r

}
 
foreach x of local cvars2 {

sum `x' if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==1, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local ++c

sum `x' if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x' if cp_hb==0, by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local c = 1
local ++r
}

sum age if cp_hb==1 & hcalls==0
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==1 & hcalls==1
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==0 & hcalls==0
mat tab1[`r',`c'] = r(N)

local ++c

sum age if cp_hb==0 & hcalls==1
mat tab1[`r',`c'] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using `logpath'\table1_4col_censored`date'.doc, replace statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "Complete/Partial HB", "", "", "Not HB", \"", "No Housecalls", "Housecalls", "No Housecalls", "Housecalls") sdec(2) annotate(stars) asymbol(*,**) landscape ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. Blank rows are censored because of NHATS/CMS cellsize restrictions. *p<0.05, **p<0.01")


H="housecalls table 2 column"

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 

local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)


replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4


local cvars1 age income_quart_1 income_quart_2 income_quart_3 income_quart_4 // score_community
local ivars1 income_cat_1 income_cat_2 income_cat_3 income_cat_4 female white  ///
black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem pos_dem
local ivars3 adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_12m ind_ed_adm_12m ind_icu_12m died_12 hcalls homebound homebound_2 homebound_3 homebound_4 mc_hh
local cvars2 housecalls_count


local full `cvars1' `ivars1' `ivars2' `ivars3' `cvars2'

local rd: word count `full' 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1

foreach x of local cvars1 {

sum `x' if hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local --c
local ++r
}

foreach x of local ivars1 {

sum `x' if hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' hcalls, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local --c
local ++r

}

foreach x of local ivars2 {

sum `x' if hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' hcalls, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local --c
local ++r

}

foreach x of local ivars3 {

sum `x' if hcalls==0
mat tab1[`r',`c'] = r(mean)*100

local ++c

sum `x' if hcalls==1
mat tab1[`r',`c'] = r(mean)*100

tab `x' hcalls, chi2
mat stars[`r',`c'] = (r(p)<.01) + (r(p)<.05)

local --c
local ++r

}
 
foreach x of local cvars2 {

sum `x' if hcalls==0
mat tab1[`r',`c'] = r(mean)

local ++c
sum `x' if hcalls==1
mat tab1[`r',`c'] = r(mean)

ttest `x', by(hcalls)
mat stars[`r',`c']= (r(p)<.01) + (r(p)<.05)

local --c
local ++r
}

sum age if hcalls==0
mat tab1[`r',`c'] = r(N)

local ++c

sum age if hcalls==1
mat tab1[`r',`c'] = r(N)


mat rownames tab1= `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' N

frmttable using `logpath'\table1_2_col_housecalls`date'.doc, replace statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "No Housecalls", "Housecalls") sdec(2) annotate(stars) asymbol(*,**) landscape ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


H="Weighted X-section"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear

global output "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

gen homebound_part = 0
replace homebound_part = 1 if inrange(homebound_cat,2,3)
label var homebound_part "Partially Homebound"
label var homebound "Completely Homebound"

gen homebound_not = 0
replace homebound_not = 1 if homebound_cat>=4
label var homebound_not "Indepent"

gen homebound_3cat = .
replace homebound_3cat = 1 if homebound==1
replace homebound_3cat = 2 if homebound_part==1
replace homebound_3cat = 3 if homebound_3cat==.
la define hblbl 1"Complete HB"2"Partial HB"3"Independent"
la values homebound_3cat hblbl

gen anyhcall = 0
replace anyhcall = 1 if housecalls_count>=2 & housecalls_count!=.

svyset spid [pw=anfinwgt], strata(varstrat)

gen all = 1

mat tab1=J(7,6,.)

local r = 1
local c = 1

forvalues i=1/7 {

svy: mean hcalls if wave==`i'
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: mean anyhcall if wave==`i'
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: total all if wave==`i'
mat tab1[`r',`c'] = (e(N_pop))

local ++c
svy: mean hcalls if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: mean anyhcall if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: total all if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (e(N_pop))

local c = 1
local ++r
}

mat rownames tab1 = "2011" "2012" "2013" "2014" "2015" "2016" "2017"
mat list tab1

frmttable using $output\table2_pop_estimates`date'.doc, replace statmat(tab1) ///
varlabels title("Table 1: Weighted Population Estimates NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "All", "", "", "Complete/Partial HB" \ "Years", "Weighted % - 2+ Hcalls (or 1+NH/Death)", "Weighted % - 2+ Hcall in calendar year", "Total CD+FFS Population Estimates", "Weighted % - 2+ Hcalls (or 1+NH/Death)", "Weighted % - 2+ Hcall in calendar year", "Total CD+FFS+HB Population Estimates") sdec(2) ///
note("Population Estimates is the total (weighted) number of 6mFFS + CD people in the NHATS year")

////////

mat tab2=J(7,8,.)

local r = 1
local c = 1

forvalues i=1/7 {

svy: mean anyhcall if wave==`i'
mat tab2[`r',`c'] = (r(table)[1,1]*100)

local ++c
mat tab2[`r',`c'] = (r(table)[1,1]*e(N_pop)) // population estimate

local ++c
mat tab2[`r',`c'] = (r(table)[5,1]*e(N_pop)) // lower bound

local ++c
mat tab2[`r',`c'] = (r(table)[6,1]*e(N_pop)) // upper bound

local ++c
svy: mean anyhcall if wave==`i' & homebound_3cat<3
mat tab2[`r',`c'] = (r(table)[1,1]*100)

local ++c
mat tab2[`r',`c'] = (r(table)[1,1]*e(N_pop)) // population estimate

local ++c
mat tab2[`r',`c'] = (r(table)[5,1]*e(N_pop)) // lower bound

local ++c
mat tab2[`r',`c'] = (r(table)[6,1]*e(N_pop)) // upper bound

local c = 1
local ++r
}

mat rownames tab2 = "2011" "2012" "2013" "2014" "2015" "2016" "2017"
mat list tab2

frmttable using $output\table2_pop_estimates`date'.doc, addtable statmat(tab2) ///
varlabels title("Table 2: Weighted Population Estimates NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "All", "", "", "Complete/Partial HB" \ "Years", "Weighted % - 2+ Hcalls in calendar year", "2+ Hcalls Population Estimate", "95% Lower Bound", "95% Upper Bound", "Weighted % - 2+ Hcalls in calendar year", "2+ Hcalls + HB Population Estimate", "95% Lower Bound", "95% Upper Bound") sdec(2) ///
note("Population Estimates is the total (weighted) number of 6mFFS + CD people in the NHATS year")



H="Sample Derivation"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\int_data\sample_deri.dta", clear
local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

gsort spid wave
by spid: gen first=_n==1

bysort spid: egen ever_cd = max(community_dwelling)
gen never_cd = 0
replace never_cd = 1 if ever_cd==0
label var never_cd "Never community dwelling"

by spid:egen ever_ffs = max(ffs_6m)
gen never_ffs = 0
replace never_ffs = 1 if ever_ffs==0
label var never_ffs "Never 6m ffs"
 

label var ind2 "Most recent wave with a housecall"
label var all "ALL NHATS respondents Waves 1-7"

gen drop_notrec = 0
replace drop_notrec = 1 if ind2==. & ind3==.
label var drop_notrec "Dropped, no housecall & not most recent wave"

local samp all
local drops drop_nocd 
local drop2 drop_noffs
local drop3 drop_notrec
local keeps ind2 ind3



local rd: word count `samp' `drops' `drop2' `drop3' `keeps'
di `rd'
mat tab1 = J(`rd',2,.)

local r=1

foreach x of local samp {

sum `x'
mat tab1[`r',1] = r(N)
mat tab1[`r',2] = 12427
local ++r
}

foreach x of local drops {
sum `x'
mat tab1[`r',1] = r(sum)
preserve 
keep if `x'==1
sum never_cd if first==1
mat tab1[`r',2] = r(sum)
restore
local ++r
}
drop if drop_nocd==1 

foreach x of local drop2 {
sum `x'
mat tab1[`r',1] = r(sum)
preserve 
keep if `x'==1
duplicates drop spid, force
sum never_ffs if first==1
mat tab1[`r',2] = r(sum)
restore
local ++r
}

drop if drop_noffs==1

foreach x of local drop3 {
sum `x'
mat tab1[`r',1] = r(sum)
preserve 
keep if `x'==1
duplicates drop spid, force
sum `x' 
mat tab1[`r',2] = 0
restore
local ++r
}


foreach x of local keeps {
sum `x'
mat tab1[`r',1] = r(sum)
mat tab1[`r',2] = r(sum)

local ++r
}

mat rownames tab1 = `samp' `drops' `drop2' `drop3' `keeps'

mat list tab1

frmttable using `logpath'\Sample_derivation`date'.doc, replace statmat(tab1) ///
varlabels title("Housecalls NHATS Waves 1-7") ///
ctitles("", "All Observations", "Unique people") sdec(0) ///
note("477 People had 1+ CPT codes +/- 90 days of interview." / "Housecalls are 2+ CPT codes +/- 90 days or ivw, or 1 CPT code & NH/Death +/- 90 days of ivw." )


H="********************"


H="things for Bruce 12/3/19"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear

global output "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

gen homebound_part = 0
replace homebound_part = 1 if inrange(homebound_cat,2,3)
label var homebound_part "Partially Homebound"
label var homebound "Completely Homebound"

gen homebound_not = 0
replace homebound_not = 1 if homebound_cat>=4
label var homebound_not "Indepent"

gen homebound_3cat = .
replace homebound_3cat = 1 if homebound==1
replace homebound_3cat = 2 if homebound_part==1
replace homebound_3cat = 3 if homebound_3cat==.
la define hblbl 1"Complete HB"2"Partial HB"3"Independent"
la values homebound_3cat hblbl

gen anyhcall = 0
replace anyhcall = 1 if housecalls_count>=2 & housecalls_count!=.

svyset spid [pw=anfinwgt], strata(varstrat)

gen all = 1

gen iah_rehab = 0
replace iah_rehab = 1 if ip_rehab==1 |snf==1 |hh==1

drop *jenny
merge 1:1 spid wave using "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", keep(match master) nogen keepusing(*jenny)
replace iah_adl=1 if adlcount_jenny>=2

gen iah_all = 0
replace iah_all = 1 if iah_adl==1 & iah_chronic==1 & iah_nonelect==1 & iah_rehab==1


local r=1 
local c=1
mat tab=J(6,6,.)

foreach x of varlist iah_nonelect iah_chronic iah_adl iah_rehab iah_all {
	sum `x'
	mat tab[`r',1]=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',2]=r(mean)*100
	mat tab[`r',3]=r(sum)
	egen ind_`x'=max(`x')
	local r=`r'+1
}

preserve
by spid, sort: egen w=max(cond(wave==year-2010,anfinwgt,0))
keep if iah_all==1
sort spid wave
by spid: keep if _n==1
*replace anfinwgt=w
gen iah_all_u=1
label var iah_all_u "IAH (at first wave meet all criteria)"

foreach x of varlist iah_all_u {
	sum `x'
	mat tab[`r',1]=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',2]=r(mean)*100
	mat tab[`r',3]=r(sum)
	egen ind_`x'=max(`x')
	local r=`r'+1
}


mat rownames tab= iah_nonelect iah_chronic iah_adl iah_rehab iah_all iah_all_u

frmttable, statmat(tab) title("IAH") ctitles("" "N (all waves)" "%" "Pop estimate") sdec(0,2,0,0,2,0) varlabels

local r=1
mat tab=J(5,3,.)

levelsof homebound_cat, local(levels)
foreach l of local levels {
	local lab : label homebound_cat `l'
	gen hb`l'=homebound_cat==`l' if !missing(homebound_cat)
	label var hb`l' "`lab'"
	local hb `hb' hb`l'
}

foreach x of varlist `hb' hcalls {
	sum `x'
	mat tab[`r',`c']=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',`c'+1]=r(mean)*100
	mat tab[`r',`c'+2]=r(sum)
	local r=`r'+1
}

mat rownames tab= `hb' hcalls

frmttable, statmat(tab) title("Homebound/HBMC among IAH (at first IAH meeting)") ctitles("" "N" "%" "Pop estimate") sdec(0,2,0,0,2,0) varlabels



H="looking 12m after 12/3/19"
import sas BENE_ID CLM_ID REV_CNTR using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Cumulative\inpatient_revenue_center_j_06_17.sas7bdat", case(lower) clear
tempfile iprev
save `iprev'

use spid wave index_date bene_id using "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear

tempfile index
save `index'

use bene_id admit_date clm_id disch_date clm_ip_admsn_type_cd ptnt_dschrg_stus_cd using"D:\NHATS\Shared\base_data\CMS_claims\Stata\ip_06_17.dta", clear
merge 1:m bene_id clm_id using `iprev', gen(revm) keep(match master)
gen nonel=!inlist(clm_ip_admsn_type_cd,"3")
gen rh=inlist(ptnt_dschrg_stus_cd,"62","90") | inlist(rev_cntr,"0024")
tempfile ip
save `ip'

forvalues i=2011/2017 {
	use `index' if year(index_date)==`i'
	merge 1:m bene_id using `ip', keep(match master) nogen
	keep if inrange(admit_date,index_date,index_date+365)
	by bene_id, sort: egen ind_adm_nonel=max(nonel)
	by bene_id, sort: egen ind_rehab=max(rh)
	tempfile t
	save `t'
	keep spid index_date wave bene_id ind_*
	duplicates drop
	tempfile t1
	save `t1'
	
	use `t', clear
	rename disch_date ipdisch
	joinby bene_id using "D:\NHATS\Shared\base_data\CMS_claims\Stata\snf_09_17.dta"
	keep if inrange(admit_date,ipdisch-7,ipdisch)
	gen snfrh=1
	keep bene_id snfrh
	duplicates drop
	merge 1:1 bene_id using `t1', keep(match using) nogen
	replace ind_rehab=1 if snfrh==1
	tempfile t`i'
	save `t`i''
}

clear

forvalues i=2011/2017 {
	append using `t`i''
}

tempfile aft
save `aft'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear
merge 1:1 spid wave using `aft', nogen
global output "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

gen homebound_part = 0
replace homebound_part = 1 if inrange(homebound_cat,2,3)
label var homebound_part "Partially Homebound"
label var homebound "Completely Homebound"

gen homebound_not = 0
replace homebound_not = 1 if homebound_cat>=4
label var homebound_not "Indepent"

gen homebound_3cat = .
replace homebound_3cat = 1 if homebound==1
replace homebound_3cat = 2 if homebound_part==1
replace homebound_3cat = 3 if homebound_3cat==.
la define hblbl 1"Complete HB"2"Partial HB"3"Independent"
la values homebound_3cat hblbl

gen anyhcall = 0
replace anyhcall = 1 if housecalls_count>=2 & housecalls_count!=.

svyset spid [pw=anfinwgt], strata(varstrat)

gen all = 1

gen iah_rehab = 0
replace iah_rehab = 1 if ip_rehab==1 |snf==1 |hh==1

drop *jenny
merge 1:1 spid wave using "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", keep(match master) nogen keepusing(*jenny)
replace iah_adl=1 if adlcount_jenny>=2

gen iah_all = 0
replace iah_all = 1 if iah_adl==1 & iah_chronic==1 & iah_nonelect==1 & iah_rehab==1

//look in next year--do they meet?
sort spid wave
foreach x in adl chronic {
	by spid: gen iah_`x'p1=iah_`x'[_n+1]
	replace iah_`x'p1=iah_`x' if !inrange(index_date[_n+1],index_date,index_date+365)
}


by spid: gen iah_all_p12m=(iah_adl==1 | iah_adl[_n+1]==1) & (iah_chronic==1 | iah_chronic[_n+1]==1) & ind_adm_nonel==1 & ind_rehab==1

gen iah_all_full_yr=iah_all==1 | iah_all_p12m==1

local r=1 
local c=1
mat tab=J(6,6,.)

foreach x of varlist iah_nonelect iah_chronic iah_adl iah_rehab iah_all {
	sum `x'
	mat tab[`r',1]=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',2]=r(mean)*100
	mat tab[`r',3]=r(sum)
	egen ind_`x'=max(`x')
	local r=`r'+1
}

preserve
by spid, sort: egen w=max(cond(wave==year-2010,anfinwgt,0))
keep if iah_all==1
sort spid wave
by spid: keep if _n==1
*replace anfinwgt=w
gen iah_all_u=1
label var iah_all_u "IAH (at first wave meet all criteria)"

foreach x of varlist iah_all_u {
	sum `x'
	mat tab[`r',1]=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',2]=r(mean)*100
	mat tab[`r',3]=r(sum)
	egen ind_`x'=max(`x')
	local r=`r'+1
}


mat rownames tab= iah_nonelect iah_chronic iah_adl iah_rehab iah_all iah_all_u

frmttable, statmat(tab) title("IAH") ctitles("" "N (all waves)" "%" "Pop estimate") sdec(0,2,0,0,2,0) varlabels

local r=1
mat tab=J(5,3,.)

levelsof homebound_cat, local(levels)
foreach l of local levels {
	local lab : label homebound_cat `l'
	gen hb`l'=homebound_cat==`l' if !missing(homebound_cat)
	label var hb`l' "`lab'"
	local hb `hb' hb`l'
}

foreach x of varlist `hb' hcalls {
	sum `x'
	mat tab[`r',`c']=r(mean)*r(N)
	sum `x' [aw=anfinwgt]
	mat tab[`r',`c'+1]=r(mean)*100
	mat tab[`r',`c'+2]=r(sum)
	local r=`r'+1
}

mat rownames tab= `hb' hcalls

frmttable, statmat(tab) title("Homebound/HBMC among IAH (at first IAH meeting)") ctitles("" "N" "%" "Pop estimate") sdec(0,2,0,0,2,0) varlabels

restore
svy: mean iah_all* if wave<7

H="***************************"


H="Health Affairs Revision"


H="Model"

use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", clear
sort spid wave
by spid: replace metro_ind=metro_ind[_n-1] if missing(metro_ind)
tempfile t1
save `t1'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 
drop metro_ind
merge 1:1 spid wave using `t1', nogen keep(match master) 

local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)


replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4

gen adl_2plus=adl_index>=2

log using `logpath'\models`date', replace
logit hcalls age female married livealone rcfres adl_2plus prob_dem ind_hosp_adm_12m mc_hh metro_ind i.region if cp_hb==1, or

qui outreg, varlabels stats(e_b e_ci p)

logit hcalls age female married livealone rcfres adl_2plus prob_dem ind_hosp_adm_12m mc_hh metro_ind i.region i.year if cp_hb==1, or
log close
translate `logpath'\models`date'.smcl `logpath'\models`date'.pdf, replace

outreg using `logpath'\models`date'.rtf, varlabels stats(e_b e_ci p) merge replace


H="pull OP use "
use bene_id admit_date pos* clm_id using "D:\NHATS\Shared\base_data\CMS_claims\Stata\pb_09_17.dta", clear

forvalues i=1/13 {
	drop if inlist(pos`i',"21","23")
}
drop pos*
duplicates drop
tempfile pb
save `pb'

use bene_id admit_date disch_date using "D:\NHATS\Shared\base_data\CMS_claims\Stata\ip_06_17.dta", clear
rename admit_date ipadm 
rename disch_date ipdisch
merge m:1 bene_id using  "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", keepusing(index_date) keep(match) nogen
keep if inrange(ipdi,index_date-180, index_date+180) | inrange(ipadm,index_date-180, index_date+180) | (ipadm<index_date-180 & ipd>index_date+180)
tempfile ip
save `ip'

//need rev center to get obs stays & carrier line to get specialties

import sas BENE_ID CLM_ID PRVDR_SPCLTY using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Cumulative\bcarrier_line_j_09_17.sas7bdat", clear case(lower)
gen yes=0
replace yes=1 if inlist(prvdr`i',"01","08","11","38","50")
keep if yes 
keep bene clm
duplicates drop 
tempfile pb2
save `pb2'

use `pb', clear
merge 1:1 bene_id clm_id using `pb2', keep(match) nogen
drop clm_id 
duplicates drop
tempfile pb
save `pb'

import sas BENE_ID CLM_ID REV_CNTR HCPCS_CD REV_CNTR_UNIT_CNT using "D:\NHATS\Shared\raw\CMS\NHATS CMS DUA 28016\Cumulative\outpatient_rev_center_j_09_17.sas7bdat", case(lower) clear
gen obs_stay=inlist(rev_cntr,"0762") | (inlist(rev_cntr,"0760") & inlist(hcpcs_cd,"G0378") & rev_cntr_unit_cnt>=8)
gsort clm_id -obs_stay
by clm_id: keep if _n==1
tempfile obs
save `obs'

use bene_id admit_date disch_date erdayc clm_id using "D:\NHATS\Shared\base_data\CMS_claims\Stata\op_09_17.dta", clear
merge 1:1 bene_id clm_id using `obs', keep(match master) nogen
keep if obs_stay==1
keep bene_id admit_date disch_date
rename admit obsadm
rename disch obsdis
tempfile obs
save `obs'
 
use bene_id admit_date erdayc using "D:\NHATS\Shared\base_data\CMS_claims\Stata\op_09_17.dta", clear
keep if !missing(erday)
drop erday
duplicates drop 
tempfile er
save `er'

use `pb', clear
merge 1:1 bene_id admit_date using `er', keep(master) nogen
joinby bene_id using `ip', unmatched(master)
drop if inrange(admit_date,ipadm,ipdi) & _m==3
drop _m
joinby bene_id using `obs', unmatched(master)
drop if inrange(admit_date,obsadm,obsdi) & _m==3
keep bene_id admit_date
duplicates drop
tempfile pb 
save `pb'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 
keep spid bene_id index_date
merge 1:m bene_id using `pb', keep(match master) nogen
replace admit_date=0 if missing(admit_date)
//3 time periods--the 90 days+/-, and the 90 days before and after that

local t1 index_date-180, index_date-91
local t2 index_date-90,index_date+90
local t3 index_date+91,index_date+180
tokenize n180n91 n90p90 p91p180
sort spid
forvalues i=1/3 {
	gen inr`i'=inrange(admit_date,`t`i'')
	by spid: egen n_pb_vis_``i''=total(inr`i')
	gen ind_pb_vis_``i''=n_pb_vis_``i''>=1
	gen ind_2_``i''=n_pb_vis_``i''>=2

}


drop admit_date inr* 
duplicates drop
tempfile pb
save `pb'

use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", clear
sort spid wave
by spid: replace metro_ind=metro_ind[_n-1] if missing(metro_ind)
tempfile t1
save `t1'

use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 
drop metro_ind
merge 1:1 spid wave using `t1', nogen keep(match master) 
merge 1:1 spid using `pb', nogen keep(match master)
*replace ind_2_n9=2 if n_pb_vis_n9==1 & hcalls==1
	
local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)


replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4

gen adl_2plus=adl_index>=2
*replace ind_2_n9=1 if hcalls==1
mat tab=J(9,9,.)
mat stars=J(9,9,0)
local r=2
local c=1

forvalues k=1/3 {
	forvalues i=0/1 {
		forvalues j=0/1 {
			sum n_pb_vis_``k'' if cp_hb==`i' & hcalls==`j'
			mat tab[`r',`=`j'+1']=r(mean)
			sum ind_2_``k'' if cp_hb==`i' & hcalls==`j'
			mat tab[`r',`=`j'+4']=r(mean)*100
			if `j'==1 {
				ranksum n_pb_vis_``k'' if cp_hb==`i', by(hcalls)
				mat tab[`r',3]=r(p)
				mat stars[`r',3]=(r(p)<.05) + (r(p)<.01)
				tab ind_2_``k'' hcalls if cp_hb==`i', chi2
				mat tab[`r',6]=r(p)
				mat stars[`r',6]=(r(p)<.05) + (r(p)<.01)
}
}
		local r=`r'+1
}
	local r=`r'+1
}


gen viscat=n_pb_vis_n9==0
replace viscat=2 if n_pb_vis_n9==1
replace viscat=3 if n_pb_vis_n9>=2

label define viscat 1 "No visits" 2 "1 visit" 3 "2+ visits"
label values viscat viscat

local title "Visits max 1 per day, from Carrier File with specialty code: 01,08,11,38,50.  Excludes claims with ER/IP/Obs visit on same day or ER/IP hospital indicated on Place of Service code" 
di "`title'"
log using $output\multiple_visits_hb, replace
di "`title'"

tab hcalls viscat if cp_hb==1, row chi2 nokey


frmttable using $output\multiple_visits_hb_table.rtf, statmat(tab) ctitles("" "" "Count(mean)" "" "" "2 or more(%)"\ "" "No HBMC" "HBMC" "P-value" "No HBMC" "HBMC" "P-value") rtitles("Visits 180-91 days pre-ivw"\"Non-homebound"\ "Completely/Partially HB"\	"Visits 90 days +/- ivw"\"Non-homebound"\ "Completely/Partially HB"\	"Visits 91-180 days post-ivw"\"Non-homebound"\ "Completely/Partially HB") annotate(stars) asymbol(*,**) note("Visits max 1 per day, from Carrier File with specialty code: 01,08,11,38,50" "Excludes claims with ER/IP/Obs visit on same day or ER/IP hospital indicated on Place of Service code" "P-values for count of visits from Mann-Whitney, binary from Chi2") title("Non-Inpatient, Non-ER, Non-Observation Visits") replace

log close 
translate $output\multiple_visits_hb.smcl $output\multiple_visits_hb.pdf, replace

H="Weighted years tables and graph"
use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\iah_wave1-7.dta", clear

global output "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)

gen homebound_part = 0
replace homebound_part = 1 if inrange(homebound_cat,2,3)
label var homebound_part "Partially Homebound"
label var homebound "Completely Homebound"

gen homebound_not = 0
replace homebound_not = 1 if homebound_cat>=4
label var homebound_not "Indepent"

gen homebound_3cat = .
replace homebound_3cat = 1 if homebound==1
replace homebound_3cat = 2 if homebound_part==1
replace homebound_3cat = 3 if homebound_3cat==.
la define hblbl 1"Complete HB"2"Partial HB"3"Independent"
la values homebound_3cat hblbl

gen anyhcall = 0
replace anyhcall = 1 if housecalls_count>=2 & housecalls_count!=.

svyset spid [pw=anfinwgt], strata(varstrat)

gen all = 1

mat tab1=J(7,6,.)

local r = 1
local c = 1

forvalues i=1/7 {

svy: mean hcalls if wave==`i'
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: mean anyhcall if wave==`i'
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: total all if wave==`i'
mat tab1[`r',`c'] = (e(N_pop))

local ++c
svy: mean hcalls if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: mean anyhcall if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (r(table)[1,1]*100)

local ++c
svy: total all if wave==`i' & homebound_3cat<3
mat tab1[`r',`c'] = (e(N_pop))

local c = 1
local ++r
}

mat rownames tab1 = "2011" "2012" "2013" "2014" "2015" "2016" "2017"
mat list tab1

frmttable using $output\table2_pop_estimates`date'.doc, replace statmat(tab1) ///
varlabels title("Table 1: Weighted Population Estimates NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "All", "", "", "Complete/Partial HB" \ "Years", "Weighted % - 2+ Hcalls (or 1+NH/Death)", "Weighted % - 2+ Hcall in calendar year", "Total CD+FFS Population Estimates", "Weighted % - 2+ Hcalls (or 1+NH/Death)", "Weighted % - 2+ Hcall in calendar year", "Total CD+FFS+HB Population Estimates") sdec(2) ///
note("Population Estimates is the total (weighted) number of 6mFFS + CD people in the NHATS year")

////////

mat tab2=J(7,8,.)

local r = 1
local c = 1

forvalues i=1/7 {

svy: mean anyhcall if wave==`i'
mat tab2[`r',`c'] = (r(table)[1,1]*100)

local ++c
mat tab2[`r',`c'] = (r(table)[1,1]*e(N_pop)) // population estimate

local ++c
mat tab2[`r',`c'] = (r(table)[5,1]*e(N_pop)) // lower bound

local ++c
mat tab2[`r',`c'] = (r(table)[6,1]*e(N_pop)) // upper bound

local ++c
svy: mean anyhcall if wave==`i' & homebound_3cat<3
mat tab2[`r',`c'] = (r(table)[1,1]*100)

local ++c
mat tab2[`r',`c'] = (r(table)[1,1]*e(N_pop)) // population estimate

local ++c
mat tab2[`r',`c'] = (r(table)[5,1]*e(N_pop)) // lower bound

local ++c
mat tab2[`r',`c'] = (r(table)[6,1]*e(N_pop)) // upper bound

local c = 1
local ++r
}

mat rownames tab2 = "2011" "2012" "2013" "2014" "2015" "2016" "2017"
mat list tab2

frmttable using $output\table2_pop_estimates`date'.doc, addtable statmat(tab2) ///
varlabels title("Table 2: Weighted Population Estimates NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "All", "", "", "Complete/Partial HB" \ "Years", "Weighted % - 2+ Hcalls in calendar year", "2+ Hcalls Population Estimate", "95% Lower Bound", "95% Upper Bound", "Weighted % - 2+ Hcalls in calendar year", "2+ Hcalls + HB Population Estimate", "95% Lower Bound", "95% Upper Bound") sdec(2) ///
note("Population Estimates is the total (weighted) number of 6mFFS + CD people in the NHATS year")

log using $output\annual_hbmc_hb_log, replace
svy, subpop(if homebound_cat<4): logit hcalls year
margins, dydx(year)
svy, subpop(if homebound_cat<4): logit hcalls ib2016.year
margins year
marginsplot, recastci(rarea) ciopts(color(blue%50)) recast(line) saving($output\annual_hbmc_homebound, replace)
graph export $output\annual_hbmc_homebound.pdf, replace
log close

log using $output\annual_hbmc_hb_log, replace
svy, subpop(if homebound_cat<4): reg hcalls year
svy, subpop(if homebound_cat<4): reg hcalls ib2016.year



log close

translate $output\annual_hbmc_hb_log.smcl $output\annual_hbmc_hb_log.pdf, replace


H="table 2"

use "D:\NHATS\Shared\base_data\NHATS cleaned\sp_round_1_8.dta", clear
sort spid wave
by spid: replace metro_ind=metro_ind[_n-1] if missing(metro_ind)
tempfile t1
save `t1'


use "D:\NHATS\Projects\homebound\ko_hbmc_iah\data\final_data\housecalls.dta", clear 

drop metro_ind
merge 1:1 spid wave using `t1', nogen keep(match master) 


local logpath "D:\NHATS\Projects\homebound\ko_hbmc_iah\output\in_progress"
local date=subinstr("$S_DATE"," ","_",.)


replace homebound_cat = 4 if homebound_cat==.
label var homebound "Never/Rarely leaves home"

gen homebound_2 = 0 if homebound_cat!=.
replace homebound_2 = 1 if homebound_cat==2
label var homebound_2 "Leaves home but never by self"

gen homebound_3 = 0 if homebound_cat!=.
replace homebound_3 = 1 if homebound_cat==3
label var homebound_3 "Leaves home but needs help/has difficulty"

gen homebound_4 = 0 if homebound_cat!=.
replace homebound_4 = 1 if homebound_cat==4
label var homebound_4 "Not homebound"

gen cp_hb = 0
replace cp_hb = 1 if homebound_cat<4


gen adl_2plus=adl_index>=2 if !missing(adl_index)

local cvars1 age
local ivars1 income_cat_1 female white 
local catvars1 
local ivars2 married livealone rcfres educ_hs_ind medicaid metro_ind 
local catvars2 region
local ivars3  iah_adl adl_ins_diff iah_chronic prob_dem ind_hosp_adm_12m mc_hh

//replace race=3 if race==4
//label define race_cat 3 "Hispanic or other", modify

forvalues i=1/6 {
	foreach x of local catvars`i' {
		di "`x'"
		local `x'
		local catrows`i' `catrows`i'' `x'
		levelsof `x', local(levels)
		foreach l of local levels {
			gen `x'`l'=`x'==`l' if !missing(`x')
			local lab : label `x' `l'
			label var `x'`l' "`lab'"
			local `x' ``x'' `x'`l'
}
		di "``x''"
		local cativars`i' `cativars`i'' ``x''
		local catrows`i' `catrows`i'' ``x''
}
}

di "`catvars1'"
di "`cativars1'"

forvalues i=1/6 {
	local countvars `countvars' `cvars`i''  `ivars`i'' `catrows`i''
}

local rn : word count `countvars' 1
di `rn'


mat tab1 = J(`rn',6,.)
mat stars = J(`rn',6,0)

local r = 1
local c = 1

foreach z in 1 0 {
	foreach y in 1 0 {
		forvalues i=1/6 {
			foreach x of local cvars`i' {
				sum `x' if cp_hb==`z' & hcalls==`y'
				if !inrange(r(N)-r(sum),1,10) & !inrange(r(sum),1,10) mat tab1[`r',`c']=r(mean)
				if `y'==0 {
					ttest `x' if cp_hb==`z', by(hcalls)
					mat tab1[`r',`c'+1]=r(p)
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
				local r=`r'+1
}
			foreach x of local ivars`i' {
				sum `x' if cp_hb==`z' & hcalls==`y'
				if !inrange(r(N)-r(sum),1,10) & !inrange(r(sum),1,10) mat tab1[`r',`c']=r(mean)*100
				if `y'==0 {
					tab `x' hcalls if cp_hb==`z', chi2
					mat tab1[`r',`c'+1]=r(p)
					mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
				local r=`r'+1
}
		foreach x of local catvars`i' {
			if `y'==0 {
				tab `x' hcalls if cp_hb==`z', chi2
				mat tab1[`r',`c'+1]=r(p)
				mat stars[`r',`c'+1]=(r(p)<.05)+(r(p)<.01)
}
			local r=`r'+1
			foreach q of local `x' {
				sum `q' if cp_hb==`z' & hcalls==`y'
				if !inrange(r(N)-r(sum),1,10) & !inrange(r(sum),1,10) mat tab1[`r',`c']=r(mean)*100

				local r=`r'+1
}
}


}
		sum hcalls if cp_hb==`z' & hcalls==`y'
		mat tab1[`r',`c']=r(N)
		local r=1
		local c=`c'+1
		if `y'==0 local c=`c'+1
}
}



mat rownames tab1= `countvars' N

frmttable using ${output}\table_2.rtf, replace statmat(tab1) ///
varlabels title("Table 1: Housecalls Unique persons per NHATS Waves 1-7 Community Dwelling + 6m FFS") ///
ctitles("", "", "Complete/Partial HB", "", "", "Not HB", \"", "No Housecalls", "Housecalls", "No Housecalls", "Housecalls") sdec(2) annotate(stars) asymbol(*,**) landscape ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. Housecalls are +/- 90 days of ivw date. *p<0.05, **p<0.01")


H="Changelog"
1/27/2020 - Amended the "Pull OP use" to include obs stays. EBL

12/3/2019 - Added "things for Bruce" and "looking 12m after" headers. EBL

9/18/2019 - Updated 2 column table. OKR

9/17/2019 - Cleaned up code to improve readability. OKR

9/06/2019 - Added x-tabs for Table 1. OKR

8/21/2019 - Changed housecalls 4 col UW table to correct significance tests for ivars. OKR.

8/1/2019 - Changed data construction to cap waves of nonhousecalls to wave 6, created 4 column table, and rebuilt the data from base on the new server. OKR.

5/14/19 - Changed housecalls definition to 2+ CPT codes or CPT code + NH/Death in +/- 90 days. Omari.

02/13/2019 - Added Medicare Home Health claims flag and created censored version of housecalls table. Omari. 

02/06/2019 - Ammended "Table 1 and res care by homebound status" to include a four-column table (y/n housecall and y/n homebound) and make shareable. Evan

02/05/2019 - Added "Table 1 and res care by homebound status" tab. Evan


01/29/2019 - Calculated person years. Omari


01/02/2019 - Updated the code to include cell size censored tables. Omari